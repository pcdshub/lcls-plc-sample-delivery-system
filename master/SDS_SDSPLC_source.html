

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DUTs &mdash; pcdshub/lcls-plc-sample-delivery-system  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/tree.css?v=837a00b9" />
      <link rel="stylesheet" type="text/css" href="_static/width.css?v=ab210c7a" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=5929fcd5"></script>
      <script src="_static/doctools.js?v=9a2dae69"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="_static/docs-versions-menu.js?v=3d6a1aea"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Data Types" href="SDS_SDSPLC_epics.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            pcdshub/lcls-plc-sample-delivery-system
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">SDS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="SDS_pragmas.html">Pragmas</a></li>
<li class="toctree-l1"><a class="reference internal" href="SDS_nc.html">NC Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="SDS_ethercat.html">EtherCAT Terminals</a></li>
<li class="toctree-l1"><a class="reference internal" href="SDS_boxes.html">Boxes</a></li>
<li class="toctree-l1"><a class="reference internal" href="SDS_links.html">Links</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">SDSPLC</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="SDS_SDSPLC_summary.html">Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="SDS_SDSPLC_summary.html#pragmas">Pragmas</a></li>
<li class="toctree-l1"><a class="reference internal" href="SDS_SDSPLC_summary.html#libraries">Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="SDS_SDSPLC_summary.html#symbols">Symbols</a></li>
<li class="toctree-l1"><a class="reference internal" href="SDS_SDSPLC_epics.html">Data Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="SDS_SDSPLC_epics.html#database-records">Database Records</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">DUTs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#e-axismotionstate">E_AxisMotionState</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-axismovemode">E_AxisMoveMode</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-bhelflowunit">E_BHElFlowUnit</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-ctrl-mode">E_CTRL_MODE</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-propvalvefbstate">E_PropValveFBState</a></li>
<li class="toctree-l2"><a class="reference internal" href="#hmi-propvalvectrlstate">HMI_PropValveCtrlState</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-ali">ST_ALI</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-aliio">ST_ALIIO</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-bhelflow">ST_BhElFlow</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-m3devicebaseio">ST_M3DeviceBaseIO</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-manifoldvalve">ST_ManifoldValve</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-manipaxis">ST_ManipAxis</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-pidparams">ST_PIDParams</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-pressurecontroller">ST_PressureController</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-proportionair">ST_Proportionair</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-propvalvemks253">ST_PropValveMKS253</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-regdeadbandcontrols">ST_RegDeadbandControls</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-regulator">ST_Regulator</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-selectorm3">ST_SelectorM3</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-sensirionfm">ST_SensirionFM</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-sensirionfmcontrol">ST_SensirionFMControl</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-sensirionfmstatus">ST_SensirionFMStatus</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-serialcomm">ST_SerialComm</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-shaker">ST_Shaker</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-shakercontrols">ST_ShakerControls</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-strings">ST_Strings</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-teccontrol">ST_TECControl</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-tecstatus">ST_TECStatus</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-vicicontrol">ST_ViciControl</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-vicistatus">ST_ViciStatus</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#gvls">GVLs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#gvl">GVL</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gvl-autosave">GVL_Autosave</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gvl-combuffers">GVL_ComBuffers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gvl-devices">GVL_Devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gvl-io">GVL_IO</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gvl-misc">GVL_misc</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#pous">POUs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#f-axisref-to-msta">F_AxisRef_To_MSTA</a></li>
<li class="toctree-l2"><a class="reference internal" href="#f-rpressure">F_rPressure</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-ali">FB_ALI</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-bronkhorstmfm">FB_BronkhorstMFM</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-ecatdiag">FB_EcatDiag</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-gasmanifold">FB_GasManifold</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-manipaxis">FB_ManipAxis</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-manivalve">FB_ManiValve</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-pid-ext">FB_PID_EXT</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-pressurecontrolmodule">FB_PressureControlModule</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-proportionairregulator">FB_ProportionairRegulator</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-propvalve">FB_PropValve</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-regulator">FB_Regulator</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-selectorm3">FB_SelectorM3</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-selectorsync">FB_SelectorSync</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-sensiriondriver">FB_SensirionDriver</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-sensiriontransaction">FB_SensirionTransaction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-serialcommwrapper">FB_SerialCommWrapper</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-shiftbytearray">FB_ShiftByteArray</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-solenoidpair">FB_SolenoidPair</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-tecdriver">FB_TECDriver</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-tectransaction">FB_TECTransaction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-vicidriver">FB_ViciDriver</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-vicitransaction">FB_ViciTransaction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fshdlcchecksum">fSHDLCChecksum</a></li>
<li class="toctree-l2"><a class="reference internal" href="#main">MAIN</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mc-smoothmover">MC_SmoothMover</a></li>
<li class="toctree-l2"><a class="reference internal" href="#p-ali">p_ALI</a></li>
<li class="toctree-l2"><a class="reference internal" href="#p-autosave">p_Autosave</a></li>
<li class="toctree-l2"><a class="reference internal" href="#p-autowash">p_AutoWash</a></li>
<li class="toctree-l2"><a class="reference internal" href="#p-coolershaker">p_CoolerShaker</a></li>
<li class="toctree-l2"><a class="reference internal" href="#p-estop">p_ESTOP</a></li>
<li class="toctree-l2"><a class="reference internal" href="#p-manifold">p_Manifold</a></li>
<li class="toctree-l2"><a class="reference internal" href="#p-regulators">p_Regulators</a></li>
<li class="toctree-l2"><a class="reference internal" href="#p-shakers">p_Shakers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#p-softio">p_SoftIO</a></li>
<li class="toctree-l2"><a class="reference internal" href="#p-statuslights">p_StatusLights</a></li>
<li class="toctree-l2"><a class="reference internal" href="#p-vacgaugesup">p_VacGaugeSup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#serialtxrx">SerialTxRx</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">pcdshub/lcls-plc-sample-delivery-system</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">DUTs</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/SDS_SDSPLC_source.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="duts">
<h1>DUTs<a class="headerlink" href="#duts" title="Link to this heading"></a></h1>
<section id="e-axismotionstate">
<h2>E_AxisMotionState<a class="headerlink" href="#e-axismotionstate" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">E_AxisMotionState</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">Init</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">MoveEnabled</span> <span class="o">:=</span> <span class="mi">3000</span><span class="p">,</span>
    <span class="n">Error</span> <span class="o">:=</span> <span class="mi">9000</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-axismotionstate">E_AxisMotionState</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="e-axismovemode">
<h2>E_AxisMoveMode<a class="headerlink" href="#e-axismovemode" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">E_AxisMoveMode</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">Hold</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">MoveAbs</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">MoveRel</span> <span class="o">:=</span> <span class="mi">2</span>
<span class="p">)</span> <span class="n">WORD</span><span class="p">;</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-bhelflowunit">
<h2>E_BHElFlowUnit<a class="headerlink" href="#e-bhelflowunit" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">E_BHElFlowUnit</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">enum_member</span> <span class="o">:=</span> <span class="mi">0</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-ctrl-mode">
<h2>E_CTRL_MODE<a class="headerlink" href="#e-ctrl-mode" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_CTRL_MODE</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">Init</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">Run</span>     <span class="o">:=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">Hold</span>    <span class="o">:=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">Error</span>   <span class="o">:=</span> <span class="mi">9000</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-propvalvefbstate">
<h2>E_PropValveFBState<a class="headerlink" href="#e-propvalvefbstate" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;strict&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_PropValveFBState</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">Init</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">Hold</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">Manual</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">Pressure</span> <span class="o">:=</span> <span class="mi">200</span><span class="p">,</span>
    <span class="n">Error</span> <span class="o">:=</span> <span class="mi">9000</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="hmi-propvalvectrlstate">
<h2>HMI_PropValveCtrlState<a class="headerlink" href="#hmi-propvalvectrlstate" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Maps</span> <span class="n">to</span> <span class="n">an</span> <span class="n">EPICS</span> <span class="n">MBBI</span><span class="o">/</span><span class="n">O</span> <span class="o">*</span><span class="p">)</span>
<span class="n">TYPE</span> <span class="n">HMI_PropValveCtrlState</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">Manual</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">Pressure</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">Hold</span> <span class="o">:=</span> <span class="mi">2</span>
<span class="p">)</span> <span class="n">WORD</span><span class="p">;</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-ali">
<h2>ST_ALI<a class="headerlink" href="#st-ali" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_ALI</span> <span class="n">EXTENDS</span> <span class="n">ST_ALIIO</span><span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">Aerodynamic</span> <span class="n">Lens</span> <span class="n">Injector</span> <span class="o">*</span><span class="p">)</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">Manipulator</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">axisX</span>   <span class="p">:</span>       <span class="n">ST_ManipAxis</span><span class="p">;</span>
    <span class="n">axisY</span>   <span class="p">:</span>       <span class="n">ST_ManipAxis</span><span class="p">;</span>
    <span class="n">axisZ</span>   <span class="p">:</span>       <span class="n">ST_ManipAxis</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">Vacuum</span> <span class="n">gauges</span> <span class="o">*</span><span class="p">)</span>
    <span class="o">//</span><span class="mi">925</span>
    <span class="n">stNozzleBoxVG</span>   <span class="p">:</span> <span class="n">ST_VG</span><span class="p">;</span>
    <span class="o">//</span><span class="mi">925</span>
    <span class="n">stSkimmerVG</span>     <span class="p">:</span> <span class="n">ST_VG</span><span class="p">;</span>
    <span class="o">//</span><span class="mi">722</span>
    <span class="n">stRelaxVG</span>       <span class="p">:</span> <span class="n">ST_VG</span> <span class="o">:=</span> <span class="p">(</span><span class="n">rFULL_SCALE</span><span class="o">:=</span><span class="mi">10</span><span class="p">);</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">Butterfly</span> <span class="n">valve</span> <span class="n">pressure</span> <span class="n">controller</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">stPropVlv</span>       <span class="p">:</span>       <span class="n">ST_PropValveMKS253</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">PropValve</span> <span class="n">Pressure</span> <span class="n">Controller</span> <span class="o">*</span><span class="p">)</span>
    <span class="o">//</span><span class="n">stPressCtrl</span>   <span class="p">:</span>       <span class="n">ST_PressureController</span><span class="p">;</span>


<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-aliio">ST_ALIIO</a></p></li>
<li><p><a class="reference internal" href="#st-manipaxis">ST_ManipAxis</a></p></li>
<li><p><a class="reference internal" href="#st-pressurecontroller">ST_PressureController</a></p></li>
<li><p><a class="reference internal" href="#st-propvalvemks253">ST_PropValveMKS253</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-aliio">
<h2>ST_ALIIO<a class="headerlink" href="#st-aliio" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_ALIIO</span> <span class="n">EXTENDS</span> <span class="n">ST_M3DeviceBaseIO</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="o">//</span><span class="n">EP7041</span>
    <span class="o">//</span><span class="n">EP7041</span>
    <span class="o">//</span><span class="n">EP7041</span>
    <span class="o">//</span><span class="n">EP5101</span>

    <span class="o">//</span><span class="n">EP3174</span> <span class="n">Vacuum</span> <span class="n">Gauges</span><span class="p">,</span> <span class="n">misc</span> <span class="n">analog</span>
    <span class="n">i_EP3174_Ch1</span>    <span class="n">AT</span>      <span class="o">%</span><span class="n">I</span><span class="o">*</span>     <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>
    <span class="n">i_EP3174_Ch2</span>    <span class="n">AT</span>      <span class="o">%</span><span class="n">I</span><span class="o">*</span>     <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>
    <span class="n">i_EP3174_Ch3</span>    <span class="n">AT</span>      <span class="o">%</span><span class="n">I</span><span class="o">*</span>     <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>
    <span class="n">i_EP3174_Ch4</span>    <span class="n">AT</span>      <span class="o">%</span><span class="n">I</span><span class="o">*</span>     <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">EP7041</span> <span class="o">-</span> <span class="n">Prop</span> <span class="n">valve</span>

    <span class="o">//</span><span class="n">EP2338</span> <span class="n">Misc</span> <span class="n">DIO</span>
    <span class="n">q_EP2338_Ch1</span>    <span class="n">AT</span>      <span class="o">%</span><span class="n">Q</span><span class="o">*</span>     <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_EP2338_Ch2</span>    <span class="n">AT</span>      <span class="o">%</span><span class="n">Q</span><span class="o">*</span>     <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_EP2338_Ch3</span>    <span class="n">AT</span>      <span class="o">%</span><span class="n">Q</span><span class="o">*</span>     <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_EP2338_Ch4</span>    <span class="n">AT</span>      <span class="o">%</span><span class="n">Q</span><span class="o">*</span>     <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">i_EP2338_Ch5</span>    <span class="n">AT</span>      <span class="o">%</span><span class="n">I</span><span class="o">*</span>     <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">i_EP2338_Ch6</span>    <span class="n">AT</span>      <span class="o">%</span><span class="n">I</span><span class="o">*</span>     <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">i_EP2338_Ch7</span>    <span class="n">AT</span>      <span class="o">%</span><span class="n">I</span><span class="o">*</span>     <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">i_EP2338_Ch8</span>    <span class="n">AT</span>      <span class="o">%</span><span class="n">I</span><span class="o">*</span>     <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span><span class="n">EP4374</span> <span class="n">Pressure</span> <span class="n">Control</span>
    <span class="n">i_EP4374_Ch1</span>    <span class="n">AT</span>      <span class="o">%</span><span class="n">I</span><span class="o">*</span>     <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>
    <span class="n">i_EP4374_Ch2</span>    <span class="n">AT</span>      <span class="o">%</span><span class="n">I</span><span class="o">*</span>     <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>
    <span class="n">q_EP4374_Ch3</span>    <span class="n">AT</span>      <span class="o">%</span><span class="n">Q</span><span class="o">*</span>     <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>
    <span class="n">q_EP4374_Ch4</span>    <span class="n">AT</span>      <span class="o">%</span><span class="n">Q</span><span class="o">*</span>     <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>

<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-m3devicebaseio">ST_M3DeviceBaseIO</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-bhelflow">
<h2>ST_BhElFlow<a class="headerlink" href="#st-bhelflow" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_BhElFlow</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="n">eFlowUnit</span>       <span class="p">:</span>       <span class="n">E_BHElFlowUnit</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Unit</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
    <span class="n">i_sUnit</span>                 <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span>  <span class="p">:</span>       <span class="n">STRING</span><span class="p">;</span>

    <span class="n">i_udiUnit</span>       <span class="p">:</span>       <span class="n">UDINT</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Flow</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
    <span class="n">i_rFlow</span>                 <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span>  <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Setpoint</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">o</span>
     <span class="s1">&#39;}</span>
    <span class="n">q_rSetpoint</span>     <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span>  <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span>

<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-bhelflowunit">E_BHElFlowUnit</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-m3devicebaseio">
<h2>ST_M3DeviceBaseIO<a class="headerlink" href="#st-m3devicebaseio" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_M3DeviceBaseIO</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">structure</span> <span class="n">should</span> <span class="n">be</span> <span class="n">used</span> <span class="k">as</span> <span class="n">a</span> <span class="n">basis</span> <span class="k">for</span> <span class="n">M3</span> <span class="n">arch</span><span class="o">.</span> <span class="n">IO</span> <span class="n">clusters</span><span class="o">.</span>
    <span class="n">Will</span> <span class="n">stash</span> <span class="n">stuff</span> <span class="n">like</span> <span class="n">ethercat</span> <span class="n">diagnostics</span> <span class="ow">and</span> <span class="n">other</span> <span class="n">general</span> <span class="n">purpose</span> <span class="n">stuff</span> <span class="o">*</span><span class="p">)</span>

    <span class="o">//</span><span class="n">WC</span> <span class="n">bit</span> <span class="n">tells</span> <span class="n">you</span> <span class="k">if</span> <span class="n">the</span> <span class="n">sync</span> <span class="n">unit</span> <span class="ow">is</span> <span class="n">OK</span><span class="p">,</span> <span class="n">which</span> <span class="n">tells</span> <span class="n">you</span> <span class="k">if</span> <span class="n">cluster</span> <span class="ow">is</span> <span class="n">alive</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">SyncUnitOK</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
    <span class="n">i_SyncUnitWC</span>    <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span>  <span class="p">:</span>       <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-manifoldvalve">
<h2>ST_ManifoldValve<a class="headerlink" href="#st-manifoldvalve" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_ManifoldValve</span> <span class="p">:</span>
<span class="n">STRUCT</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">Controls</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Open</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">o</span>
     <span class="s1">&#39;}</span>
    <span class="n">xSW</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">epics</span> <span class="n">control</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">CloseDO</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
    <span class="n">qxDO</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">actual</span> <span class="n">valve</span> <span class="n">output</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">Readbacks</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">OpenSW</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
    <span class="n">ixOPN</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">Soft</span> <span class="n">variables</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Ilk</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
    <span class="n">xILK</span> <span class="p">:</span>  <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">permissive</span> <span class="n">bit</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Name</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">sName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>

<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-manipaxis">
<h2>ST_ManipAxis<a class="headerlink" href="#st-manipaxis" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_ManipAxis</span> <span class="p">:</span>
<span class="n">STRUCT</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Controls</span> <span class="o">*</span><span class="p">)</span>
<span class="n">xEnable</span>     <span class="p">:</span>       <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">rReqAbsPos</span>  <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span>
<span class="n">rReqRelPos</span>  <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span>
<span class="n">xStart</span>      <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">xStop</span>       <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">wMode</span>       <span class="p">:</span>       <span class="n">E_AxisMoveMode</span><span class="p">;</span>
<span class="o">//</span><span class="n">EPICS</span> <span class="n">motor</span> <span class="n">status</span>
<span class="n">uiMsta</span>      <span class="p">:</span>       <span class="n">UINT</span><span class="p">;</span>
<span class="o">//</span><span class="n">EPICS</span> <span class="n">Position</span> <span class="n">readback</span>
<span class="n">rActPos</span>     <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span>
<span class="o">//</span><span class="n">Axis</span> <span class="n">enabled</span> <span class="n">readback</span>
<span class="n">xEnabled</span>    <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="o">//</span><span class="n">EPICS</span> <span class="n">High</span> <span class="n">Limit</span> <span class="n">Switch</span> <span class="p">(</span><span class="n">NO</span><span class="p">)</span>
<span class="n">xHLS</span>        <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="o">//</span><span class="n">EPICS</span> <span class="n">Low</span> <span class="n">Limit</span> <span class="n">Switch</span> <span class="p">(</span><span class="n">NO</span><span class="p">)</span>
<span class="n">xLLS</span>        <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="o">//</span><span class="n">EPICS</span> <span class="n">MOVN</span>
<span class="n">xMovn</span>       <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="o">//</span><span class="n">EPICS</span> <span class="n">DMOV</span>
<span class="n">xDmov</span>       <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="o">//</span><span class="n">EPICS</span> <span class="n">Reset</span>
<span class="n">xReset</span>      <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Axis</span> <span class="n">motor</span> <span class="o">*</span><span class="p">)</span>
<span class="n">stAxis</span>      <span class="p">:</span>       <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">lrVelocity</span>  <span class="p">:</span>       <span class="n">LREAL</span>   <span class="o">:=</span><span class="mi">1</span><span class="p">;</span> <span class="o">//</span><span class="n">mm</span><span class="o">/</span><span class="n">s</span>

<span class="n">eState</span>      <span class="p">:</span>       <span class="n">E_AxisMotionState</span><span class="p">;</span>

<span class="n">xHiLS</span>       <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span>        <span class="n">BOOL</span><span class="p">;</span>
<span class="n">xLoLS</span>       <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span>        <span class="n">BOOL</span><span class="p">;</span>

<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-axismotionstate">E_AxisMotionState</a></p></li>
<li><p><a class="reference internal" href="#e-axismovemode">E_AxisMoveMode</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-pidparams">
<h2>ST_PIDParams<a class="headerlink" href="#st-pidparams" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_PIDParams</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="n">fCtrlCycleTime</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">controller</span> <span class="n">cycle</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">seconds</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">fKp</span>            <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">proportional</span> <span class="n">gain</span> <span class="n">Kp</span> <span class="p">(</span><span class="n">P</span><span class="p">)</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">fTn</span>            <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">integral</span> <span class="n">gain</span> <span class="n">Tn</span> <span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">fTv</span>            <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">derivative</span> <span class="n">gain</span> <span class="n">Tv</span> <span class="p">(</span><span class="n">D</span><span class="o">-</span><span class="n">T1</span><span class="p">)</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">fTd</span>            <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">derivative</span> <span class="n">damping</span> <span class="n">time</span> <span class="n">Td</span> <span class="p">(</span><span class="n">D</span><span class="o">-</span><span class="n">T1</span><span class="p">)</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">fUpperLim</span>               <span class="p">:</span>       <span class="n">LREAL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">upper</span> <span class="n">controller</span> <span class="n">output</span> <span class="nb">range</span> <span class="n">limit</span> <span class="n">of</span> <span class="n">PID</span> <span class="n">block</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">fLowerLim</span>               <span class="p">:</span>       <span class="n">LREAL</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">lower</span> <span class="n">controller</span> <span class="n">output</span> <span class="nb">range</span> <span class="n">limit</span> <span class="n">of</span> <span class="n">PID</span> <span class="n">block</span> <span class="o">*</span><span class="p">)</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-pressurecontroller">
<h2>ST_PressureController<a class="headerlink" href="#st-pressurecontroller" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_PressureController</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">Intent</span> <span class="n">of</span> <span class="n">this</span> <span class="n">structure</span> <span class="ow">is</span> <span class="n">to</span> <span class="n">provide</span> <span class="n">generic</span> <span class="n">variables</span>
    <span class="k">for</span> <span class="n">a</span> <span class="n">pressure</span> <span class="n">controller</span><span class="o">.</span> <span class="n">It</span> <span class="ow">is</span> <span class="n">meant</span> <span class="n">to</span> <span class="n">be</span> <span class="n">extended</span> <span class="n">by</span>
    <span class="n">the</span> <span class="n">hardware</span> <span class="n">IO</span> <span class="n">variables</span> <span class="n">into</span> <span class="n">a</span> <span class="n">specific</span> <span class="n">structure</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>

    <span class="o">//</span><span class="n">Controls</span>
    <span class="o">//</span><span class="n">Pressure</span> <span class="n">setpoint</span>
    <span class="n">i_rPressSP</span>      <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span>
    <span class="o">//</span><span class="n">Pressure</span> <span class="n">readback</span>
    <span class="n">i_rPressRB</span>      <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span>
    <span class="o">//</span><span class="n">Controller</span> <span class="n">deadband</span>
    <span class="n">rDeadband</span>       <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span>
    <span class="o">//</span><span class="n">Actuator</span> <span class="n">percentage</span> <span class="nb">open</span> <span class="n">setpoint</span> <span class="mi">0</span><span class="o">-</span><span class="mi">100</span><span class="o">%</span>
    <span class="n">i_iPercOpenSP</span>   <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>
    <span class="o">//</span><span class="n">Acuator</span> <span class="n">percentage</span> <span class="nb">open</span> <span class="n">readback</span>
    <span class="n">q_iPercOpen</span>     <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>
    <span class="o">//</span><span class="n">Controller</span> <span class="n">Mode</span>
    <span class="n">i_eCntlMode</span>     <span class="p">:</span>       <span class="n">E_CTRL_MODE</span><span class="p">;</span>
    <span class="o">//</span><span class="n">PID</span> <span class="n">Parameters</span>
    <span class="n">stPIDParams</span> <span class="p">:</span>   <span class="n">ST_PIDParams</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">fKp</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">fTn</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">fUpperLim</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">fLowerLim</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">fCtrlCycleTime</span> <span class="o">:=</span> <span class="mf">0.01</span>
    <span class="p">);</span>

<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-ctrl-mode">E_CTRL_MODE</a></p></li>
<li><p><a class="reference internal" href="#st-pidparams">ST_PIDParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-proportionair">
<h2>ST_Proportionair<a class="headerlink" href="#st-proportionair" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_Proportionair</span> <span class="p">:</span>
<span class="n">STRUCT</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Control</span> <span class="o">*</span><span class="p">)</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Enable</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
     <span class="s1">&#39;}</span>
<span class="n">xEnable</span>     <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Setpoint</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
     <span class="s1">&#39;}</span>
<span class="n">iSetpoint</span>   <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">HighLimit</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
     <span class="s1">&#39;}</span>
<span class="n">iHiLimit</span>    <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">LowLimit</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
     <span class="s1">&#39;}</span>
<span class="n">iLoLimit</span>    <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Readback</span> <span class="o">*</span><span class="p">)</span>
<span class="n">xStable</span>     <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span><span class="o">//</span><span class="n">TTL</span> <span class="n">signal</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">proportionair</span> <span class="n">controller</span> <span class="n">that</span> <span class="n">the</span> <span class="n">pressure</span> <span class="ow">is</span> <span class="n">stable</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Pressure</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
<span class="n">iPressure</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>


<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcDisplayScale&#39;</span> <span class="o">:=</span> <span class="s1">&#39;0-10&#39;</span><span class="p">}</span>
<span class="n">i_iPressRB</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcDisplayScale&#39;</span> <span class="o">:=</span> <span class="s1">&#39;0-10&#39;</span><span class="p">}</span>
<span class="n">q_iPressCt</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>

<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-propvalvemks253">
<h2>ST_PropValveMKS253<a class="headerlink" href="#st-propvalvemks253" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_PropValveMKS253</span> <span class="n">EXTENDS</span> <span class="n">ST_PressureController</span><span class="p">:</span>
<span class="n">STRUCT</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">Prop</span> <span class="n">valve</span> <span class="n">structure</span><span class="p">,</span> <span class="nb">open</span> <span class="ow">is</span> <span class="n">considered</span> <span class="n">to</span> <span class="n">be</span> <span class="n">the</span> <span class="n">higher</span> <span class="n">axis</span> <span class="n">position</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">Note</span><span class="p">:</span> <span class="n">The</span> <span class="n">wiring</span> <span class="p">(</span><span class="k">if</span> <span class="n">using</span> <span class="n">the</span> <span class="n">dongle</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">ALI</span> <span class="n">schematic</span> <span class="ow">is</span> <span class="n">such</span> <span class="n">that</span> <span class="n">the</span>
    <span class="n">stepper</span> <span class="n">driver</span> <span class="n">must</span> <span class="n">be</span> <span class="n">inverted</span> <span class="n">to</span> <span class="n">make</span> <span class="n">the</span> <span class="n">increasing</span> <span class="n">counter</span> <span class="n">value</span> <span class="n">correspond</span> <span class="n">to</span> <span class="n">a</span> <span class="n">more</span> <span class="nb">open</span> <span class="n">valve</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>

    <span class="o">//</span><span class="n">EPICS</span> <span class="n">Enable</span> <span class="n">Switch</span>
    <span class="n">xEnable</span> <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span><span class="n">EPICS</span> <span class="n">Enable</span> <span class="n">Control</span><span class="p">;</span>
    <span class="n">xEnabled</span>        <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span><span class="n">Valve</span> <span class="n">interlock</span>
    <span class="n">xInterlock</span>      <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span><span class="n">PropValve</span> <span class="n">Control</span> <span class="n">State</span> <span class="n">Control</span>
    <span class="n">ePVCtrlStateReq</span> <span class="p">:</span> <span class="n">HMI_PropValveCtrlState</span><span class="p">;</span>
    <span class="o">//</span><span class="n">PropValve</span> <span class="n">Control</span> <span class="n">State</span> <span class="n">Readback</span>
    <span class="n">ePVCtrlState</span> <span class="p">:</span> <span class="n">HMI_PropValveCtrlState</span><span class="p">;</span>
    <span class="o">//</span><span class="n">NC</span> <span class="n">Axis</span> <span class="n">Ref</span>
    <span class="n">stAxis</span>  <span class="p">:</span>       <span class="n">AXIS_REF</span><span class="p">;</span>
    <span class="o">//</span><span class="n">Physical</span> <span class="n">limit</span> <span class="n">switches</span>
    <span class="n">i_HLS</span>   <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Open</span>
    <span class="n">i_LLS</span>   <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Closed</span>
    <span class="o">//</span><span class="n">Open</span> <span class="n">EPICS</span> <span class="n">LS</span>
    <span class="n">xHLS</span>    <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span><span class="n">Close</span> <span class="n">EPICS</span> <span class="n">LS</span>
    <span class="n">xLLS</span>    <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span><span class="n">Top</span> <span class="n">speed</span> <span class="k">for</span> <span class="n">the</span> <span class="n">valve</span>
    <span class="n">lrMaxSpeed</span>      <span class="p">:</span>       <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">;</span> <span class="o">//</span><span class="n">deg</span><span class="o">/</span><span class="n">sec</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#hmi-propvalvectrlstate">HMI_PropValveCtrlState</a></p></li>
<li><p><a class="reference internal" href="#st-pressurecontroller">ST_PressureController</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-regdeadbandcontrols">
<h2>ST_RegDeadbandControls<a class="headerlink" href="#st-regdeadbandcontrols" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_RegDeadbandControls</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">Deadband</span> <span class="n">controls</span> <span class="o">*</span><span class="p">)</span>
<span class="n">iDeadband</span>   <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>
<span class="n">iMaxSpeed</span>   <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span> <span class="o">//</span> <span class="n">degrees</span> <span class="n">per</span> <span class="n">second</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-regulator">
<h2>ST_Regulator<a class="headerlink" href="#st-regulator" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_Regulator</span> <span class="p">:</span>
<span class="n">STRUCT</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Regulator</span> <span class="n">enable</span> <span class="o">*</span><span class="p">)</span>
<span class="n">xRegEnab</span>    <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Regulator</span> <span class="n">motor</span> <span class="o">*</span><span class="p">)</span>
<span class="n">stRegulatorMotor</span>    <span class="p">:</span>       <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">wPercentageOpen</span>             <span class="p">:</span>       <span class="n">WORD</span><span class="p">;</span>
<span class="n">lrVelocity</span>  <span class="p">:</span>       <span class="n">LREAL</span>   <span class="o">:=</span><span class="mi">360</span> <span class="p">;</span>
<span class="n">lrUpperLimPos</span>       <span class="p">:</span>       <span class="n">LREAL</span>   <span class="o">:=</span> <span class="mi">2887</span><span class="p">;</span> <span class="o">//</span><span class="n">init</span> <span class="n">to</span> <span class="mi">2887</span><span class="p">,</span> <span class="n">legacy</span> <span class="n">hardcoded</span> <span class="n">value</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Deadband</span> <span class="n">controls</span> <span class="o">*</span><span class="p">)</span>
<span class="n">stDeadband</span>  <span class="p">:</span>       <span class="n">ST_RegDeadbandControls</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Manual</span> <span class="n">control</span> <span class="o">*</span><span class="p">)</span>
<span class="n">xManual</span>     <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">xPlus</span>       <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">xMinus</span>      <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">i_iMovePerc</span> <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Knob</span> <span class="n">controls</span> <span class="o">*</span><span class="p">)</span>
<span class="n">i_iPercSP</span> <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Pressure</span> <span class="n">transducer</span> <span class="o">*</span><span class="p">)</span>
<span class="n">i_iRawInPress</span>       <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>
<span class="n">wInPress</span>    <span class="p">:</span>       <span class="n">WORD</span><span class="p">;</span>
<span class="n">i_iRawOutPress</span>      <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>
<span class="n">wOutPress</span>   <span class="p">:</span>       <span class="n">WORD</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Pressure</span> <span class="n">setpoint</span> <span class="o">*</span><span class="p">)</span>
<span class="n">wPressSP</span>    <span class="p">:</span>       <span class="n">WORD</span><span class="p">;</span>
<span class="n">wPressSpHi</span>  <span class="p">:</span>       <span class="n">WORD</span>    <span class="o">:=</span> <span class="mi">2000</span><span class="p">;</span>
<span class="n">xPressSpWarn</span>        <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">xSeeking</span>    <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>

<span class="n">xRegHiLS</span>    <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span>        <span class="n">BOOL</span><span class="p">;</span>
<span class="n">xRegLoLS</span>    <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span>        <span class="n">BOOL</span><span class="p">;</span>

<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-regdeadbandcontrols">ST_RegDeadbandControls</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-selectorm3">
<h2>ST_SelectorM3<a class="headerlink" href="#st-selectorm3" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_SelectorM3</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">Selector</span> <span class="n">EPICS</span> <span class="n">controls</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ValvesLockRequest</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
     <span class="s1">&#39;}</span>
    <span class="n">xResLock</span>        <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">request</span> <span class="n">to</span> <span class="n">lock</span> <span class="n">the</span> <span class="n">valves</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ValvesUnlockRequest</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
     <span class="s1">&#39;}</span>
    <span class="n">xResUnlock</span>      <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">request</span> <span class="n">to</span> <span class="n">unlock</span> <span class="n">the</span> <span class="n">valves</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ValveSyncReqPos</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
     <span class="s1">&#39;}</span>
    <span class="n">iSyncReqPos</span>     <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>  <span class="o">//</span> <span class="n">requested</span> <span class="n">position</span> <span class="n">when</span> <span class="n">synced</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Valve</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="n">ReqPos</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
     <span class="s1">&#39;}</span>
    <span class="n">iVici1ReqPos</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>   <span class="o">//</span> <span class="n">requested</span> <span class="n">position</span> <span class="k">for</span> <span class="n">Vici</span> <span class="mi">1</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Valve</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="n">ReqPos</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
     <span class="s1">&#39;}</span>
    <span class="n">iVici2ReqPos</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>   <span class="o">//</span> <span class="n">requested</span> <span class="n">position</span> <span class="k">for</span> <span class="n">Vici</span> <span class="mi">2</span>

    <span class="o">//</span><span class="n">Hardware</span> <span class="n">control</span>
    <span class="n">astViciVlvCtrl</span>  <span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..2</span><span class="p">]</span> <span class="n">OF</span>        <span class="n">ST_ViciControl</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">Selector</span> <span class="n">EPICS</span> <span class="n">Readbacks</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ValvesLocked</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
    <span class="n">xResLocked</span>      <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">valve</span> <span class="n">movement</span> <span class="ow">is</span> <span class="n">locked</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ValvesSynced</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
    <span class="n">xResSyncd</span>       <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">valves</span> <span class="n">are</span> <span class="n">on</span> <span class="n">the</span> <span class="n">same</span> <span class="n">position</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ValveSyncCurrentPos</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
    <span class="n">iSyncResPos</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">Hardware</span> <span class="n">readbacks</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Valve</span>
     <span class="s1">&#39;}</span>
    <span class="n">astViciVlvStatus</span>        <span class="p">:</span>       <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..2</span><span class="p">]</span> <span class="n">OF</span>  <span class="n">ST_ViciStatus</span><span class="p">;</span>


    <span class="o">//</span> <span class="n">M3</span> <span class="n">flow</span> <span class="n">rates</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">SampleFlow</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
    <span class="n">rLowFlow</span>        <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span> <span class="o">//</span><span class="n">Sensirion</span> <span class="n">Sample</span> <span class="n">Flowrate</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">LiquidSheathFlow</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
    <span class="n">rHighFlow</span>       <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span> <span class="o">//</span><span class="n">Sensirion</span> <span class="n">Sheath</span> <span class="n">liquid</span> <span class="n">flowrate</span>

    <span class="o">//</span> <span class="n">Sample</span> <span class="n">Names</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">SampleNames</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">stSampleNames</span>   <span class="p">:</span>       <span class="n">ST_Strings</span><span class="p">;</span>

<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-strings">ST_Strings</a></p></li>
<li><p><a class="reference internal" href="#st-vicicontrol">ST_ViciControl</a></p></li>
<li><p><a class="reference internal" href="#st-vicistatus">ST_ViciStatus</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-sensirionfm">
<h2>ST_SensirionFM<a class="headerlink" href="#st-sensirionfm" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_SensirionFM</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="n">stCtrl</span>  <span class="p">:</span>       <span class="n">ST_SensirionFMControl</span><span class="p">;</span>
    <span class="n">stStat</span>  <span class="p">:</span>       <span class="n">ST_SensirionFMStatus</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Reset</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">o</span>
     <span class="s1">&#39;}</span>
    <span class="n">xFMReset</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Reset</span> <span class="n">on</span> <span class="n">rising</span> <span class="n">edge</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Flow</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
    <span class="n">rFlow</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span> <span class="o">//</span> <span class="n">uL</span><span class="o">/</span><span class="nb">min</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">OoR</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
    <span class="n">xFMOoR</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Out</span> <span class="n">of</span> <span class="nb">range</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">FlowValid</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
    <span class="n">xFlowValid</span>      <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">driver</span> <span class="n">completes</span> <span class="n">successfully</span>


    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">State</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
    <span class="n">eFMState</span>        <span class="p">:</span>       <span class="n">E_SensirionFMMode</span><span class="p">;</span>


    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Mode</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">o</span>
     <span class="s1">&#39;}</span>
    <span class="n">xFMModeReq</span>      <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="k">for</span> <span class="n">sensirion</span> <span class="n">calibration</span> <span class="nb">range</span> <span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ModeRb</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
    <span class="n">xFMModeRb</span>       <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="k">for</span> <span class="n">sensirion</span> <span class="n">calibration</span> <span class="nb">range</span> <span class="p">(</span><span class="n">readback</span><span class="p">)</span>

<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-sensirionfmcontrol">ST_SensirionFMControl</a></p></li>
<li><p><a class="reference internal" href="#st-sensirionfmstatus">ST_SensirionFMStatus</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-sensirionfmcontrol">
<h2>ST_SensirionFMControl<a class="headerlink" href="#st-sensirionfmcontrol" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_SensirionFMControl</span> <span class="p">:</span>
<span class="n">STRUCT</span>

<span class="n">xCalMode</span>    <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">calib</span> <span class="n">mode</span> <span class="n">request</span> <span class="mi">0</span> <span class="o">=</span> <span class="n">prec</span><span class="p">,</span> <span class="mi">1</span> <span class="o">=</span> <span class="n">extended</span>

<span class="n">xReset</span>              <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">reset</span> <span class="n">request</span>

<span class="n">bAdr</span>                <span class="p">:</span>       <span class="n">BYTE</span><span class="p">;</span> <span class="o">//</span> <span class="n">device</span> <span class="n">address</span>

<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-sensirionfmstatus">
<h2>ST_SensirionFMStatus<a class="headerlink" href="#st-sensirionfmstatus" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_SensirionFMStatus</span> <span class="p">:</span>
<span class="n">STRUCT</span>

    <span class="n">iFlowTicks</span>      <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>
    <span class="n">uiSensorOutput</span>  <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">iState</span>  <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>
    <span class="n">rFlow</span>   <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span> <span class="o">//</span> <span class="n">units</span> <span class="n">of</span> <span class="n">uL</span><span class="o">/</span><span class="nb">min</span>
    <span class="n">xOoR</span>    <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Out</span> <span class="n">of</span> <span class="nb">range</span>
    <span class="n">xFMMode</span> <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">calib</span> <span class="n">mode</span> <span class="n">readback</span> <span class="mi">0</span> <span class="o">=</span> <span class="n">prec</span><span class="p">,</span> <span class="mi">1</span> <span class="o">=</span> <span class="n">extended</span>
    <span class="n">xFlowValid</span>      <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">driver</span> <span class="n">completes</span> <span class="n">successfully</span>
    <span class="n">abReply</span> <span class="p">:</span>       <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..500</span><span class="p">]</span> <span class="n">OF</span> <span class="n">BYTE</span><span class="p">;</span>
    <span class="n">bStatus</span> <span class="p">:</span>       <span class="n">BYTE</span><span class="p">;</span> <span class="o">//</span><span class="n">Sensor</span> <span class="n">status</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Bit</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">0</span><span class="p">:</span> <span class="n">Sensor</span> <span class="n">idle</span>
        <span class="mi">1</span><span class="p">:</span> <span class="n">Sensor</span> <span class="n">Busy</span>
<span class="n">Bit</span> <span class="mi">1</span><span class="p">:</span>      <span class="mi">0</span><span class="p">:</span> <span class="n">Continuous</span> <span class="n">Measurement</span> <span class="n">disabled</span>
        <span class="mi">1</span><span class="p">:</span> <span class="n">Continuous</span> <span class="n">Measurement</span> <span class="n">enabled</span>
<span class="n">Bit</span> <span class="mi">2</span><span class="p">:</span> <span class="p">(</span><span class="k">for</span> <span class="n">Firmware</span> <span class="o">.</span> <span class="mf">1.3</span><span class="p">)</span>
        <span class="mi">0</span><span class="p">:</span> <span class="n">Auto</span> <span class="n">detection</span> <span class="n">Measurement</span> <span class="n">disabled</span>
        <span class="mi">1</span><span class="p">:</span> <span class="n">Auto</span> <span class="n">detection</span> <span class="n">Measurement</span> <span class="n">enabled</span>
<span class="n">Bit</span> <span class="mi">3</span><span class="p">:</span> <span class="p">(</span><span class="k">for</span> <span class="n">Firmware</span> <span class="o">.</span> <span class="mf">1.3</span><span class="p">)</span>
        <span class="mi">0</span><span class="p">:</span> <span class="n">No</span> <span class="n">Auto</span> <span class="n">Measurement</span> <span class="n">since</span> <span class="n">last</span> <span class="n">read</span> <span class="n">out</span> <span class="n">Status</span>
        <span class="mi">1</span><span class="p">:</span> <span class="n">Auto</span> <span class="n">Measurement</span> <span class="n">finished</span> <span class="n">since</span> <span class="n">last</span> <span class="n">read</span> <span class="n">out</span> <span class="n">Status</span><span class="p">,</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">back</span> <span class="n">to</span> <span class="mi">0</span> <span class="n">after</span> <span class="n">read</span> <span class="n">out</span> <span class="o">*</span><span class="p">)</span>

<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-serialcomm">
<h2>ST_SerialComm<a class="headerlink" href="#st-serialcomm" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Generic</span> <span class="n">serial</span> <span class="n">comm</span> <span class="n">necessities</span>
<span class="n">TYPE</span> <span class="n">ST_SerialComm</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="n">RxBuffer</span>    <span class="p">:</span>   <span class="n">ComBuffer</span><span class="p">;</span>
    <span class="n">TxBuffer</span>    <span class="p">:</span>   <span class="n">ComBuffer</span><span class="p">;</span>

    <span class="n">stComIn</span>         <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span>  <span class="p">:</span>       <span class="n">EL6inData22B</span> <span class="p">(</span><span class="o">*</span><span class="n">KL6inData22B</span><span class="o">*</span><span class="p">);</span>
    <span class="n">stComOut</span>        <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span>  <span class="p">:</span>       <span class="n">EL6outData22B</span> <span class="p">(</span><span class="o">*</span><span class="n">KL6outData22B</span><span class="o">*</span><span class="p">);</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-shaker">
<h2>ST_Shaker<a class="headerlink" href="#st-shaker" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_Shaker</span> <span class="p">:</span>
<span class="n">STRUCT</span>

<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">PowerOn</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
 <span class="s1">&#39;}</span>
<span class="n">q_xPwrDO</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span>     <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>

<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">Ilk</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
 <span class="s1">&#39;}</span>
<span class="n">xIlk</span>                <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>


<span class="n">i_xSwitch</span>   <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>

<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">Ctrl</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">o</span>
 <span class="s1">&#39;}</span>
<span class="n">i_xEpics</span>    <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>

<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-shakercontrols">
<h2>ST_ShakerControls<a class="headerlink" href="#st-shakercontrols" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_ShakerControls</span> <span class="p">:</span>
<span class="n">STRUCT</span>

<span class="n">xShaker1On</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">xShaker2On</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">xShaker3On</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">xShaker4On</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">xShaker5On</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">xShaker6On</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">xShaker7On</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">xShaker8On</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>

<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-strings">
<h2>ST_Strings<a class="headerlink" href="#st-strings" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_Strings</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">Twelve</span> <span class="n">strings</span> <span class="n">used</span> <span class="n">to</span> <span class="n">store</span> <span class="n">sample</span> <span class="n">names</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="mi">01</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
     <span class="n">s1</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
     <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="mi">02</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
     <span class="n">s2</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
     <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="mi">03</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
     <span class="n">s3</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
     <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="mi">04</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
     <span class="n">s4</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
     <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="mi">05</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
     <span class="n">s5</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
     <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="mi">06</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
     <span class="n">s6</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
     <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="mi">07</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
     <span class="n">s7</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
     <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="mi">08</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
     <span class="n">s8</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
     <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="mi">09</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
     <span class="n">s9</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
     <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="mi">10</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
     <span class="n">s10</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
     <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="mi">11</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
     <span class="n">s11</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
     <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="mi">12</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
     <span class="n">s12</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-teccontrol">
<h2>ST_TECControl<a class="headerlink" href="#st-teccontrol" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_TECControl</span> <span class="p">:</span>
<span class="n">STRUCT</span>

<span class="n">sAddress</span>    <span class="p">:</span>       <span class="n">STRING</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="n">diTempSetpoint</span>      <span class="p">:</span>       <span class="n">DINT</span><span class="p">;</span>
<span class="n">xOutputOn</span>   <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>


<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-tecstatus">
<h2>ST_TECStatus<a class="headerlink" href="#st-tecstatus" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_TECStatus</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="o">//</span><span class="n">Parameters</span>
    <span class="n">diTemp1</span> <span class="p">:</span>       <span class="n">DINT</span><span class="p">;</span>
    <span class="n">diSetPoint</span>      <span class="p">:</span>       <span class="n">DINT</span><span class="p">;</span>
    <span class="n">diPercentOut</span>    <span class="p">:</span>       <span class="n">DINT</span><span class="p">;</span>
    <span class="n">diCurrent</span>       <span class="p">:</span>       <span class="n">DINT</span><span class="p">;</span>
    <span class="n">xOutputOn</span>       <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span><span class="n">Alarms</span>
    <span class="n">xHiTemp</span> <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">xLoTemp</span> <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">xCompCtrlAlrm</span>   <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">xOverCurrent</span>    <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">xOpenInput1</span>             <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">xOpenInput2</span>             <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">xDriverLowVoltage</span>       <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>


    <span class="o">//</span><span class="n">Interface</span> <span class="n">Diagnosis</span>
<span class="n">xStatusValid</span>        <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">sReply</span>      <span class="p">:</span>       <span class="n">STRING</span><span class="p">;</span>

<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-vicicontrol">
<h2>ST_ViciControl<a class="headerlink" href="#st-vicicontrol" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_ViciControl</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="n">sViciReply</span>                      <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">iReqPos</span>                         <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">xDirection</span>                      <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iAddress</span>                        <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-vicistatus">
<h2>ST_ViciStatus<a class="headerlink" href="#st-vicistatus" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_ViciStatus</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="n">sViciReq</span>                        <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">sViciReply</span>              <span class="p">:</span><span class="n">STRING</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">CurrentPos</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
     <span class="s1">&#39;}</span>
    <span class="n">iCurrPos</span>                                <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">iReqPos</span>         <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>
    <span class="n">xPosValid</span>       <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span><span class="n">iAddress</span>                              <span class="p">:</span><span class="n">INT</span><span class="p">;</span><span class="o">*</span><span class="p">)</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">Do</span> <span class="ow">not</span> <span class="n">use</span> <span class="n">this</span> <span class="n">address</span><span class="o">.</span> <span class="n">If</span> <span class="n">you</span> <span class="n">do</span><span class="p">,</span> <span class="n">the</span> <span class="n">driver</span>
    <span class="n">will</span> <span class="n">overwrite</span> <span class="n">this</span> <span class="n">address</span> <span class="k">with</span> <span class="n">zero</span> <span class="n">each</span> <span class="n">time</span>
    <span class="n">it</span> <span class="n">runs</span><span class="p">,</span> <span class="k">as</span> <span class="n">the</span> <span class="n">status</span> <span class="ow">is</span> <span class="n">an</span> <span class="nb">input</span><span class="p">,</span> <span class="ow">not</span> <span class="n">in_out</span> <span class="o">*</span><span class="p">)</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
</section>
<section id="gvls">
<h1>GVLs<a class="headerlink" href="#gvls" title="Link to this heading"></a></h1>
<section id="gvl">
<h2>GVL<a class="headerlink" href="#gvl" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">VAR_GLOBAL</span>
     <span class="n">g_xFirstPass</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">g_xIOState</span>      <span class="p">:</span>       <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">g_aEcatMaster1</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">AMSNETID</span><span class="p">;</span>
    <span class="n">g_aEcatMaster2</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">AMSNETID</span><span class="p">;</span>
<span class="n">END_VAR</span>
</pre></div>
</div>
</section>
<section id="gvl-autosave">
<h2>GVL_Autosave<a class="headerlink" href="#gvl-autosave" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">VAR_GLOBAL</span> <span class="n">PERSISTENT</span>

    <span class="n">gp_stWaterRegDeadband</span>   <span class="p">:</span>       <span class="n">ST_RegDeadbandControls</span><span class="p">;</span>
    <span class="n">gp_stSheathRegDeadband</span>  <span class="p">:</span>       <span class="n">ST_RegDeadbandControls</span><span class="p">;</span>

    <span class="n">gp_stSelector</span>   <span class="p">:</span>       <span class="n">ST_Selector</span><span class="p">;</span>
    <span class="n">gp_stSelector2</span>  <span class="p">:</span>       <span class="n">ST_Selector</span><span class="p">;</span>

    <span class="n">gp_stRegProp1</span>   <span class="p">:</span>       <span class="n">ST_Proportionair</span><span class="p">;</span>
    <span class="n">gp_stRegProp2</span>   <span class="p">:</span>       <span class="n">ST_Proportionair</span><span class="p">;</span>
    <span class="n">gp_stRegProp3</span>   <span class="p">:</span>       <span class="n">ST_Proportionair</span><span class="p">;</span>
    <span class="n">gp_stRegProp4</span>   <span class="p">:</span>       <span class="n">ST_Proportionair</span><span class="p">;</span>

<span class="n">END_VAR</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-proportionair">ST_Proportionair</a></p></li>
<li><p><a class="reference internal" href="#st-regdeadbandcontrols">ST_RegDeadbandControls</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="gvl-combuffers">
<h2>GVL_ComBuffers<a class="headerlink" href="#gvl-combuffers" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">VAR_GLOBAL</span>

    <span class="n">SerialRXBuffer_SelVici</span> <span class="p">:</span> <span class="n">ComBuffer</span><span class="p">;</span>
    <span class="n">SerialTXBuffer_SelVici</span> <span class="p">:</span> <span class="n">ComBuffer</span><span class="p">;</span>

    <span class="n">SerialRXBuffer_SelFlwMtr</span> <span class="p">:</span> <span class="n">ComBuffer</span><span class="p">;</span>
    <span class="n">SerialTXBuffer_SelFlwMtr</span> <span class="p">:</span> <span class="n">ComBuffer</span><span class="p">;</span>

    <span class="n">SerialRXBuffer_Sel2FlwMtr</span> <span class="p">:</span> <span class="n">ComBuffer</span><span class="p">;</span>
    <span class="n">SerialTXBuffer_Sel2FlwMtr</span> <span class="p">:</span> <span class="n">ComBuffer</span><span class="p">;</span>

    <span class="n">SerialRXBuffer_Sel2Vici</span> <span class="p">:</span> <span class="n">ComBuffer</span><span class="p">;</span>
    <span class="n">SerialTXBuffer_Sel2Vici</span> <span class="p">:</span> <span class="n">ComBuffer</span><span class="p">;</span>

    <span class="n">SerialRXBuffer_CoolerShakerTEC</span> <span class="p">:</span> <span class="n">ComBuffer</span><span class="p">;</span>
    <span class="n">SerialTXBuffer_CoolerShakerTEC</span> <span class="p">:</span> <span class="n">ComBuffer</span><span class="p">;</span>

<span class="n">END_VAR</span>
</pre></div>
</div>
</section>
<section id="gvl-devices">
<h2>GVL_Devices<a class="headerlink" href="#gvl-devices" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">VAR_GLOBAL</span>

<span class="p">(</span><span class="o">*</span> <span class="n">ALI</span> <span class="o">-</span> <span class="n">rarely</span> <span class="n">used</span><span class="p">,</span> <span class="n">stages</span> <span class="n">need</span> <span class="n">to</span> <span class="n">be</span> <span class="n">redone</span> <span class="ow">in</span> <span class="n">new</span> <span class="nb">format</span> <span class="o">*</span><span class="p">)</span>
<span class="o">//</span>  <span class="n">stALI</span>   <span class="p">:</span>       <span class="n">ST_ALI</span><span class="p">;</span>
<span class="o">//</span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
<span class="o">//</span>    <span class="n">pv</span><span class="p">:</span> <span class="o">@</span><span class="p">(</span><span class="n">P</span><span class="p">):</span><span class="n">PCM</span><span class="p">:</span><span class="n">A</span>
<span class="o">//</span> <span class="s1">&#39;}</span>
<span class="o">//</span><span class="n">ALI</span> <span class="p">:</span> <span class="n">FB_ALI</span><span class="p">;</span>


<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="o">@</span><span class="p">(</span><span class="n">P</span><span class="p">):</span><span class="n">SEL</span><span class="p">:</span><span class="n">A</span>
 <span class="s1">&#39;}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.stSensSerial.stComIn.Status := TIIB[M3 Selector A Serial IO (EP6002-0002)]^COM TxPDO-Map Inputs Channel 1^Status;</span>
                          <span class="o">.</span><span class="n">stViciSerial</span><span class="o">.</span><span class="n">stComIn</span><span class="o">.</span><span class="n">Status</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">M3</span> <span class="n">Selector</span> <span class="n">A</span> <span class="n">Serial</span> <span class="n">IO</span> <span class="p">(</span><span class="n">EP6002</span><span class="o">-</span><span class="mi">0002</span><span class="p">)]</span><span class="o">^</span><span class="n">COM</span> <span class="n">TxPDO</span><span class="o">-</span><span class="n">Map</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">2</span><span class="o">^</span><span class="n">Status</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stSensSerial</span><span class="o">.</span><span class="n">stComOut</span><span class="o">.</span><span class="n">Ctrl</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">M3</span> <span class="n">Selector</span> <span class="n">A</span> <span class="n">Serial</span> <span class="n">IO</span> <span class="p">(</span><span class="n">EP6002</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">COM</span> <span class="n">RxPDO</span><span class="o">-</span><span class="n">Map</span> <span class="n">Outputs</span> <span class="n">Channel</span> <span class="mi">1</span><span class="o">^</span><span class="n">Ctrl</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stViciSerial</span><span class="o">.</span><span class="n">stComOut</span><span class="o">.</span><span class="n">Ctrl</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">M3</span> <span class="n">Selector</span> <span class="n">A</span> <span class="n">Serial</span> <span class="n">IO</span> <span class="p">(</span><span class="n">EP6002</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">COM</span> <span class="n">RxPDO</span><span class="o">-</span><span class="n">Map</span> <span class="n">Outputs</span> <span class="n">Channel</span> <span class="mi">2</span><span class="o">^</span><span class="n">Ctrl</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stShaker01</span><span class="o">.</span><span class="n">q_xPwrDO</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">M3</span> <span class="n">Selector</span> <span class="n">A</span> <span class="n">Digital</span> <span class="n">IO</span> <span class="p">(</span><span class="n">EP2338</span><span class="o">-</span><span class="mi">1001</span><span class="p">)]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">9</span><span class="o">^</span><span class="n">Output</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stShaker02</span><span class="o">.</span><span class="n">q_xPwrDO</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">M3</span> <span class="n">Selector</span> <span class="n">A</span> <span class="n">Digital</span> <span class="n">IO</span> <span class="p">(</span><span class="n">EP2338</span><span class="o">-</span><span class="mi">1001</span><span class="p">)]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">10</span><span class="o">^</span><span class="n">Output</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stShaker03</span><span class="o">.</span><span class="n">q_xPwrDO</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">M3</span> <span class="n">Selector</span> <span class="n">A</span> <span class="n">Digital</span> <span class="n">IO</span> <span class="p">(</span><span class="n">EP2338</span><span class="o">-</span><span class="mi">1001</span><span class="p">)]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">11</span><span class="o">^</span><span class="n">Output</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stShaker04</span><span class="o">.</span><span class="n">q_xPwrDO</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">M3</span> <span class="n">Selector</span> <span class="n">A</span> <span class="n">Digital</span> <span class="n">IO</span> <span class="p">(</span><span class="n">EP2338</span><span class="o">-</span><span class="mi">1001</span><span class="p">)]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">12</span><span class="o">^</span><span class="n">Output</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stBaseIO</span><span class="o">.</span><span class="n">i_SyncUnitWC</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">M3</span> <span class="n">Selector</span> <span class="n">A</span> <span class="p">(</span><span class="n">EP1111</span><span class="p">)</span><span class="o">^</span><span class="n">WcState</span><span class="o">^</span><span class="n">WcState</span><span class="p">;</span>
<span class="s1">&#39;}</span>
<span class="n">M3SelectorA</span> <span class="p">:</span> <span class="n">FB_SelectorM3</span><span class="p">;</span>

<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="o">@</span><span class="p">(</span><span class="n">P</span><span class="p">):</span><span class="n">SEL</span><span class="p">:</span><span class="n">B</span>
 <span class="s1">&#39;}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.stSensSerial.stComIn.Status := TIIB[M3 Selector B Serial IO (EP6002-0002)]^COM TxPDO-Map Inputs Channel 1^Status;</span>
                          <span class="o">.</span><span class="n">stViciSerial</span><span class="o">.</span><span class="n">stComIn</span><span class="o">.</span><span class="n">Status</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">M3</span> <span class="n">Selector</span> <span class="n">B</span> <span class="n">Serial</span> <span class="n">IO</span> <span class="p">(</span><span class="n">EP6002</span><span class="o">-</span><span class="mi">0002</span><span class="p">)]</span><span class="o">^</span><span class="n">COM</span> <span class="n">TxPDO</span><span class="o">-</span><span class="n">Map</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">2</span><span class="o">^</span><span class="n">Status</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stSensSerial</span><span class="o">.</span><span class="n">stComOut</span><span class="o">.</span><span class="n">Ctrl</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">M3</span> <span class="n">Selector</span> <span class="n">B</span> <span class="n">Serial</span> <span class="n">IO</span> <span class="p">(</span><span class="n">EP6002</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">COM</span> <span class="n">RxPDO</span><span class="o">-</span><span class="n">Map</span> <span class="n">Outputs</span> <span class="n">Channel</span> <span class="mi">1</span><span class="o">^</span><span class="n">Ctrl</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stViciSerial</span><span class="o">.</span><span class="n">stComOut</span><span class="o">.</span><span class="n">Ctrl</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">M3</span> <span class="n">Selector</span> <span class="n">B</span> <span class="n">Serial</span> <span class="n">IO</span> <span class="p">(</span><span class="n">EP6002</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">COM</span> <span class="n">RxPDO</span><span class="o">-</span><span class="n">Map</span> <span class="n">Outputs</span> <span class="n">Channel</span> <span class="mi">2</span><span class="o">^</span><span class="n">Ctrl</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stShaker01</span><span class="o">.</span><span class="n">q_xPwrDO</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">M3</span> <span class="n">Selector</span> <span class="n">B</span> <span class="n">Digital</span> <span class="n">IO</span> <span class="p">(</span><span class="n">EP2338</span><span class="o">-</span><span class="mi">1001</span><span class="p">)]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">9</span><span class="o">^</span><span class="n">Output</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stShaker02</span><span class="o">.</span><span class="n">q_xPwrDO</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">M3</span> <span class="n">Selector</span> <span class="n">B</span> <span class="n">Digital</span> <span class="n">IO</span> <span class="p">(</span><span class="n">EP2338</span><span class="o">-</span><span class="mi">1001</span><span class="p">)]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">10</span><span class="o">^</span><span class="n">Output</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stShaker03</span><span class="o">.</span><span class="n">q_xPwrDO</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">M3</span> <span class="n">Selector</span> <span class="n">B</span> <span class="n">Digital</span> <span class="n">IO</span> <span class="p">(</span><span class="n">EP2338</span><span class="o">-</span><span class="mi">1001</span><span class="p">)]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">11</span><span class="o">^</span><span class="n">Output</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stShaker04</span><span class="o">.</span><span class="n">q_xPwrDO</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">M3</span> <span class="n">Selector</span> <span class="n">B</span> <span class="n">Digital</span> <span class="n">IO</span> <span class="p">(</span><span class="n">EP2338</span><span class="o">-</span><span class="mi">1001</span><span class="p">)]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">12</span><span class="o">^</span><span class="n">Output</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stBaseIO</span><span class="o">.</span><span class="n">i_SyncUnitWC</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">M3</span> <span class="n">Selector</span> <span class="n">B</span> <span class="p">(</span><span class="n">EP1111</span><span class="p">)</span><span class="o">^</span><span class="n">WcState</span><span class="o">^</span><span class="n">WcState</span>
<span class="s1">&#39;}</span>
<span class="n">M3SelectorB</span> <span class="p">:</span> <span class="n">FB_SelectorM3</span><span class="p">;</span>

<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="o">@</span><span class="p">(</span><span class="n">P</span><span class="p">):</span><span class="n">SEL</span><span class="p">:</span><span class="n">C</span>
 <span class="s1">&#39;}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.stSensSerial.stComIn.Status := TIIB[M3 Selector C Serial IO (EP6002-0002)]^COM TxPDO-Map Inputs Channel 1^Status;</span>
                          <span class="o">.</span><span class="n">stViciSerial</span><span class="o">.</span><span class="n">stComIn</span><span class="o">.</span><span class="n">Status</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">M3</span> <span class="n">Selector</span> <span class="n">C</span> <span class="n">Serial</span> <span class="n">IO</span> <span class="p">(</span><span class="n">EP6002</span><span class="o">-</span><span class="mi">0002</span><span class="p">)]</span><span class="o">^</span><span class="n">COM</span> <span class="n">TxPDO</span><span class="o">-</span><span class="n">Map</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">2</span><span class="o">^</span><span class="n">Status</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stSensSerial</span><span class="o">.</span><span class="n">stComOut</span><span class="o">.</span><span class="n">Ctrl</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">M3</span> <span class="n">Selector</span> <span class="n">C</span> <span class="n">Serial</span> <span class="n">IO</span> <span class="p">(</span><span class="n">EP6002</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">COM</span> <span class="n">RxPDO</span><span class="o">-</span><span class="n">Map</span> <span class="n">Outputs</span> <span class="n">Channel</span> <span class="mi">1</span><span class="o">^</span><span class="n">Ctrl</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stViciSerial</span><span class="o">.</span><span class="n">stComOut</span><span class="o">.</span><span class="n">Ctrl</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">M3</span> <span class="n">Selector</span> <span class="n">C</span> <span class="n">Serial</span> <span class="n">IO</span> <span class="p">(</span><span class="n">EP6002</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">COM</span> <span class="n">RxPDO</span><span class="o">-</span><span class="n">Map</span> <span class="n">Outputs</span> <span class="n">Channel</span> <span class="mi">2</span><span class="o">^</span><span class="n">Ctrl</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stShaker01</span><span class="o">.</span><span class="n">q_xPwrDO</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">M3</span> <span class="n">Selector</span> <span class="n">C</span> <span class="n">Digital</span> <span class="n">IO</span> <span class="p">(</span><span class="n">EP2338</span><span class="o">-</span><span class="mi">1001</span><span class="p">)]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">9</span><span class="o">^</span><span class="n">Output</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stShaker02</span><span class="o">.</span><span class="n">q_xPwrDO</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">M3</span> <span class="n">Selector</span> <span class="n">C</span> <span class="n">Digital</span> <span class="n">IO</span> <span class="p">(</span><span class="n">EP2338</span><span class="o">-</span><span class="mi">1001</span><span class="p">)]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">10</span><span class="o">^</span><span class="n">Output</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stShaker03</span><span class="o">.</span><span class="n">q_xPwrDO</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">M3</span> <span class="n">Selector</span> <span class="n">C</span> <span class="n">Digital</span> <span class="n">IO</span> <span class="p">(</span><span class="n">EP2338</span><span class="o">-</span><span class="mi">1001</span><span class="p">)]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">11</span><span class="o">^</span><span class="n">Output</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stShaker04</span><span class="o">.</span><span class="n">q_xPwrDO</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">M3</span> <span class="n">Selector</span> <span class="n">C</span> <span class="n">Digital</span> <span class="n">IO</span> <span class="p">(</span><span class="n">EP2338</span><span class="o">-</span><span class="mi">1001</span><span class="p">)]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">12</span><span class="o">^</span><span class="n">Output</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stBaseIO</span><span class="o">.</span><span class="n">i_SyncUnitWC</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">M3</span> <span class="n">Selector</span> <span class="n">C</span> <span class="p">(</span><span class="n">EP1111</span><span class="p">)</span><span class="o">^</span><span class="n">WcState</span><span class="o">^</span><span class="n">WcState</span>
<span class="s1">&#39;}</span>
<span class="n">M3SelectorC</span> <span class="p">:</span> <span class="n">FB_SelectorM3</span><span class="p">;</span>

<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="o">@</span><span class="p">(</span><span class="n">P</span><span class="p">):</span><span class="n">SEL</span><span class="p">:</span><span class="n">D</span>
 <span class="s1">&#39;}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.stSensSerial.stComIn.Status := TIIB[M3 Selector D Serial IO (EP6002-0002)]^COM TxPDO-Map Inputs Channel 1^Status;</span>
                          <span class="o">.</span><span class="n">stViciSerial</span><span class="o">.</span><span class="n">stComIn</span><span class="o">.</span><span class="n">Status</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">M3</span> <span class="n">Selector</span> <span class="n">D</span> <span class="n">Serial</span> <span class="n">IO</span> <span class="p">(</span><span class="n">EP6002</span><span class="o">-</span><span class="mi">0002</span><span class="p">)]</span><span class="o">^</span><span class="n">COM</span> <span class="n">TxPDO</span><span class="o">-</span><span class="n">Map</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">2</span><span class="o">^</span><span class="n">Status</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stSensSerial</span><span class="o">.</span><span class="n">stComOut</span><span class="o">.</span><span class="n">Ctrl</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">M3</span> <span class="n">Selector</span> <span class="n">D</span> <span class="n">Serial</span> <span class="n">IO</span> <span class="p">(</span><span class="n">EP6002</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">COM</span> <span class="n">RxPDO</span><span class="o">-</span><span class="n">Map</span> <span class="n">Outputs</span> <span class="n">Channel</span> <span class="mi">1</span><span class="o">^</span><span class="n">Ctrl</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stViciSerial</span><span class="o">.</span><span class="n">stComOut</span><span class="o">.</span><span class="n">Ctrl</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">M3</span> <span class="n">Selector</span> <span class="n">D</span> <span class="n">Serial</span> <span class="n">IO</span> <span class="p">(</span><span class="n">EP6002</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">COM</span> <span class="n">RxPDO</span><span class="o">-</span><span class="n">Map</span> <span class="n">Outputs</span> <span class="n">Channel</span> <span class="mi">2</span><span class="o">^</span><span class="n">Ctrl</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stShaker01</span><span class="o">.</span><span class="n">q_xPwrDO</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">M3</span> <span class="n">Selector</span> <span class="n">D</span> <span class="n">Digital</span> <span class="n">IO</span> <span class="p">(</span><span class="n">EP2338</span><span class="o">-</span><span class="mi">1001</span><span class="p">)]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">9</span><span class="o">^</span><span class="n">Output</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stShaker02</span><span class="o">.</span><span class="n">q_xPwrDO</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">M3</span> <span class="n">Selector</span> <span class="n">D</span> <span class="n">Digital</span> <span class="n">IO</span> <span class="p">(</span><span class="n">EP2338</span><span class="o">-</span><span class="mi">1001</span><span class="p">)]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">10</span><span class="o">^</span><span class="n">Output</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stShaker03</span><span class="o">.</span><span class="n">q_xPwrDO</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">M3</span> <span class="n">Selector</span> <span class="n">D</span> <span class="n">Digital</span> <span class="n">IO</span> <span class="p">(</span><span class="n">EP2338</span><span class="o">-</span><span class="mi">1001</span><span class="p">)]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">11</span><span class="o">^</span><span class="n">Output</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stShaker04</span><span class="o">.</span><span class="n">q_xPwrDO</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">M3</span> <span class="n">Selector</span> <span class="n">D</span> <span class="n">Digital</span> <span class="n">IO</span> <span class="p">(</span><span class="n">EP2338</span><span class="o">-</span><span class="mi">1001</span><span class="p">)]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">12</span><span class="o">^</span><span class="n">Output</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stBaseIO</span><span class="o">.</span><span class="n">i_SyncUnitWC</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">M3</span> <span class="n">Selector</span> <span class="n">D</span> <span class="p">(</span><span class="n">EP1111</span><span class="p">)</span><span class="o">^</span><span class="n">WcState</span><span class="o">^</span><span class="n">WcState</span>
<span class="s1">&#39;}</span>
<span class="n">M3SelectorD</span> <span class="p">:</span> <span class="n">FB_SelectorM3</span><span class="p">;</span>

<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="o">@</span><span class="p">(</span><span class="n">P</span><span class="p">):</span><span class="n">PCM</span><span class="p">:</span><span class="n">A</span>
 <span class="s1">&#39;}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.stPropAir1.i_iPressRB := TIID^MAIN (EtherCAT)^PCM A (EP4374-0002)^AI Inputs Channel 1^Value;</span>
                          <span class="o">.</span><span class="n">stPropAir2</span><span class="o">.</span><span class="n">i_iPressRB</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">PCM</span> <span class="n">A</span> <span class="p">(</span><span class="n">EP4374</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">AI</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">2</span><span class="o">^</span><span class="n">Value</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stPropAir1</span><span class="o">.</span><span class="n">q_iPressCt</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">PCM</span> <span class="n">A</span> <span class="p">(</span><span class="n">EP4374</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">AO</span> <span class="n">Outputs</span> <span class="n">Channel</span> <span class="mi">3</span><span class="o">^</span><span class="n">Analog</span> <span class="n">output</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stPropAir2</span><span class="o">.</span><span class="n">q_iPressCt</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">PCM</span> <span class="n">A</span> <span class="p">(</span><span class="n">EP4374</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">AO</span> <span class="n">Outputs</span> <span class="n">Channel</span> <span class="mi">4</span><span class="o">^</span><span class="n">Analog</span> <span class="n">output</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stSerial1</span><span class="o">.</span><span class="n">stComIn</span><span class="o">.</span><span class="n">Status</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">PCM</span> <span class="n">A</span> <span class="p">(</span><span class="n">EP6002</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">COM</span> <span class="n">TxPDO</span><span class="o">-</span><span class="n">Map</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">1</span><span class="o">^</span><span class="n">Status</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stSerial2</span><span class="o">.</span><span class="n">stComIn</span><span class="o">.</span><span class="n">Status</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">PCM</span> <span class="n">A</span> <span class="p">(</span><span class="n">EP6002</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">COM</span> <span class="n">TxPDO</span><span class="o">-</span><span class="n">Map</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">2</span><span class="o">^</span><span class="n">Status</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stSerial1</span><span class="o">.</span><span class="n">stComOut</span><span class="o">.</span><span class="n">Ctrl</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">PCM</span> <span class="n">A</span> <span class="p">(</span><span class="n">EP6002</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">COM</span> <span class="n">RxPDO</span><span class="o">-</span><span class="n">Map</span> <span class="n">Outputs</span> <span class="n">Channel</span> <span class="mi">1</span><span class="o">^</span><span class="n">Ctrl</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stSerial2</span><span class="o">.</span><span class="n">stComOut</span><span class="o">.</span><span class="n">Ctrl</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">PCM</span> <span class="n">A</span> <span class="p">(</span><span class="n">EP6002</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">COM</span> <span class="n">RxPDO</span><span class="o">-</span><span class="n">Map</span> <span class="n">Outputs</span> <span class="n">Channel</span> <span class="mi">2</span><span class="o">^</span><span class="n">Ctrl</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stBaseIO</span><span class="o">.</span><span class="n">i_SyncUnitWC</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">PCM</span> <span class="n">A</span> <span class="p">(</span><span class="n">EP1111</span><span class="p">)</span><span class="o">^</span><span class="n">WcState</span><span class="o">^</span><span class="n">WcState</span><span class="p">;</span>
<span class="s1">&#39;}</span>
<span class="n">PCMA</span> <span class="p">:</span> <span class="n">FB_PressureControlModule</span><span class="p">;</span>

<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="o">@</span><span class="p">(</span><span class="n">P</span><span class="p">):</span><span class="n">PCM</span><span class="p">:</span><span class="n">B</span>
 <span class="s1">&#39;}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.stPropAir1.i_iPressRB := TIID^MAIN (EtherCAT)^PCM B (EP4374-0002)^AI Inputs Channel 1^Value;</span>
                          <span class="o">.</span><span class="n">stPropAir2</span><span class="o">.</span><span class="n">i_iPressRB</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">PCM</span> <span class="n">B</span> <span class="p">(</span><span class="n">EP4374</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">AI</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">2</span><span class="o">^</span><span class="n">Value</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stPropAir1</span><span class="o">.</span><span class="n">q_iPressCt</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">PCM</span> <span class="n">B</span> <span class="p">(</span><span class="n">EP4374</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">AO</span> <span class="n">Outputs</span> <span class="n">Channel</span> <span class="mi">3</span><span class="o">^</span><span class="n">Analog</span> <span class="n">output</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stPropAir2</span><span class="o">.</span><span class="n">q_iPressCt</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">PCM</span> <span class="n">B</span> <span class="p">(</span><span class="n">EP4374</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">AO</span> <span class="n">Outputs</span> <span class="n">Channel</span> <span class="mi">4</span><span class="o">^</span><span class="n">Analog</span> <span class="n">output</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stSerial1</span><span class="o">.</span><span class="n">stComIn</span><span class="o">.</span><span class="n">Status</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">PCM</span> <span class="n">B</span> <span class="p">(</span><span class="n">EP6002</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">COM</span> <span class="n">TxPDO</span><span class="o">-</span><span class="n">Map</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">1</span><span class="o">^</span><span class="n">Status</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stSerial2</span><span class="o">.</span><span class="n">stComIn</span><span class="o">.</span><span class="n">Status</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">PCM</span> <span class="n">B</span> <span class="p">(</span><span class="n">EP6002</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">COM</span> <span class="n">TxPDO</span><span class="o">-</span><span class="n">Map</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">2</span><span class="o">^</span><span class="n">Status</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stSerial1</span><span class="o">.</span><span class="n">stComOut</span><span class="o">.</span><span class="n">Ctrl</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">PCM</span> <span class="n">B</span> <span class="p">(</span><span class="n">EP6002</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">COM</span> <span class="n">RxPDO</span><span class="o">-</span><span class="n">Map</span> <span class="n">Outputs</span> <span class="n">Channel</span> <span class="mi">1</span><span class="o">^</span><span class="n">Ctrl</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stSerial2</span><span class="o">.</span><span class="n">stComOut</span><span class="o">.</span><span class="n">Ctrl</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">PCM</span> <span class="n">B</span> <span class="p">(</span><span class="n">EP6002</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">COM</span> <span class="n">RxPDO</span><span class="o">-</span><span class="n">Map</span> <span class="n">Outputs</span> <span class="n">Channel</span> <span class="mi">2</span><span class="o">^</span><span class="n">Ctrl</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stBaseIO</span><span class="o">.</span><span class="n">i_SyncUnitWC</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">PCM</span> <span class="n">B</span> <span class="p">(</span><span class="n">EP1111</span><span class="p">)</span><span class="o">^</span><span class="n">WcState</span><span class="o">^</span><span class="n">WcState</span><span class="p">;</span>

<span class="s1">&#39;}</span>
<span class="n">PCMB</span> <span class="p">:</span> <span class="n">FB_PressureControlModule</span><span class="p">;</span>

<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="o">@</span><span class="p">(</span><span class="n">P</span><span class="p">):</span><span class="n">PCM</span><span class="p">:</span><span class="n">C</span>
 <span class="s1">&#39;}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.stPropAir1.i_iPressRB := TIID^MAIN (EtherCAT)^PCM C (EP4374-0002)^AI Inputs Channel 1^Value;</span>
                          <span class="o">.</span><span class="n">stPropAir2</span><span class="o">.</span><span class="n">i_iPressRB</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">PCM</span> <span class="n">C</span> <span class="p">(</span><span class="n">EP4374</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">AI</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">2</span><span class="o">^</span><span class="n">Value</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stPropAir1</span><span class="o">.</span><span class="n">q_iPressCt</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">PCM</span> <span class="n">C</span> <span class="p">(</span><span class="n">EP4374</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">AO</span> <span class="n">Outputs</span> <span class="n">Channel</span> <span class="mi">3</span><span class="o">^</span><span class="n">Analog</span> <span class="n">output</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stPropAir2</span><span class="o">.</span><span class="n">q_iPressCt</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">PCM</span> <span class="n">C</span> <span class="p">(</span><span class="n">EP4374</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">AO</span> <span class="n">Outputs</span> <span class="n">Channel</span> <span class="mi">4</span><span class="o">^</span><span class="n">Analog</span> <span class="n">output</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stSerial1</span><span class="o">.</span><span class="n">stComIn</span><span class="o">.</span><span class="n">Status</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">PCM</span> <span class="n">C</span> <span class="p">(</span><span class="n">EP6002</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">COM</span> <span class="n">TxPDO</span><span class="o">-</span><span class="n">Map</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">1</span><span class="o">^</span><span class="n">Status</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stSerial2</span><span class="o">.</span><span class="n">stComIn</span><span class="o">.</span><span class="n">Status</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">PCM</span> <span class="n">C</span> <span class="p">(</span><span class="n">EP6002</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">COM</span> <span class="n">TxPDO</span><span class="o">-</span><span class="n">Map</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">2</span><span class="o">^</span><span class="n">Status</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stSerial1</span><span class="o">.</span><span class="n">stComOut</span><span class="o">.</span><span class="n">Ctrl</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">PCM</span> <span class="n">C</span> <span class="p">(</span><span class="n">EP6002</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">COM</span> <span class="n">RxPDO</span><span class="o">-</span><span class="n">Map</span> <span class="n">Outputs</span> <span class="n">Channel</span> <span class="mi">1</span><span class="o">^</span><span class="n">Ctrl</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stSerial2</span><span class="o">.</span><span class="n">stComOut</span><span class="o">.</span><span class="n">Ctrl</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">PCM</span> <span class="n">C</span> <span class="p">(</span><span class="n">EP6002</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">COM</span> <span class="n">RxPDO</span><span class="o">-</span><span class="n">Map</span> <span class="n">Outputs</span> <span class="n">Channel</span> <span class="mi">2</span><span class="o">^</span><span class="n">Ctrl</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stBaseIO</span><span class="o">.</span><span class="n">i_SyncUnitWC</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">PCM</span> <span class="n">C</span> <span class="p">(</span><span class="n">EP1111</span><span class="p">)</span><span class="o">^</span><span class="n">WcState</span><span class="o">^</span><span class="n">WcState</span><span class="p">;</span>
<span class="s1">&#39;}</span>
<span class="n">PCMC</span> <span class="p">:</span> <span class="n">FB_PressureControlModule</span><span class="p">;</span>

<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="o">@</span><span class="p">(</span><span class="n">P</span><span class="p">):</span><span class="n">PCM</span><span class="p">:</span><span class="n">D</span>
 <span class="s1">&#39;}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.stPropAir1.i_iPressRB := TIID^MAIN (EtherCAT)^PCM D (EP4374-0002)^AI Inputs Channel 1^Value;</span>
                          <span class="o">.</span><span class="n">stPropAir2</span><span class="o">.</span><span class="n">i_iPressRB</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">PCM</span> <span class="n">D</span> <span class="p">(</span><span class="n">EP4374</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">AI</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">2</span><span class="o">^</span><span class="n">Value</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stPropAir1</span><span class="o">.</span><span class="n">q_iPressCt</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">PCM</span> <span class="n">D</span> <span class="p">(</span><span class="n">EP4374</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">AO</span> <span class="n">Outputs</span> <span class="n">Channel</span> <span class="mi">3</span><span class="o">^</span><span class="n">Analog</span> <span class="n">output</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stPropAir2</span><span class="o">.</span><span class="n">q_iPressCt</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">PCM</span> <span class="n">D</span> <span class="p">(</span><span class="n">EP4374</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">AO</span> <span class="n">Outputs</span> <span class="n">Channel</span> <span class="mi">4</span><span class="o">^</span><span class="n">Analog</span> <span class="n">output</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stSerial1</span><span class="o">.</span><span class="n">stComIn</span><span class="o">.</span><span class="n">Status</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">PCM</span> <span class="n">D</span> <span class="p">(</span><span class="n">EP6002</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">COM</span> <span class="n">TxPDO</span><span class="o">-</span><span class="n">Map</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">1</span><span class="o">^</span><span class="n">Status</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stSerial2</span><span class="o">.</span><span class="n">stComIn</span><span class="o">.</span><span class="n">Status</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">PCM</span> <span class="n">D</span> <span class="p">(</span><span class="n">EP6002</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">COM</span> <span class="n">TxPDO</span><span class="o">-</span><span class="n">Map</span> <span class="n">Inputs</span> <span class="n">Channel</span> <span class="mi">2</span><span class="o">^</span><span class="n">Status</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stSerial1</span><span class="o">.</span><span class="n">stComOut</span><span class="o">.</span><span class="n">Ctrl</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">PCM</span> <span class="n">D</span> <span class="p">(</span><span class="n">EP6002</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">COM</span> <span class="n">RxPDO</span><span class="o">-</span><span class="n">Map</span> <span class="n">Outputs</span> <span class="n">Channel</span> <span class="mi">1</span><span class="o">^</span><span class="n">Ctrl</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stSerial2</span><span class="o">.</span><span class="n">stComOut</span><span class="o">.</span><span class="n">Ctrl</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">PCM</span> <span class="n">D</span> <span class="p">(</span><span class="n">EP6002</span><span class="o">-</span><span class="mi">0002</span><span class="p">)</span><span class="o">^</span><span class="n">COM</span> <span class="n">RxPDO</span><span class="o">-</span><span class="n">Map</span> <span class="n">Outputs</span> <span class="n">Channel</span> <span class="mi">2</span><span class="o">^</span><span class="n">Ctrl</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stBaseIO</span><span class="o">.</span><span class="n">i_SyncUnitWC</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">PCM</span> <span class="n">D</span> <span class="p">(</span><span class="n">EP1111</span><span class="p">)</span><span class="o">^</span><span class="n">WcState</span><span class="o">^</span><span class="n">WcState</span><span class="p">;</span>
<span class="s1">&#39;}</span>
<span class="n">PCMD</span> <span class="p">:</span> <span class="n">FB_PressureControlModule</span><span class="p">;</span>

<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="o">@</span><span class="p">(</span><span class="n">P</span><span class="p">):</span><span class="n">MAN</span>
 <span class="s1">&#39;}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.stValve[1].qxDO := TIIB[Gas_Mani_ValveCtrl (EP2338-0001)]^Channel 9^Output;</span>
                          <span class="o">.</span><span class="n">stValve</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ixOPN</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">Gas_Mani_ValveRbk</span> <span class="p">(</span><span class="n">EP2338</span><span class="o">-</span><span class="mi">0001</span><span class="p">)]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">1</span><span class="o">^</span><span class="n">Input</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stValve</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">qxDO</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">Gas_Mani_ValveCtrl</span> <span class="p">(</span><span class="n">EP2338</span><span class="o">-</span><span class="mi">0001</span><span class="p">)]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">10</span><span class="o">^</span><span class="n">Output</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stValve</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">ixOPN</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">Gas_Mani_ValveRbk</span> <span class="p">(</span><span class="n">EP2338</span><span class="o">-</span><span class="mi">0001</span><span class="p">)]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">2</span><span class="o">^</span><span class="n">Input</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stValve</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">qxDO</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">Gas_Mani_ValveCtrl</span> <span class="p">(</span><span class="n">EP2338</span><span class="o">-</span><span class="mi">0001</span><span class="p">)]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">11</span><span class="o">^</span><span class="n">Output</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stValve</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">ixOPN</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">Gas_Mani_ValveRbk</span> <span class="p">(</span><span class="n">EP2338</span><span class="o">-</span><span class="mi">0001</span><span class="p">)]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">3</span><span class="o">^</span><span class="n">Input</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stValve</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">qxDO</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">Gas_Mani_ValveCtrl</span> <span class="p">(</span><span class="n">EP2338</span><span class="o">-</span><span class="mi">0001</span><span class="p">)]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">12</span><span class="o">^</span><span class="n">Output</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stValve</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">ixOPN</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">Gas_Mani_ValveRbk</span> <span class="p">(</span><span class="n">EP2338</span><span class="o">-</span><span class="mi">0001</span><span class="p">)]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">4</span><span class="o">^</span><span class="n">Input</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stValve</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">qxDO</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">Gas_Mani_ValveCtrl</span> <span class="p">(</span><span class="n">EP2338</span><span class="o">-</span><span class="mi">0001</span><span class="p">)]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">13</span><span class="o">^</span><span class="n">Output</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stValve</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">ixOPN</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">Gas_Mani_ValveRbk</span> <span class="p">(</span><span class="n">EP2338</span><span class="o">-</span><span class="mi">0001</span><span class="p">)]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">5</span><span class="o">^</span><span class="n">Input</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stValve</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">qxDO</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">Gas_Mani_ValveCtrl</span> <span class="p">(</span><span class="n">EP2338</span><span class="o">-</span><span class="mi">0001</span><span class="p">)]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">14</span><span class="o">^</span><span class="n">Output</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stValve</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">ixOPN</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">Gas_Mani_ValveRbk</span> <span class="p">(</span><span class="n">EP2338</span><span class="o">-</span><span class="mi">0001</span><span class="p">)]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">6</span><span class="o">^</span><span class="n">Input</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stValve</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">qxDO</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">Gas_Mani_ValveCtrl</span> <span class="p">(</span><span class="n">EP2338</span><span class="o">-</span><span class="mi">0001</span><span class="p">)]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">15</span><span class="o">^</span><span class="n">Output</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stValve</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">ixOPN</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">Gas_Mani_ValveRbk</span> <span class="p">(</span><span class="n">EP2338</span><span class="o">-</span><span class="mi">0001</span><span class="p">)]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">7</span><span class="o">^</span><span class="n">Input</span><span class="p">;</span>
                          <span class="o">.</span><span class="n">stBaseIO</span><span class="o">.</span><span class="n">i_SyncUnitWC</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">Gas_Mani</span> <span class="p">(</span><span class="n">EP1111</span><span class="p">)</span><span class="o">^</span><span class="n">WcState</span><span class="o">^</span><span class="n">WcState</span><span class="p">;</span>
<span class="s1">&#39;}</span>
<span class="n">GasMan</span> <span class="p">:</span> <span class="n">FB_GasManifold</span><span class="p">;</span>

<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="o">@</span><span class="p">(</span><span class="n">P</span><span class="p">):</span><span class="n">MFM</span><span class="p">:</span><span class="n">A</span>
 <span class="s1">&#39;}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.stMFM.i_rFlow := TIID^MAIN (EtherCAT)^Bronkhorst MFM A^TxPDO Map^fMeasure;</span>
                          <span class="o">.</span><span class="n">stMFM</span><span class="o">.</span><span class="n">q_rSetpoint</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">Bronkhorst</span> <span class="n">MFM</span> <span class="n">A</span><span class="o">^</span><span class="n">RxPDO</span> <span class="n">Map</span><span class="o">^</span><span class="n">fSetpoint</span><span class="p">;</span>
<span class="s1">&#39;}</span>
<span class="n">BronkhorstA</span> <span class="p">:</span> <span class="n">FB_BronkhorstMFM</span><span class="p">;</span>

<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="o">@</span><span class="p">(</span><span class="n">P</span><span class="p">):</span><span class="n">MFM</span><span class="p">:</span><span class="n">B</span>
 <span class="s1">&#39;}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.stMFM.i_rFlow := TIID^MAIN (EtherCAT)^Bronkhorst MFM B^TxPDO Map^fMeasure;</span>
                          <span class="o">.</span><span class="n">stMFM</span><span class="o">.</span><span class="n">q_rSetpoint</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">Bronkhorst</span> <span class="n">MFM</span> <span class="n">B</span><span class="o">^</span><span class="n">RxPDO</span> <span class="n">Map</span><span class="o">^</span><span class="n">fSetpoint</span><span class="p">;</span>
<span class="s1">&#39;}</span>
<span class="n">BronkhorstB</span> <span class="p">:</span> <span class="n">FB_BronkhorstMFM</span><span class="p">;</span>

<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="o">@</span><span class="p">(</span><span class="n">P</span><span class="p">):</span><span class="n">MFM</span><span class="p">:</span><span class="n">C</span>
 <span class="s1">&#39;}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.stMFM.i_rFlow := TIID^MAIN (EtherCAT)^Bronkhorst MFM C^TxPDO Map^fMeasure;</span>
                          <span class="o">.</span><span class="n">stMFM</span><span class="o">.</span><span class="n">q_rSetpoint</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">Bronkhorst</span> <span class="n">MFM</span> <span class="n">C</span><span class="o">^</span><span class="n">RxPDO</span> <span class="n">Map</span><span class="o">^</span><span class="n">fSetpoint</span><span class="p">;</span>
<span class="s1">&#39;}</span>
<span class="n">BronkhorstC</span> <span class="p">:</span> <span class="n">FB_BronkhorstMFM</span><span class="p">;</span>

<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="o">@</span><span class="p">(</span><span class="n">P</span><span class="p">):</span><span class="n">MFM</span><span class="p">:</span><span class="n">D</span>
 <span class="s1">&#39;}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.stMFM.i_rFlow := TIID^MAIN (EtherCAT)^Bronkhorst MFM D^TxPDO Map^fMeasure;</span>
                          <span class="o">.</span><span class="n">stMFM</span><span class="o">.</span><span class="n">q_rSetpoint</span> <span class="o">:=</span> <span class="n">TIID</span><span class="o">^</span><span class="n">MAIN</span> <span class="p">(</span><span class="n">EtherCAT</span><span class="p">)</span><span class="o">^</span><span class="n">Bronkhorst</span> <span class="n">MFM</span> <span class="n">D</span><span class="o">^</span><span class="n">RxPDO</span> <span class="n">Map</span><span class="o">^</span><span class="n">fSetpoint</span><span class="p">;</span>
<span class="s1">&#39;}</span>
<span class="n">BronkhorstD</span> <span class="p">:</span> <span class="n">FB_BronkhorstMFM</span><span class="p">;</span>

<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="o">@</span><span class="p">(</span><span class="n">P</span><span class="p">):</span><span class="n">SPR</span><span class="p">:</span><span class="n">A</span>
 <span class="s1">&#39;}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcLinkTo&#39;</span> <span class="o">:=</span> <span class="s1">&#39;.q_xDO1 := TIIB[Solenoid Pair A Digital IO (EP2338-0001)]^Channel 9^Output;</span>
                          <span class="o">.</span><span class="n">q_xDO2</span> <span class="o">:=</span> <span class="n">TIIB</span><span class="p">[</span><span class="n">Solenoid</span> <span class="n">Pair</span> <span class="n">A</span> <span class="n">Digital</span> <span class="n">IO</span> <span class="p">(</span><span class="n">EP2338</span><span class="o">-</span><span class="mi">0001</span><span class="p">)]</span><span class="o">^</span><span class="n">Channel</span> <span class="mi">10</span><span class="o">^</span><span class="n">Output</span><span class="p">;</span>
<span class="s1">&#39;}</span>
<span class="n">SolenoidPairA</span> <span class="p">:</span> <span class="n">FB_SolenoidPair</span><span class="p">;</span>

<span class="n">END_VAR</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-ali">FB_ALI</a></p></li>
<li><p><a class="reference internal" href="#fb-bronkhorstmfm">FB_BronkhorstMFM</a></p></li>
<li><p><a class="reference internal" href="#fb-gasmanifold">FB_GasManifold</a></p></li>
<li><p><a class="reference internal" href="#fb-pressurecontrolmodule">FB_PressureControlModule</a></p></li>
<li><p><a class="reference internal" href="#fb-selectorm3">FB_SelectorM3</a></p></li>
<li><p><a class="reference internal" href="#fb-solenoidpair">FB_SolenoidPair</a></p></li>
<li><p><a class="reference internal" href="#main">MAIN</a></p></li>
<li><p><a class="reference internal" href="#st-ali">ST_ALI</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="gvl-io">
<h2>GVL_IO<a class="headerlink" href="#gvl-io" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="n">VAR_GLOBAL</span>

    <span class="n">iq_stM2SelectorA</span>        <span class="p">:</span>       <span class="n">ST_M2SelectorIO</span><span class="p">;</span>
    <span class="n">iq_stM2SelectorB</span>        <span class="p">:</span>       <span class="n">ST_M2SelectorIO</span><span class="p">;</span>

    <span class="n">iq_stM3SelectorA</span>        <span class="p">:</span>       <span class="n">ST_M3SelectorIO</span><span class="p">;</span>
    <span class="n">iq_stM3SelectorB</span>        <span class="p">:</span>       <span class="n">ST_M3SelectorIO</span><span class="p">;</span>

    <span class="n">iq_stPressCtrlA</span>         <span class="p">:</span>       <span class="n">ST_M3PressCtrlIO</span><span class="p">;</span>
    <span class="n">iq_stPressCtrlB</span>         <span class="p">:</span>       <span class="n">ST_M3PressCtrlIO</span><span class="p">;</span>

    <span class="n">i_iFscEB1Ch0AI</span>  <span class="n">AT</span>      <span class="o">%</span><span class="n">I</span><span class="o">*</span>     <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>
    <span class="n">i_iFscEB1Ch1AI</span>  <span class="n">AT</span>      <span class="o">%</span><span class="n">I</span><span class="o">*</span>     <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>
    <span class="n">i_iFscEB1Ch2AI</span>  <span class="n">AT</span>      <span class="o">%</span><span class="n">I</span><span class="o">*</span>     <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>
    <span class="n">i_iFscEB1Ch3AI</span>  <span class="n">AT</span>      <span class="o">%</span><span class="n">I</span><span class="o">*</span>     <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>

    <span class="n">iq_stM3GasManifold</span>      <span class="p">:</span>       <span class="n">ST_M3GasManifoldIO</span><span class="p">;</span>

<span class="n">END_VAR</span>
</pre></div>
</div>
</section>
<section id="gvl-misc">
<h2>GVL_misc<a class="headerlink" href="#gvl-misc" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">VAR_GLOBAL</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">Overall</span> <span class="n">system</span> <span class="n">controls</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">xN2Purge</span> <span class="p">:</span>      <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">g_xEstop</span>        <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>



    <span class="p">(</span><span class="o">*</span> <span class="n">Shakers</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">st_Shakers</span> <span class="p">:</span> <span class="n">ST_ShakerControls</span><span class="p">;</span>

    <span class="n">xEnableRemoteControl</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">xSystemPressurized</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="n">gxRedLight</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">gxYellowLight</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">gxGreenLight</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

<span class="n">END_VAR</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-shakercontrols">ST_ShakerControls</a></p></li>
</ul>
</dd>
</dl>
</section>
</section>
<section id="pous">
<h1>POUs<a class="headerlink" href="#pous" title="Link to this heading"></a></h1>
<section id="f-axisref-to-msta">
<h2>F_AxisRef_To_MSTA<a class="headerlink" href="#f-axisref-to-msta" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION</span> <span class="n">F_AxisRef_To_MSTA</span>  <span class="p">:</span> <span class="n">UINT</span>
<span class="n">VAR_INPUT</span>
    <span class="n">stManipAxis</span>     <span class="p">:</span>       <span class="n">ST_ManipAxis</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">MSTA</span>    <span class="p">:</span>       <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">block</span> <span class="n">translates</span> <span class="n">the</span> <span class="n">axis</span> <span class="n">ref</span> <span class="n">status</span> <span class="n">to</span> <span class="n">an</span> <span class="n">EPICS</span> <span class="n">psuedo</span> <span class="n">MSTA</span> <span class="n">value</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">A</span><span class="o">.</span> <span class="n">Wallace</span><span class="p">,</span> <span class="mi">17</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="mi">17</span> <span class="o">*</span><span class="p">)</span>

<span class="n">MSTA</span><span class="mf">.1</span> <span class="o">:=</span> <span class="n">stManipAxis</span><span class="o">.</span><span class="n">stAxis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
<span class="n">MSTA</span><span class="mf">.0</span> <span class="o">:=</span> <span class="n">stManipAxis</span><span class="o">.</span><span class="n">xEnabled</span><span class="p">;</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-manipaxis">ST_ManipAxis</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="f-rpressure">
<h2>F_rPressure<a class="headerlink" href="#f-rpressure" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION</span> <span class="n">F_rPressure</span> <span class="p">:</span> <span class="n">WORD</span>
<span class="n">VAR_INPUT</span>
    <span class="n">iRawVoltage</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Transducer</span> <span class="n">voltage</span> <span class="n">to</span> <span class="n">pressure</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Add</span> <span class="n">formula</span> <span class="ow">in</span> <span class="n">here</span> <span class="o">*</span><span class="p">)</span>
<span class="n">F_rPressure</span> <span class="o">:=</span> <span class="n">INT_TO_WORD</span><span class="p">((</span><span class="n">iRawVoltage</span><span class="o">*</span><span class="mi">3000</span><span class="p">)</span><span class="o">/</span><span class="mi">32767</span><span class="p">);</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</section>
<section id="fb-ali">
<h2>FB_ALI<a class="headerlink" href="#fb-ali" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_ALI</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">iq_Injector</span>     <span class="p">:</span>       <span class="n">ST_ALI</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fb925ALINB1</span> <span class="p">:</span> <span class="n">FB_9XX</span><span class="p">;</span>
    <span class="n">fb925ALINB2</span> <span class="p">:</span> <span class="n">FB_9XX</span><span class="p">;</span>
    <span class="n">fb722ALINB3</span> <span class="p">:</span> <span class="n">FB_GCM</span><span class="p">;</span>

    <span class="n">fbManipX</span>        <span class="p">:</span>       <span class="n">FB_ManipAxis</span><span class="p">;</span>
    <span class="n">fbManipY</span>        <span class="p">:</span>       <span class="n">FB_ManipAxis</span><span class="p">;</span>
    <span class="n">fbManipZ</span>        <span class="p">:</span>       <span class="n">FB_ManipAxis</span><span class="p">;</span>



    <span class="n">fbPropValve</span>             <span class="p">:</span>       <span class="n">FB_PropValve</span><span class="p">;</span>

    <span class="n">ftHotPlug</span>       <span class="p">:</span>       <span class="n">F_TRIG</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span><span class="n">When</span> <span class="n">the</span> <span class="n">system</span> <span class="ow">is</span> <span class="n">plugged</span> <span class="ow">in</span><span class="p">,</span> <span class="n">WC</span> <span class="n">goes</span> <span class="n">to</span> <span class="n">zero</span><span class="p">,</span> <span class="n">so</span> <span class="n">reset</span> <span class="n">motion</span> <span class="n">control</span> <span class="ow">and</span> <span class="n">other</span> <span class="n">stuff</span>
<span class="n">ftHotPlug</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">iq_Injector</span><span class="o">.</span><span class="n">i_SyncUnitWC</span><span class="p">);</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Soft</span> <span class="n">IO</span> <span class="o">*</span><span class="p">)</span>
<span class="n">iq_Injector</span><span class="o">.</span><span class="n">stNozzleBoxVG</span><span class="o">.</span><span class="n">iPRESS_R</span> <span class="o">:=</span><span class="n">iq_Injector</span><span class="o">.</span><span class="n">i_EP3174_Ch1</span><span class="p">;</span>
<span class="n">iq_Injector</span><span class="o">.</span><span class="n">stSkimmerVG</span><span class="o">.</span><span class="n">iPRESS_R</span> <span class="o">:=</span> <span class="n">iq_Injector</span><span class="o">.</span><span class="n">i_EP3174_Ch2</span><span class="p">;</span>
<span class="n">iq_Injector</span><span class="o">.</span><span class="n">stRelaxVG</span><span class="o">.</span><span class="n">iPRESS_R</span> <span class="o">:=</span> <span class="n">iq_Injector</span><span class="o">.</span><span class="n">i_EP3174_Ch3</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Vacuum</span> <span class="n">Gauge</span> <span class="n">Supervisor</span> <span class="o">*</span><span class="p">)</span>
<span class="n">fb925ALINB1</span><span class="p">(</span><span class="n">VG</span><span class="o">:=</span><span class="n">iq_Injector</span><span class="o">.</span><span class="n">stNozzleBoxVG</span><span class="p">);</span>
<span class="n">fb925ALINB2</span><span class="p">(</span><span class="n">VG</span><span class="o">:=</span><span class="n">iq_Injector</span><span class="o">.</span><span class="n">stSkimmerVG</span><span class="p">);</span>
<span class="n">fb722ALINB3</span><span class="p">(</span><span class="n">VG</span><span class="o">:=</span><span class="n">iq_Injector</span><span class="o">.</span><span class="n">stRelaxVG</span><span class="p">);</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Butterfly</span> <span class="n">valve</span> <span class="o">*</span><span class="p">)</span>
<span class="n">iq_Injector</span><span class="o">.</span><span class="n">stPropVlv</span><span class="o">.</span><span class="n">xInterlock</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">iq_Injector</span><span class="o">.</span><span class="n">stPropVlv</span><span class="o">.</span><span class="n">i_rPressRB</span> <span class="o">:=</span> <span class="n">iq_Injector</span><span class="o">.</span><span class="n">stSkimmerVG</span><span class="o">.</span><span class="n">rPRESS</span><span class="p">;</span>
<span class="n">fbPropValve</span><span class="p">(</span><span class="n">stPropValve</span><span class="o">:=</span><span class="n">iq_Injector</span><span class="o">.</span><span class="n">stPropVlv</span><span class="p">,</span> <span class="n">i_xExtIlk</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">);</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Manipulator</span> <span class="o">*</span><span class="p">)</span>
<span class="n">fbManipX</span><span class="p">(</span><span class="n">iq_ManipAxis</span><span class="o">:=</span><span class="n">iq_Injector</span><span class="o">.</span><span class="n">axisX</span><span class="p">,</span> <span class="n">i_xHotPlug</span><span class="o">:=</span><span class="n">ftHotPlug</span><span class="o">.</span><span class="n">Q</span><span class="p">);</span>
<span class="n">fbManipY</span><span class="p">(</span><span class="n">iq_ManipAxis</span><span class="o">:=</span><span class="n">iq_Injector</span><span class="o">.</span><span class="n">axisY</span><span class="p">,</span> <span class="n">i_xHotPlug</span><span class="o">:=</span><span class="n">ftHotPlug</span><span class="o">.</span><span class="n">Q</span><span class="p">);</span>
<span class="n">fbManipZ</span><span class="p">(</span><span class="n">iq_ManipAxis</span><span class="o">:=</span><span class="n">iq_Injector</span><span class="o">.</span><span class="n">axisZ</span><span class="p">,</span> <span class="n">i_xHotPlug</span><span class="o">:=</span><span class="n">ftHotPlug</span><span class="o">.</span><span class="n">Q</span><span class="p">);</span>
<span class="n">F_AxisRef_To_MSTA</span><span class="p">(</span><span class="n">stManipAxis</span><span class="o">:=</span><span class="n">iq_Injector</span><span class="o">.</span><span class="n">axisX</span><span class="p">,</span> <span class="n">MSTA</span><span class="o">=&gt;</span><span class="n">iq_Injector</span><span class="o">.</span><span class="n">axisX</span><span class="o">.</span><span class="n">uiMsta</span><span class="p">);</span>
<span class="n">F_AxisRef_To_MSTA</span><span class="p">(</span><span class="n">stManipAxis</span><span class="o">:=</span><span class="n">iq_Injector</span><span class="o">.</span><span class="n">axisY</span><span class="p">,</span> <span class="n">MSTA</span><span class="o">=&gt;</span><span class="n">iq_Injector</span><span class="o">.</span><span class="n">axisY</span><span class="o">.</span><span class="n">uiMsta</span><span class="p">);</span>
<span class="n">F_AxisRef_To_MSTA</span><span class="p">(</span><span class="n">stManipAxis</span><span class="o">:=</span><span class="n">iq_Injector</span><span class="o">.</span><span class="n">axisZ</span><span class="p">,</span> <span class="n">MSTA</span><span class="o">=&gt;</span><span class="n">iq_Injector</span><span class="o">.</span><span class="n">axisZ</span><span class="o">.</span><span class="n">uiMsta</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-manipaxis">FB_ManipAxis</a></p></li>
<li><p><a class="reference internal" href="#fb-propvalve">FB_PropValve</a></p></li>
<li><p><a class="reference internal" href="#f-axisref-to-msta">F_AxisRef_To_MSTA</a></p></li>
<li><p><a class="reference internal" href="#st-ali">ST_ALI</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-bronkhorstmfm">
<h2>FB_BronkhorstMFM<a class="headerlink" href="#fb-bronkhorstmfm" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_BronkhorstMFM</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
        <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
            <span class="n">pv</span><span class="p">:</span>
         <span class="s1">&#39;}</span>
        <span class="n">stMFM</span>       <span class="p">:</span>       <span class="n">ST_BhElFlow</span><span class="p">;</span>
<span class="n">END_VAR</span>


<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-bhelflow">ST_BhElFlow</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-ecatdiag">
<h2>FB_EcatDiag<a class="headerlink" href="#fb-ecatdiag" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_EcatDiag</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_AMSNetId</span>      <span class="p">:</span>       <span class="n">AMSNETID</span><span class="p">;</span> <span class="o">//</span><span class="n">Connect</span> <span class="n">this</span> <span class="n">to</span> <span class="n">an</span> <span class="n">AMSNETID</span> <span class="n">structure</span> <span class="k">as</span> <span class="n">a</span> <span class="n">PLC</span> <span class="nb">input</span><span class="o">.</span> <span class="n">Then</span> <span class="n">link</span> <span class="n">the</span> <span class="nb">input</span> <span class="n">to</span> <span class="n">the</span> <span class="n">AMSNETID</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">master</span> <span class="n">info</span><span class="o">.</span>
    <span class="n">i_xFirstPass</span>    <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">q_xAllStatesGood</span>        <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">sNetId</span> <span class="p">:</span> <span class="n">T_AmsNetId</span><span class="p">;</span>
    <span class="n">astTermStates</span> <span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..256</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_EcSlaveState</span><span class="p">;</span>

    <span class="n">fbGetAllSlaveStates</span>     <span class="p">:</span> <span class="n">FB_EcGetAllSlaveStates</span><span class="p">;</span>
    <span class="n">ftReset</span> <span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>

    <span class="n">iterator</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span><span class="n">Create</span> <span class="n">the</span> <span class="n">net</span> <span class="n">ID</span> <span class="n">string</span>
<span class="n">sNetID</span> <span class="o">:=</span> <span class="n">F_CreateAmsNetId</span><span class="p">(</span><span class="n">i_AMSNetId</span><span class="p">);</span>

<span class="o">//</span><span class="n">Query</span> <span class="n">the</span> <span class="n">state</span> <span class="n">of</span> <span class="nb">all</span> <span class="n">terminals</span><span class="p">,</span> <span class="n">collect</span> <span class="ow">in</span> <span class="n">astTermStates</span>
<span class="n">ftReset</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">fbGetAllSlaveStates</span><span class="o">.</span><span class="n">bBusy</span> <span class="n">OR</span> <span class="n">i_xFirstPass</span><span class="p">);</span>
<span class="n">fbGetAllSlaveStates</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">ftReset</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="n">fbGetAllSlaveStates</span><span class="p">(</span><span class="n">sNetId</span><span class="o">:=</span><span class="n">sNetId</span><span class="p">,</span> <span class="n">pStateBuf</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">astTermStates</span><span class="p">),</span> <span class="n">cbBufLen</span><span class="o">:=</span><span class="n">SIZEOF</span><span class="p">(</span><span class="n">astTermStates</span><span class="p">));</span>
<span class="o">//</span><span class="n">Keep</span> <span class="n">checking</span><span class="o">...</span>

<span class="o">//</span><span class="n">Cycle</span> <span class="n">through</span> <span class="n">each</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">array</span> <span class="ow">and</span> <span class="n">check</span> <span class="k">if</span> <span class="n">we</span> <span class="n">have</span> <span class="n">anyone</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">OP</span> <span class="ow">and</span> <span class="n">that</span> <span class="n">the</span> <span class="n">link</span> <span class="n">state</span> <span class="ow">is</span> <span class="n">good</span><span class="o">.</span>
<span class="o">//</span> <span class="n">If</span> <span class="n">so</span><span class="p">,</span> <span class="n">then</span> <span class="nb">set</span> <span class="n">our</span> <span class="k">global</span> <span class="n">IO</span> <span class="n">bad</span> <span class="n">boolean</span><span class="o">.</span>
<span class="n">IF</span> <span class="n">fbGetAllSlaveStates</span><span class="o">.</span><span class="n">nSlaves</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">q_xAllStatesGood</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">iterator</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="p">(</span><span class="n">fbGetAllSlaveStates</span><span class="o">.</span><span class="n">nSlaves</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">BY</span> <span class="mi">1</span>
    <span class="n">DO</span>
    <span class="n">IF</span> <span class="n">NOT</span><span class="p">(</span> <span class="p">(</span><span class="n">astTermStates</span><span class="p">[</span><span class="n">iterator</span><span class="p">]</span><span class="o">.</span><span class="n">deviceState</span> <span class="o">=</span> <span class="n">EC_DEVICE_STATE_OP</span><span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">astTermStates</span><span class="p">[</span><span class="n">iterator</span><span class="p">]</span><span class="o">.</span><span class="n">linkState</span> <span class="o">=</span> <span class="n">EC_LINK_STATE_OK</span><span class="p">))</span> <span class="n">THEN</span>
        <span class="n">q_xAllStatesGood</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_FOR</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-gasmanifold">
<h2>FB_GasManifold<a class="headerlink" href="#fb-gasmanifold" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_GasManifold</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">IO</span>
     <span class="s1">&#39;}</span>
    <span class="n">stBaseIO</span> <span class="p">:</span> <span class="n">ST_M3DeviceBaseIO</span><span class="p">;</span>


    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Valve</span>
     <span class="s1">&#39;}</span>
    <span class="n">stValve</span> <span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MANIFOLD_VALVES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_ManifoldValve</span><span class="p">;</span>
    <span class="n">fbValve</span> <span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">MANIFOLD_VALVES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_ManiValve</span><span class="p">;</span>
    <span class="n">idx</span> <span class="p">:</span> <span class="nb">int</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">MANIFOLD_VALVES</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">7</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">FOR</span> <span class="n">idx</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">to</span> <span class="n">MANIFOLD_VALVES</span> <span class="n">DO</span>
    <span class="n">stValve</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">xILK</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span> <span class="o">//</span> <span class="n">these</span> <span class="n">valves</span> <span class="n">have</span> <span class="n">no</span> <span class="n">interlock</span>
    <span class="n">fbValve</span><span class="p">[</span><span class="n">idx</span><span class="p">](</span><span class="n">iq_valve</span> <span class="o">:=</span> <span class="n">stValve</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
<span class="n">END_FOR</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-manivalve">FB_ManiValve</a></p></li>
<li><p><a class="reference internal" href="#st-m3devicebaseio">ST_M3DeviceBaseIO</a></p></li>
<li><p><a class="reference internal" href="#st-manifoldvalve">ST_ManifoldValve</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-manipaxis">
<h2>FB_ManipAxis<a class="headerlink" href="#fb-manipaxis" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_ManipAxis</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_xHotPlug</span>      <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">q_asResult</span><span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">1..20</span><span class="p">]</span> <span class="n">OF</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">q_xError</span>        <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">iq_ManipAxis</span>    <span class="p">:</span>       <span class="n">ST_ManipAxis</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>

    <span class="n">mcPower</span> <span class="p">:</span>       <span class="n">MC_Power</span><span class="p">;</span>
    <span class="n">mcReset</span> <span class="p">:</span>       <span class="n">MC_Reset</span><span class="p">;</span>
    <span class="n">mcMoveAbsolute</span> <span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..2</span><span class="p">]</span> <span class="n">OF</span> <span class="n">MC_MoveAbsolute</span><span class="p">;</span>
    <span class="n">mcHalt</span>  <span class="p">:</span>       <span class="n">MC_Halt</span><span class="p">;</span>
    <span class="n">mcSmoothMover</span>   <span class="p">:</span>       <span class="n">MC_SmoothMover</span><span class="p">;</span>
    <span class="o">//</span><span class="n">Error</span> <span class="n">Stuff</span>
    <span class="n">indexResult</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">fbFormatString</span>  <span class="p">:</span>       <span class="n">FB_FormatString</span><span class="p">;</span>

    <span class="n">xInitComplete</span>   <span class="p">:</span>       <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

    <span class="n">imcBlockIndex</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>

    <span class="n">rtEnable</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">ftEnable</span> <span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="n">rtStop</span>  <span class="p">:</span>       <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">rtStart</span> <span class="p">:</span>       <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">rReqAbsPosOld</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">rReqAbsPosPrevious</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="n">iI</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Manipulator</span> <span class="n">Axis</span> <span class="n">Function</span> <span class="n">Block</span>
<span class="n">Alex</span> <span class="n">Wallace</span><span class="p">,</span> <span class="mi">2016</span><span class="o">-</span><span class="mi">8</span><span class="o">-</span><span class="mi">8</span>

<span class="n">This</span> <span class="n">block</span> <span class="n">works</span> <span class="n">by</span> <span class="n">jumping</span> <span class="n">between</span> <span class="n">two</span> <span class="n">absolute</span> <span class="n">move</span> <span class="n">blocks</span> <span class="ow">and</span> <span class="n">buffering</span>
<span class="n">the</span> <span class="n">motion</span> <span class="n">between</span> <span class="n">them</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>


<span class="n">rtEnable</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">xEnable</span><span class="p">);</span>
<span class="n">ftEnable</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">xEnable</span><span class="p">);</span>

<span class="o">//</span><span class="n">Update</span> <span class="n">status</span>
<span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">stAxis</span><span class="p">();</span>

<span class="n">IF</span> <span class="n">rtEnable</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">ftEnable</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">xInitComplete</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">Init</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">xInitComplete</span> <span class="n">THEN</span>
    <span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">MoveEnabled</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span><span class="n">For</span> <span class="n">EPICS</span><span class="p">,</span> <span class="n">because</span> <span class="n">the</span> <span class="n">modbus</span> <span class="nb">map</span> <span class="n">was</span> <span class="n">made</span> <span class="k">for</span> <span class="mi">32</span> <span class="n">bit</span><span class="o">..</span>
<span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">rActPos</span> <span class="o">:=</span> <span class="n">LREAL_TO_REAL</span><span class="p">(</span><span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">stAxis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPos</span><span class="p">);</span>


<span class="n">CASE</span> <span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">eState</span> <span class="n">OF</span>
    <span class="mi">0</span><span class="p">:</span> <span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">Init</span><span class="p">;</span>
    <span class="n">Init</span><span class="p">:</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">Start</span> <span class="n">by</span> <span class="n">initializing</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">axis</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">mcPower</span><span class="o">.</span><span class="n">Enable</span> <span class="o">:=</span> <span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">xEnable</span><span class="p">;</span>
    <span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">rReqAbsPos</span> <span class="o">:=</span> <span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">rActPos</span><span class="p">;</span> <span class="o">//</span><span class="n">do</span> <span class="n">this</span> <span class="n">when</span> <span class="n">the</span> <span class="n">PLC</span> <span class="n">comes</span> <span class="n">up</span> <span class="n">so</span> <span class="n">we</span> <span class="n">don</span><span class="s1">&#39;t just lose the position if we tweak</span>
    <span class="n">IF</span> <span class="n">mcPower</span><span class="o">.</span><span class="n">Status</span> <span class="n">THEN</span> <span class="o">//</span><span class="n">success</span>
        <span class="n">xInitComplete</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">q_asResult</span><span class="p">[</span><span class="n">indexResult</span><span class="p">]</span> <span class="o">:=</span> <span class="s1">&#39;Motor init success&#39;</span><span class="p">;</span>
        <span class="n">indexResult</span> <span class="o">:=</span> <span class="n">indexResult</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">MoveEnabled</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">mcPower</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
        <span class="n">mcPower</span><span class="o">.</span><span class="n">Enable</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">fbFormatString</span><span class="p">(</span><span class="n">sFormat</span><span class="o">:=</span><span class="s1">&#39;Init mcPower Error: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">arg1</span><span class="o">:=</span><span class="n">F_UDINT</span><span class="p">(</span><span class="n">mcPower</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">));</span>
        <span class="n">ActError</span><span class="p">();</span>
    <span class="n">END_IF</span>

    <span class="n">MoveEnabled</span><span class="p">:</span>
        <span class="n">mcSmoothMover</span><span class="o">.</span><span class="n">Enable</span> <span class="o">:=</span> <span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">xEnable</span><span class="p">;</span>
        <span class="n">mcSmoothMover</span><span class="o">.</span><span class="n">ReqAbsPos</span> <span class="o">:=</span> <span class="n">LIMIT</span><span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="n">REAL_TO_LREAL</span><span class="p">(</span><span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">rReqAbsPos</span><span class="p">),</span> <span class="mi">100</span><span class="p">);</span>
        <span class="n">mcSmoothMover</span><span class="o">.</span><span class="n">Execute</span> <span class="o">:=</span> <span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">xStart</span><span class="p">;</span>
        <span class="p">(</span><span class="o">*</span><span class="n">We</span><span class="s1">&#39;ve already captured the rising edge of start (if there was one, so</span>
        <span class="n">go</span> <span class="n">ahead</span> <span class="ow">and</span> <span class="n">reset</span> <span class="n">it</span><span class="o">.*</span><span class="p">)</span>
        <span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">xStart</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

        <span class="o">//</span><span class="n">Halt</span>
        <span class="n">mcHalt</span><span class="o">.</span><span class="n">Execute</span> <span class="n">S</span><span class="o">=</span> <span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">xStop</span><span class="p">;</span>
        <span class="n">mcHalt</span><span class="o">.</span><span class="n">Execute</span> <span class="n">R</span><span class="o">=</span> <span class="n">mcHalt</span><span class="o">.</span><span class="n">Busy</span><span class="p">;</span>
        <span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">xStop</span> <span class="n">R</span><span class="o">=</span> <span class="n">mcHalt</span><span class="o">.</span><span class="n">Busy</span><span class="p">;</span>
        <span class="n">IF</span> <span class="n">mcPower</span><span class="o">.</span><span class="n">Error</span> <span class="n">OR</span> <span class="n">mcSmoothMover</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
            <span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">eState</span><span class="o">:=</span><span class="n">Error</span><span class="p">;</span>
        <span class="n">END_IF</span>



<span class="n">END_CASE</span>


<span class="n">mcReset</span><span class="o">.</span><span class="n">Execute</span> <span class="o">:=</span> <span class="n">rtEnable</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">i_xHotPlug</span> <span class="n">OR</span> <span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">xReset</span><span class="p">;</span>
<span class="o">//</span><span class="n">Reset</span> <span class="n">the</span> <span class="n">reset</span> <span class="n">controls</span> <span class="k">for</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">reset</span>
<span class="n">IF</span> <span class="n">mcReset</span><span class="o">.</span><span class="n">Done</span> <span class="n">THEN</span>
    <span class="n">mcReset</span><span class="o">.</span><span class="n">Execute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">xReset</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">eState</span><span class="o">:=</span><span class="n">Init</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="o">//</span><span class="n">Set</span> <span class="n">function</span> <span class="n">block</span> <span class="n">state</span> <span class="n">once</span> <span class="n">axis</span> <span class="ow">is</span> <span class="n">happy</span> <span class="n">again</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">stAxis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
    <span class="n">q_xError</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>


<span class="p">(</span><span class="o">*</span> <span class="n">Run</span> <span class="n">the</span> <span class="n">mc</span> <span class="n">blocks</span> <span class="o">*</span><span class="p">)</span>
<span class="n">ActPower</span><span class="p">();</span>
<span class="n">mcReset</span><span class="p">(</span><span class="n">Axis</span><span class="o">:=</span><span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">stAxis</span><span class="p">);</span>
<span class="n">mcSmoothMover</span><span class="p">(</span><span class="n">Axis</span><span class="o">:=</span><span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">stAxis</span><span class="p">,</span>
    <span class="n">Velocity</span><span class="o">:=</span><span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">lrVelocity</span><span class="p">);</span>
<span class="n">mcHalt</span><span class="p">(</span><span class="n">Axis</span><span class="o">:=</span><span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">stAxis</span><span class="p">);</span>

<span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">xDmov</span> <span class="o">:=</span> <span class="n">mcHalt</span><span class="o">.</span><span class="n">Done</span> <span class="n">OR</span> <span class="n">mcSmoothMover</span><span class="o">.</span><span class="n">Done</span><span class="p">;</span>
<span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">xMovn</span> <span class="o">:=</span> <span class="n">mcHalt</span><span class="o">.</span><span class="n">Busy</span> <span class="n">OR</span> <span class="n">mcSmoothMover</span><span class="o">.</span><span class="n">Busy</span><span class="p">;</span>

<span class="o">//</span><span class="n">For</span> <span class="n">display</span><span class="p">,</span> <span class="n">this</span> <span class="n">logic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">for</span> <span class="n">safety</span>
<span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">xHLS</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">xHiLS</span><span class="p">;</span>
<span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">xLLS</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">xLoLS</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">ActPower</span><span class="p">:</span>

<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">ActError</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Error</span> <span class="n">action</span>
<span class="o">*</span><span class="p">)</span>

<span class="o">//</span><span class="n">Reset</span> <span class="n">the</span> <span class="n">debugging</span> <span class="n">index</span>
<span class="n">IF</span> <span class="n">indexResult</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="n">THEN</span> <span class="n">indexResult</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">END_IF</span>

<span class="n">iq_ManipAxis</span><span class="o">.</span><span class="n">eState</span> <span class="o">:=</span> <span class="n">Error</span><span class="p">;</span>
<span class="n">q_xError</span>    <span class="o">:=</span>      <span class="n">TRUE</span><span class="p">;</span>
<span class="n">q_asResult</span><span class="p">[</span><span class="n">indexResult</span><span class="p">]</span> <span class="o">:=</span> <span class="n">fbFormatString</span><span class="o">.</span><span class="n">sOut</span><span class="p">;</span>
<span class="n">indexResult</span> <span class="o">:=</span> <span class="n">indexResult</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#mc-smoothmover">MC_SmoothMover</a></p></li>
<li><p><a class="reference internal" href="#st-manipaxis">ST_ManipAxis</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-manivalve">
<h2>FB_ManiValve<a class="headerlink" href="#fb-manivalve" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_ManiValve</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">iq_valve</span>        <span class="p">:</span>       <span class="n">ST_ManifoldValve</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Basic</span> <span class="n">valve</span> <span class="n">control</span> <span class="n">block</span> <span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">iq_valve</span><span class="o">.</span><span class="n">xILK</span> <span class="n">THEN</span>
    <span class="n">iq_valve</span><span class="o">.</span><span class="n">xSW</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">iq_valve</span><span class="o">.</span><span class="n">qxDO</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="p">(</span><span class="n">iq_valve</span><span class="o">.</span><span class="n">xILK</span> <span class="ow">and</span> <span class="n">iq_valve</span><span class="o">.</span><span class="n">xSW</span><span class="p">);</span> <span class="o">//</span> <span class="n">These</span> <span class="n">are</span> <span class="n">normally</span> <span class="nb">open</span> <span class="n">valves</span><span class="p">,</span> <span class="n">qxDO</span> <span class="n">closes</span> <span class="n">the</span> <span class="n">valve</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-manifoldvalve">ST_ManifoldValve</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-pid-ext">
<h2>FB_PID_EXT<a class="headerlink" href="#fb-pid-ext" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PID_EXT</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_lrSetpoint</span>    <span class="p">:</span>       <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">i_lrActVal</span>      <span class="p">:</span>       <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">i_stPIDParams</span>   <span class="p">:</span>       <span class="n">ST_PIDParams</span><span class="p">;</span>
    <span class="o">//</span><span class="n">Hold</span> <span class="n">the</span> <span class="n">output</span> <span class="ow">and</span> <span class="n">pause</span> <span class="n">the</span> <span class="n">block</span>
    <span class="n">i_Hold</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">i_Reset</span> <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">q_lrCtrlOutput</span>  <span class="p">:</span>       <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">q_Error</span> <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_Limited</span>       <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbPID</span>   <span class="p">:</span>       <span class="n">FB_BasicPID</span><span class="p">;</span>
    <span class="n">eState</span>  <span class="p">:</span>       <span class="n">E_CTRL_MODE</span><span class="p">;</span>
    <span class="n">xInitialized</span>    <span class="p">:</span>       <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">lrSetpoint</span>      <span class="p">:</span>       <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">lrActVal</span>        <span class="p">:</span>       <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">bReset</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">lrCtrlOutput</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">xFirstPass</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">stDiag</span>  <span class="p">:</span>       <span class="n">ST_fbDiagnostics</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>

<span class="n">NOTE</span><span class="p">:</span> <span class="n">If</span> <span class="n">the</span> <span class="n">PID</span> <span class="n">block</span> <span class="ow">is</span> <span class="n">having</span> <span class="n">issues</span> <span class="n">check</span> <span class="n">the</span> <span class="n">cycle</span> <span class="n">time</span><span class="p">,</span> <span class="n">it</span> <span class="n">might</span> <span class="n">be</span> <span class="n">wrong</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">fbPID</span><span class="o">.</span><span class="n">nErrorStatus</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">eState</span> <span class="o">:=</span> <span class="n">E_CTRL_MODE</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">fbPID</span><span class="o">.</span><span class="n">nErrorStatus</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">AND</span> <span class="n">xInitialized</span> <span class="n">THEN</span>
    <span class="n">q_Error</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">i_Hold</span> <span class="n">THEN</span>
        <span class="n">eState</span> <span class="o">:=</span> <span class="n">E_CTRL_MODE</span><span class="o">.</span><span class="n">Hold</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">eState</span> <span class="o">:=</span> <span class="n">E_CTRL_MODE</span><span class="o">.</span><span class="n">Run</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">CASE</span> <span class="n">eState</span> <span class="n">OF</span>
    <span class="n">E_CTRL_MODE</span><span class="o">.</span><span class="n">Init</span><span class="p">:</span>
        <span class="o">//</span><span class="n">Complete</span> <span class="mi">1</span> <span class="k">pass</span> <span class="n">through</span> <span class="n">this</span> <span class="n">FB</span> <span class="n">to</span> <span class="n">check</span> <span class="n">PID</span> <span class="n">block</span> <span class="k">for</span> <span class="n">errors</span>
        <span class="n">IF</span> <span class="n">xFirstPass</span> <span class="n">THEN</span>
            <span class="n">xInitialized</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span><span class="o">//</span><span class="k">pass</span>
        <span class="n">ELSE</span>
            <span class="n">xInitialized</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">E_CTRL_MODE</span><span class="o">.</span><span class="n">Run</span><span class="p">:</span>
        <span class="n">lrSetpoint</span> <span class="o">:=</span> <span class="n">i_lrSetpoint</span><span class="p">;</span>
        <span class="n">lrCtrlOutput</span> <span class="o">:=</span> <span class="n">fbPID</span><span class="o">.</span><span class="n">fCtrlOutput</span><span class="p">;</span>
        <span class="n">lrActVal</span> <span class="o">:=</span> <span class="n">i_lrActVal</span><span class="p">;</span>
        <span class="n">bReset</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">E_CTRL_MODE</span><span class="o">.</span><span class="n">Hold</span><span class="p">:</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">While</span> <span class="n">holding</span><span class="p">,</span> <span class="n">the</span> <span class="n">setpoint</span> <span class="n">value</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">the</span> <span class="n">actual</span>
    <span class="n">value</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">execution</span> <span class="n">of</span> <span class="n">the</span> <span class="n">PID</span> <span class="n">block</span> <span class="ow">is</span> <span class="n">paused</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">lrSetpoint</span> <span class="o">:=</span> <span class="n">lrActVal</span><span class="p">;</span>
        <span class="n">lrCtrlOutput</span> <span class="o">:=</span> <span class="n">lrCtrlOutput</span><span class="p">;</span>
        <span class="n">bReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">E_CTRL_MODE</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
        <span class="n">q_Error</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">lrSetpoint</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">lrCtrlOutput</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_CASE</span>

<span class="n">fbPID</span><span class="p">(</span><span class="n">fSetpointValue</span> <span class="o">:=</span> <span class="n">lrSetpoint</span><span class="p">,</span>
    <span class="n">fActualValue</span> <span class="o">:=</span> <span class="n">lrActVal</span><span class="p">,</span>
    <span class="n">bReset</span> <span class="o">:=</span> <span class="n">bReset</span><span class="p">,</span>
    <span class="n">fCtrlCycleTime</span> <span class="o">:=</span><span class="n">i_stPIDParams</span><span class="o">.</span><span class="n">fCtrlCycleTime</span><span class="p">,</span>
    <span class="n">fKp</span> <span class="o">:=</span> <span class="n">i_stPIDParams</span><span class="o">.</span><span class="n">fKp</span><span class="p">,</span>
    <span class="n">fTn</span> <span class="o">:=</span> <span class="n">i_stPIDParams</span><span class="o">.</span><span class="n">fTn</span><span class="p">,</span>
    <span class="n">fTv</span> <span class="o">:=</span> <span class="n">i_stPIDParams</span><span class="o">.</span><span class="n">fTv</span><span class="p">,</span>
    <span class="n">fTd</span> <span class="o">:=</span> <span class="n">i_stPIDParams</span><span class="o">.</span><span class="n">fTd</span>
    <span class="p">);</span>

<span class="o">//</span><span class="n">Hold</span> <span class="n">everything</span> <span class="n">until</span> <span class="n">fb</span> <span class="ow">is</span> <span class="n">initialized</span>
<span class="n">IF</span> <span class="n">xInitialized</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">q_Error</span> <span class="n">THEN</span>
    <span class="o">//</span><span class="n">Indicate</span> <span class="n">that</span> <span class="n">the</span> <span class="n">output</span> <span class="ow">is</span> <span class="n">being</span> <span class="n">limited</span>
    <span class="n">q_Limited</span> <span class="o">:=</span> <span class="n">lrCtrlOutput</span> <span class="o">&gt;</span> <span class="n">i_stPIDParams</span><span class="o">.</span><span class="n">fUpperLim</span> <span class="n">OR</span> <span class="n">lrCtrlOutput</span> <span class="o">&lt;</span> <span class="n">i_stPIDParams</span><span class="o">.</span><span class="n">fLowerLim</span><span class="p">;</span>
    <span class="n">q_lrCtrlOutput</span> <span class="o">:=</span> <span class="n">LIMIT</span><span class="p">(</span><span class="n">i_stPIDParams</span><span class="o">.</span><span class="n">fLowerLim</span><span class="p">,</span> <span class="n">lrCtrlOutput</span><span class="p">,</span> <span class="n">i_stPIDParams</span><span class="o">.</span><span class="n">fUpperLim</span><span class="p">);</span>
<span class="n">ELSE</span>
    <span class="n">q_lrCtrlOutput</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">q_Limited</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">xFirstPass</span> <span class="o">:=</span> <span class="kc">False</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-ctrl-mode">E_CTRL_MODE</a></p></li>
<li><p><a class="reference internal" href="#st-pidparams">ST_PIDParams</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-pressurecontrolmodule">
<h2>FB_PressureControlModule<a class="headerlink" href="#fb-pressurecontrolmodule" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Encapsulation</span> <span class="n">of</span> <span class="n">a</span> <span class="n">pressure</span> <span class="n">control</span> <span class="n">module</span><span class="o">.</span>
<span class="o">//</span> <span class="n">A</span><span class="o">.</span> <span class="n">Wallace</span><span class="p">,</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">22</span>
<span class="o">//</span> <span class="n">Support</span> <span class="k">for</span> <span class="mi">2</span> <span class="n">proportionairs</span><span class="p">,</span> <span class="mi">4</span> <span class="n">generic</span> <span class="n">analog</span> <span class="n">inputs</span> <span class="p">(</span><span class="n">usually</span> <span class="n">a</span> <span class="n">pressure</span> <span class="n">gauge</span>
<span class="o">//</span> <span class="ow">and</span> <span class="n">two</span> <span class="n">shimadzu</span> <span class="n">ports</span><span class="o">.</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PressureControlModule</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">IO</span>
     <span class="s1">&#39;}</span>
    <span class="n">stBaseIO</span> <span class="p">:</span> <span class="n">ST_M3DeviceBaseIO</span><span class="p">;</span>

    <span class="n">stSerial1</span> <span class="p">:</span> <span class="n">ST_SerialComm</span><span class="p">;</span>
    <span class="n">stSerial2</span> <span class="p">:</span> <span class="n">ST_SerialComm</span><span class="p">;</span>

    <span class="n">fbSerial1</span> <span class="p">:</span> <span class="n">FB_SerialCommWrapper</span><span class="p">;</span>
    <span class="n">fbSerial2</span> <span class="p">:</span> <span class="n">FB_SerialCommWrapper</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PropAir</span><span class="p">:</span><span class="mi">01</span>
     <span class="s1">&#39;}</span>
    <span class="n">stPropAir1</span> <span class="p">:</span> <span class="n">ST_Proportionair</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PropAir</span><span class="p">:</span><span class="mi">02</span>
     <span class="s1">&#39;}</span>
    <span class="n">stPropAir2</span> <span class="p">:</span> <span class="n">ST_Proportionair</span><span class="p">;</span>

    <span class="n">PropAir1</span> <span class="p">:</span> <span class="n">FB_ProportionairRegulator</span><span class="p">;</span>
    <span class="n">PropAir2</span> <span class="p">:</span> <span class="n">FB_ProportionairRegulator</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">PropAir1</span><span class="p">(</span><span class="n">iq_stRegProp</span><span class="o">:=</span><span class="n">stPropAir1</span><span class="p">);</span>
<span class="n">PropAir2</span><span class="p">(</span><span class="n">iq_stRegProp</span><span class="o">:=</span><span class="n">stPropAir2</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">SerialComm</span><span class="p">:</span>
<span class="n">fbSerial1</span><span class="p">(</span><span class="n">stSerialComm</span> <span class="o">:=</span> <span class="n">stSerial1</span><span class="p">);</span>
<span class="n">fbSerial2</span><span class="p">(</span><span class="n">stSerialComm</span> <span class="o">:=</span> <span class="n">stSerial2</span><span class="p">);</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-proportionairregulator">FB_ProportionairRegulator</a></p></li>
<li><p><a class="reference internal" href="#fb-serialcommwrapper">FB_SerialCommWrapper</a></p></li>
<li><p><a class="reference internal" href="#st-m3devicebaseio">ST_M3DeviceBaseIO</a></p></li>
<li><p><a class="reference internal" href="#st-proportionair">ST_Proportionair</a></p></li>
<li><p><a class="reference internal" href="#st-serialcomm">ST_SerialComm</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-proportionairregulator">
<h2>FB_ProportionairRegulator<a class="headerlink" href="#fb-proportionairregulator" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_ProportionairRegulator</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">iq_stRegProp</span>    <span class="p">:</span>       <span class="n">ST_Proportionair</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>

<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">A</span><span class="o">.</span> <span class="n">Wallace</span> <span class="mi">2015</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">7</span>
<span class="n">Proportionair</span> <span class="n">regulator</span> <span class="n">control</span> <span class="o">*</span><span class="p">)</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Pressure</span> <span class="n">signal</span> <span class="n">conversion</span><span class="p">,</span> <span class="nb">max</span> <span class="n">pressure</span> <span class="n">out</span> <span class="mi">1000</span> <span class="p">(</span><span class="n">I</span> <span class="n">think</span><span class="o">...</span><span class="p">)</span> <span class="o">*</span><span class="p">)</span>
<span class="n">iq_stRegProp</span><span class="o">.</span><span class="n">iPressure</span> <span class="o">:=</span> <span class="n">REAL_TO_INT</span><span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="p">(</span><span class="n">MAX</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">iq_stRegProp</span><span class="o">.</span><span class="n">i_iPressRB</span><span class="p">))</span> <span class="o">/</span> <span class="mi">32767</span><span class="p">));</span>

<span class="n">iq_stRegProp</span><span class="o">.</span><span class="n">iSetpoint</span> <span class="o">:=</span> <span class="n">LIMIT</span><span class="p">(</span><span class="n">iq_stRegProp</span><span class="o">.</span><span class="n">iLoLimit</span><span class="p">,</span> <span class="n">iq_stRegProp</span><span class="o">.</span><span class="n">iSetpoint</span><span class="p">,</span> <span class="n">iq_stRegProp</span><span class="o">.</span><span class="n">iHiLimit</span><span class="p">);</span>

<span class="n">iq_stRegProp</span><span class="o">.</span><span class="n">q_iPressCt</span> <span class="o">:=</span> <span class="n">REAL_TO_INT</span><span class="p">(</span> <span class="p">(</span><span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">iq_stRegProp</span><span class="o">.</span><span class="n">iSetpoint</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span><span class="o">*</span><span class="mi">32767</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-proportionair">ST_Proportionair</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-propvalve">
<h2>FB_PropValve<a class="headerlink" href="#fb-propvalve" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PropValve</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_xExtIlk</span>       <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">q_xError</span>        <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stPropValve</span>     <span class="p">:</span>       <span class="n">ST_PropValveMKS253</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">xInterlock</span>      <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">eState</span> <span class="p">:</span> <span class="n">E_PropValveFBState</span> <span class="o">:=</span> <span class="n">E_PropValveFBState</span><span class="o">.</span><span class="n">Init</span><span class="p">;</span>
    <span class="n">stDiag</span>  <span class="p">:</span>       <span class="n">ST_fbDiagnostics</span><span class="p">;</span>

    <span class="n">mcPower</span> <span class="p">:</span>       <span class="n">MC_Power</span><span class="p">;</span>
    <span class="n">mcJog</span>   <span class="p">:</span>       <span class="n">MC_Jog</span><span class="p">;</span>
    <span class="n">mcReset</span> <span class="p">:</span>       <span class="n">MC_Reset</span><span class="p">;</span>
    <span class="n">mcSmoothMover</span>   <span class="p">:</span>       <span class="n">MC_SmoothMover</span><span class="p">;</span>
    <span class="n">tofLLSFilter</span>    <span class="p">:</span>       <span class="n">TOF</span> <span class="o">:=</span> <span class="p">(</span><span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#100MS);</span>
    <span class="n">tofHLSFilter</span>    <span class="p">:</span>       <span class="n">TOF</span> <span class="o">:=</span> <span class="p">(</span><span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#100MS);</span>

    <span class="n">fbPID</span>   <span class="p">:</span>       <span class="n">FB_PID_EXT</span><span class="p">;</span>

    <span class="n">AnyError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">xReady</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">rtReset</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>

    <span class="n">UpperLimit</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">2000</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Provide</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">enable</span> <span class="ow">and</span> <span class="n">limit</span> <span class="n">switch</span> <span class="n">functions</span> <span class="k">for</span> <span class="n">the</span> <span class="n">MKS</span> <span class="mi">253</span> <span class="n">valve</span> <span class="o">*</span><span class="p">)</span>

<span class="n">xInterlock</span> <span class="o">:=</span> <span class="n">stPropValve</span><span class="o">.</span><span class="n">xInterlock</span> <span class="n">AND</span> <span class="n">i_xExtIlk</span><span class="p">;</span>
<span class="n">stPropValve</span><span class="o">.</span><span class="n">xEnable</span> <span class="n">R</span><span class="o">=</span> <span class="n">NOT</span> <span class="n">xInterlock</span><span class="p">;</span>


<span class="n">rtReset</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">stPropValve</span><span class="o">.</span><span class="n">xEnable</span><span class="p">);</span>

<span class="p">(</span><span class="o">*</span> <span class="n">The</span> <span class="n">low</span> <span class="n">limit</span> <span class="n">switch</span> <span class="n">was</span> <span class="n">flakey</span><span class="p">,</span> <span class="n">I</span> <span class="n">added</span> <span class="n">the</span> <span class="n">filters</span> <span class="o">*</span><span class="p">)</span>
<span class="n">tofLLSFilter</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">stPropValve</span><span class="o">.</span><span class="n">i_LLS</span><span class="p">);</span>
<span class="n">tofHLSFilter</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">stPropValve</span><span class="o">.</span><span class="n">i_HLS</span><span class="p">);</span>
<span class="n">mcPower</span><span class="o">.</span><span class="n">Enable_Positive</span> <span class="o">:=</span> <span class="n">tofHLSFilter</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="n">mcPower</span><span class="o">.</span><span class="n">Enable_Negative</span> <span class="o">:=</span> <span class="n">tofLLSFilter</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="n">mcPower</span><span class="o">.</span><span class="n">Enable</span> <span class="o">:=</span> <span class="n">xInterlock</span> <span class="n">AND</span> <span class="n">stPropValve</span><span class="o">.</span><span class="n">xEnable</span><span class="p">;</span>
<span class="n">stPropValve</span><span class="o">.</span><span class="n">xEnabled</span> <span class="o">:=</span> <span class="n">mcPower</span><span class="o">.</span><span class="n">Enable</span><span class="p">;</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Move</span> <span class="n">the</span> <span class="n">valve</span> <span class="o">*</span><span class="p">)</span>

<span class="n">IF</span> <span class="n">AnyError</span> <span class="n">THEN</span>
    <span class="n">eState</span> <span class="o">:=</span> <span class="n">E_PropValveFBState</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
    <span class="n">stPropValve</span><span class="o">.</span><span class="n">ePVCtrlStateReq</span> <span class="o">:=</span> <span class="n">HMI_PropValveCtrlState</span><span class="o">.</span><span class="n">Hold</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">xReady</span> <span class="n">THEN</span>
    <span class="n">CASE</span> <span class="n">stPropValve</span><span class="o">.</span><span class="n">ePVCtrlStateReq</span> <span class="n">OF</span>
        <span class="n">HMI_PropValveCtrlState</span><span class="o">.</span><span class="n">Hold</span><span class="p">:</span>
            <span class="n">eState</span> <span class="o">:=</span> <span class="n">E_PropValveFBState</span><span class="o">.</span><span class="n">Hold</span><span class="p">;</span>
        <span class="n">HMI_PropValveCtrlState</span><span class="o">.</span><span class="n">Manual</span><span class="p">:</span>
            <span class="n">eState</span> <span class="o">:=</span> <span class="n">E_PropValveFBState</span><span class="o">.</span><span class="n">Manual</span><span class="p">;</span>
        <span class="n">HMI_PropValveCtrlState</span><span class="o">.</span><span class="n">Pressure</span><span class="p">:</span>
            <span class="n">eState</span> <span class="o">:=</span> <span class="n">E_PropValveFBState</span><span class="o">.</span><span class="n">Pressure</span><span class="p">;</span>
    <span class="n">END_CASE</span>
<span class="n">ELSE</span>
    <span class="n">eState</span> <span class="o">:=</span> <span class="n">E_PropValveFBState</span><span class="o">.</span><span class="n">Init</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">CASE</span> <span class="n">eState</span> <span class="n">OF</span>
    <span class="n">E_PropValveFBState</span><span class="o">.</span><span class="n">Init</span><span class="p">:</span>
        <span class="o">//</span><span class="n">This</span> <span class="n">state</span> <span class="ow">is</span> <span class="n">reached</span> <span class="n">at</span> <span class="n">startup</span> <span class="ow">and</span> <span class="n">after</span> <span class="n">a</span> <span class="n">reset</span>
        <span class="o">//</span><span class="n">It</span> <span class="n">seeks</span> <span class="n">the</span> <span class="n">closed</span> <span class="n">limit</span> <span class="n">switch</span> <span class="ow">and</span> <span class="n">moves</span> <span class="n">to</span> <span class="n">hold</span>
        <span class="n">stPropValve</span><span class="o">.</span><span class="n">ePVCtrlState</span> <span class="o">:=</span> <span class="n">HMI_PropValveCtrlState</span><span class="o">.</span><span class="n">Hold</span><span class="p">;</span>
        <span class="n">fbPID</span><span class="o">.</span><span class="n">i_Reset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">IF</span> <span class="n">NOT</span> <span class="n">tofLLSFilter</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">mcPower</span><span class="o">.</span><span class="n">Status</span> <span class="n">THEN</span>
            <span class="n">stPropValve</span><span class="o">.</span><span class="n">ePVCtrlStateReq</span> <span class="o">:=</span> <span class="n">HMI_PropValveCtrlState</span><span class="o">.</span><span class="n">Hold</span><span class="p">;</span>
            <span class="n">fbPID</span><span class="o">.</span><span class="n">i_Reset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">xReady</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">E_PropValveFBState</span><span class="o">.</span><span class="n">Hold</span><span class="p">:</span>
        <span class="n">stPropValve</span><span class="o">.</span><span class="n">ePVCtrlState</span> <span class="o">:=</span> <span class="n">HMI_PropValveCtrlState</span><span class="o">.</span><span class="n">Hold</span><span class="p">;</span>
        <span class="n">mcJog</span><span class="o">.</span><span class="n">JogForward</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">mcJog</span><span class="o">.</span><span class="n">JogBackwards</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">fbPID</span><span class="o">.</span><span class="n">i_Hold</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="n">E_PropValveFBState</span><span class="o">.</span><span class="n">Pressure</span><span class="p">:</span>
        <span class="n">stPropValve</span><span class="o">.</span><span class="n">ePVCtrlState</span> <span class="o">:=</span> <span class="n">HMI_PropValveCtrlState</span><span class="o">.</span><span class="n">Pressure</span><span class="p">;</span>

        <span class="n">fbPID</span><span class="o">.</span><span class="n">i_Hold</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">fbPID</span><span class="o">.</span><span class="n">i_Reset</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

        <span class="o">//</span><span class="n">If</span> <span class="n">the</span> <span class="n">PID</span> <span class="n">output</span> <span class="ow">is</span> <span class="n">positive</span><span class="p">,</span> <span class="n">jog</span> <span class="n">forward</span><span class="p">,</span> <span class="n">velocity</span> <span class="n">scaled</span> <span class="n">by</span> <span class="n">the</span> <span class="n">PID</span> <span class="n">output</span>
        <span class="o">//</span><span class="n">likewise</span> <span class="k">for</span> <span class="n">a</span> <span class="n">negative</span> <span class="n">PID</span> <span class="n">output</span>
        <span class="n">mcJog</span><span class="o">.</span><span class="n">JogForward</span> <span class="o">:=</span> <span class="n">fbPID</span><span class="o">.</span><span class="n">q_lrCtrlOutput</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">mcJog</span><span class="o">.</span><span class="n">JogBackwards</span> <span class="o">:=</span> <span class="n">fbPID</span><span class="o">.</span><span class="n">q_lrCtrlOutput</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">mcJog</span><span class="o">.</span><span class="n">Velocity</span> <span class="o">:=</span> <span class="n">ABS</span><span class="p">(</span><span class="n">fbPID</span><span class="o">.</span><span class="n">q_lrCtrlOutput</span><span class="p">)</span> <span class="o">*</span> <span class="n">stPropValve</span><span class="o">.</span><span class="n">lrMaxSpeed</span><span class="p">;</span>

    <span class="n">E_PropValveFBState</span><span class="o">.</span><span class="n">Manual</span><span class="p">:</span>
        <span class="n">stPropValve</span><span class="o">.</span><span class="n">ePVCtrlState</span> <span class="o">:=</span> <span class="n">HMI_PropValveCtrlState</span><span class="o">.</span><span class="n">Manual</span><span class="p">;</span>
        <span class="n">fbPID</span><span class="o">.</span><span class="n">i_Hold</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">mcSmoothMover</span><span class="o">.</span><span class="n">Enable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">mcSmoothMover</span><span class="o">.</span><span class="n">ReqAbsPos</span> <span class="o">:=</span> <span class="n">LIMIT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">INT_TO_LREAL</span><span class="p">(</span><span class="n">stPropValve</span><span class="o">.</span><span class="n">i_iPercOpenSP</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="o">*</span><span class="n">UpperLimit</span><span class="p">;</span>

    <span class="n">E_PropValveFBState</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
        <span class="o">//</span><span class="n">Purgatory</span>
        <span class="n">mcJog</span><span class="o">.</span><span class="n">JogBackwards</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">mcJog</span><span class="o">.</span><span class="n">JogForward</span>  <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">fbPID</span><span class="o">.</span><span class="n">i_Hold</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">xReady</span>      <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_CASE</span>


<span class="o">//</span><span class="n">Valve</span> <span class="n">movement</span> <span class="n">based</span> <span class="n">on</span> <span class="n">PID</span> <span class="n">output</span>
<span class="n">fbPID</span><span class="p">(</span><span class="n">i_lrSetpoint</span> <span class="o">:=</span> <span class="n">REAL_TO_LREAL</span><span class="p">(</span><span class="n">stPropValve</span><span class="o">.</span><span class="n">i_rPressSP</span><span class="p">),</span>
        <span class="n">i_lrActVal</span> <span class="o">:=</span> <span class="n">REAL_TO_LREAL</span><span class="p">(</span><span class="n">stPropValve</span><span class="o">.</span><span class="n">i_rPressRB</span><span class="p">),</span>
        <span class="n">i_stPIDParams</span> <span class="o">:=</span> <span class="n">stPropValve</span><span class="o">.</span><span class="n">stPIDParams</span><span class="p">);</span>


<span class="o">//</span><span class="n">MC</span> <span class="n">blocks</span>
<span class="n">mcPower</span><span class="p">(</span><span class="n">Axis</span><span class="o">:=</span><span class="n">stPropValve</span><span class="o">.</span><span class="n">stAxis</span><span class="p">);</span>
<span class="n">mcReset</span><span class="p">(</span><span class="n">Axis</span><span class="o">:=</span><span class="n">stPropValve</span><span class="o">.</span><span class="n">stAxis</span><span class="p">);</span>
<span class="n">mcJog</span><span class="p">(</span><span class="n">Axis</span><span class="o">:=</span><span class="n">stPropValve</span><span class="o">.</span><span class="n">stAxis</span><span class="p">,</span> <span class="n">Mode</span><span class="o">:=</span><span class="n">E_JogMode</span><span class="o">.</span><span class="n">MC_JOGMODE_CONTINOUS</span><span class="p">);</span>
<span class="n">mcSmoothMover</span><span class="p">(</span><span class="n">Axis</span><span class="o">:=</span><span class="n">stPropValve</span><span class="o">.</span><span class="n">stAxis</span><span class="p">,</span>
        <span class="n">Velocity</span><span class="o">:=</span><span class="n">stPropValve</span><span class="o">.</span><span class="n">lrMaxSpeed</span><span class="p">);</span>

<span class="n">AnyError</span> <span class="o">:=</span> <span class="n">mcJog</span><span class="o">.</span><span class="n">Error</span> <span class="n">OR</span> <span class="n">mcPower</span><span class="o">.</span><span class="n">Error</span> <span class="n">OR</span> <span class="n">fbPID</span><span class="o">.</span><span class="n">q_Error</span> <span class="n">OR</span> <span class="n">mcSmoothMover</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>

<span class="p">(</span><span class="o">*</span> <span class="n">EPICS</span> <span class="n">display</span> <span class="n">of</span> <span class="n">perc</span> <span class="nb">open</span> <span class="o">*</span><span class="p">)</span>
<span class="n">stPropValve</span><span class="o">.</span><span class="n">q_iPercOpen</span> <span class="o">:=</span> <span class="n">LREAL_TO_INT</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">stPropValve</span><span class="o">.</span><span class="n">stAxis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPos</span> <span class="o">/</span> <span class="n">UpperLimit</span><span class="p">);</span>

<span class="p">(</span><span class="o">*</span> <span class="n">EPICS</span> <span class="n">display</span> <span class="n">of</span> <span class="n">limits</span> <span class="o">*</span><span class="p">)</span>
<span class="n">stPropValve</span><span class="o">.</span><span class="n">xHLS</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">tofHLSFilter</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="n">stPropValve</span><span class="o">.</span><span class="n">xLLS</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">tofLLSFilter</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-propvalvefbstate">E_PropValveFBState</a></p></li>
<li><p><a class="reference internal" href="#fb-pid-ext">FB_PID_EXT</a></p></li>
<li><p><a class="reference internal" href="#hmi-propvalvectrlstate">HMI_PropValveCtrlState</a></p></li>
<li><p><a class="reference internal" href="#mc-smoothmover">MC_SmoothMover</a></p></li>
<li><p><a class="reference internal" href="#st-propvalvemks253">ST_PropValveMKS253</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-regulator">
<h2>FB_Regulator<a class="headerlink" href="#fb-regulator" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_Regulator</span>
<span class="n">VAR_INPUT</span>
    <span class="n">iI</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">lrVelocity</span>      <span class="p">:</span>       <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">360</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">q_asResult</span><span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">1..20</span><span class="p">]</span> <span class="n">OF</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">q_xError</span>    <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">iq_stRegulator</span>  <span class="p">:</span>       <span class="n">ST_Regulator</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>


<span class="n">mcPower</span>     <span class="p">:</span>       <span class="n">MC_Power</span><span class="p">;</span>
<span class="n">mcSetHome</span>   <span class="p">:</span>       <span class="n">MC_SetPosition</span><span class="p">;</span>
<span class="n">mcReset</span>     <span class="p">:</span>       <span class="n">MC_Reset</span><span class="p">;</span>
<span class="n">mcMoveAbsolute</span> <span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..2</span><span class="p">]</span> <span class="n">OF</span> <span class="n">MC_MoveAbsolute</span><span class="p">;</span>
<span class="n">mcStatus</span> <span class="p">:</span> <span class="n">MC_ReadStatus</span><span class="p">;</span>

<span class="n">mcHalt</span>      <span class="p">:</span>       <span class="n">MC_Halt</span><span class="p">;</span>

    <span class="n">iPressDiff</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">iTolerance</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">50</span><span class="p">;</span>
    <span class="n">xMoveOK</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">iStep</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>

    <span class="n">indexResult</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="n">xInitComplete</span>   <span class="p">:</span>       <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

    <span class="n">ftBackToAuto</span>    <span class="p">:</span>       <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="n">iPercSPOld</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
    <span class="n">imcBlockIndex</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">imcBlockIndexPrev</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>

    <span class="n">rtEnable</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Regulator</span> <span class="n">Function</span> <span class="n">Block</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Alex</span> <span class="n">Wallace</span><span class="p">,</span> <span class="mi">2014</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">16</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Modified</span> <span class="ow">in</span> <span class="mf">2.5.3</span> <span class="n">to</span> <span class="n">remove</span> <span class="nb">all</span> <span class="n">pressure</span> <span class="n">SP</span>  <span class="n">based</span> <span class="n">code</span> <span class="o">*</span><span class="p">)</span>

<span class="n">rtEnable</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">iq_stRegulator</span><span class="o">.</span><span class="n">xRegEnab</span><span class="p">);</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Regulator</span> <span class="n">Pressure</span> <span class="n">Calculation</span> <span class="o">*</span><span class="p">)</span>
<span class="n">iq_stRegulator</span><span class="o">.</span><span class="n">wInPress</span> <span class="o">:=</span> <span class="n">LIMIT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">F_rPressure</span><span class="p">(</span><span class="n">iRawVoltage</span> <span class="o">:=</span> <span class="n">iq_stRegulator</span><span class="o">.</span><span class="n">i_iRawInPress</span><span class="p">),</span> <span class="mi">10000</span><span class="p">);</span>
<span class="n">iq_stRegulator</span><span class="o">.</span><span class="n">wOutPress</span> <span class="o">:=</span> <span class="n">LIMIT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">F_rPressure</span><span class="p">(</span><span class="n">iRawVoltage</span> <span class="o">:=</span> <span class="n">iq_stRegulator</span><span class="o">.</span><span class="n">i_iRawOutPress</span><span class="p">),</span> <span class="mi">10000</span><span class="p">);</span>


<span class="p">(</span><span class="o">*</span> <span class="n">Basic</span> <span class="n">regulator</span> <span class="n">interlocking</span> <span class="o">*</span><span class="p">)</span>


<span class="p">(</span><span class="o">*</span> <span class="n">Check</span> <span class="k">for</span> <span class="n">regulator</span> <span class="n">enable</span> <span class="o">*</span><span class="p">)</span>
<span class="n">xMoveOK</span> <span class="o">:=</span> <span class="n">iq_stRegulator</span><span class="o">.</span><span class="n">xRegEnab</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">xMoveOK</span> <span class="n">THEN</span>
    <span class="p">(</span><span class="o">*</span><span class="n">iq_stRegulator</span><span class="o">.</span><span class="n">wPressSP</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="ow">not</span> <span class="n">preferred</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">iq_stRegulator</span><span class="o">.</span><span class="n">xRegEnab</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">add</span> <span class="n">motor</span> <span class="n">error</span> <span class="n">here</span> <span class="o">*</span><span class="p">)</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">q_xError</span> <span class="n">THEN</span>
    <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">rtEnable</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">xInitComplete</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">xInitComplete</span> <span class="n">THEN</span>
    <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">3000</span><span class="p">;</span>
<span class="n">END_IF</span>


<span class="n">CASE</span> <span class="n">iStep</span> <span class="n">OF</span>
    <span class="mi">0</span><span class="p">:</span> <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="mi">10</span><span class="p">:</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">Start</span> <span class="n">by</span> <span class="n">initializing</span> <span class="n">the</span> <span class="n">motor</span> <span class="n">axis</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">mcPower</span><span class="o">.</span><span class="n">Enable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">iq_stRegulator</span><span class="o">.</span><span class="n">lrUpperLimPos</span> <span class="o">:=</span> <span class="mi">2887</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">mcPower</span><span class="o">.</span><span class="n">Status</span> <span class="n">THEN</span>
        <span class="n">xInitComplete</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">q_asResult</span><span class="p">[</span><span class="n">indexResult</span><span class="p">]</span> <span class="o">:=</span> <span class="s1">&#39;Motor init success&#39;</span><span class="p">;</span>
        <span class="n">indexResult</span> <span class="o">:=</span> <span class="n">indexResult</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">3000</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">mcPower</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
        <span class="n">mcPower</span><span class="o">.</span><span class="n">Enable</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
        <span class="n">q_xError</span>    <span class="o">:=</span>      <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">q_asResult</span><span class="p">[</span><span class="n">indexResult</span><span class="p">]</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Initilizing regulator motor in step 10 failed with error code: &#39;</span><span class="p">,</span> <span class="n">UDINT_TO_STRING</span><span class="p">(</span><span class="n">mcPower</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">));</span>
        <span class="n">indexResult</span> <span class="o">:=</span> <span class="n">indexResult</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">END_IF</span>

    <span class="o">//</span><span class="n">Knob</span> <span class="n">controls</span>
    <span class="mi">3000</span><span class="p">:</span>

    <span class="n">IF</span> <span class="n">iq_stRegulator</span><span class="o">.</span><span class="n">i_iPercSP</span> <span class="o">&lt;&gt;</span> <span class="n">iPercSPOld</span>  <span class="n">AND</span> <span class="n">xMoveOK</span> <span class="n">THEN</span>
        <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">imcBlockIndex</span><span class="p">]</span><span class="o">.</span><span class="n">Execute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">imcBlockIndex</span> <span class="o">:=</span> <span class="n">imcBlockIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">IF</span> <span class="n">imcBlockIndex</span> <span class="o">&gt;</span><span class="mi">2</span> <span class="n">THEN</span> <span class="n">imcBlockIndex</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">END_IF</span>
        <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">imcBlockIndex</span><span class="p">]</span><span class="o">.</span><span class="n">Position</span> <span class="o">:=</span> <span class="n">LIMIT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">UINT_TO_LREAL</span><span class="p">(</span><span class="n">iq_stRegulator</span><span class="o">.</span><span class="n">i_iPercSP</span><span class="p">)</span> <span class="o">*</span> <span class="n">iq_stRegulator</span><span class="o">.</span><span class="n">lrUpperLimPos</span><span class="o">/</span><span class="mi">65535</span><span class="p">,</span> <span class="n">MAX</span><span class="p">(</span><span class="n">iq_stRegulator</span><span class="o">.</span><span class="n">lrUpperLimPos</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>
        <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">imcBlockIndex</span><span class="p">]</span><span class="o">.</span><span class="n">Execute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">iPercSPOld</span> <span class="o">:=</span> <span class="n">iq_stRegulator</span><span class="o">.</span><span class="n">i_iPercSP</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">imcBlockIndex</span><span class="p">]</span><span class="o">.</span><span class="n">Done</span> <span class="ow">or</span> <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">imcBlockIndex</span><span class="p">]</span><span class="o">.</span><span class="n">CommandAborted</span> <span class="ow">or</span> <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">imcBlockIndex</span><span class="p">]</span><span class="o">.</span><span class="n">Busy</span> <span class="ow">or</span> <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">imcBlockIndex</span><span class="p">]</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
        <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">imcBlockIndex</span><span class="p">]</span><span class="o">.</span><span class="n">Execute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>

    <span class="mi">9000</span><span class="p">:</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">Error</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">mcReset</span><span class="o">.</span><span class="n">Execute</span> <span class="o">:=</span> <span class="n">iq_stRegulator</span><span class="o">.</span><span class="n">xRegEnab</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">mcReset</span><span class="o">.</span><span class="n">Done</span> <span class="n">THEN</span>
        <span class="n">q_xError</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">mcReset</span><span class="o">.</span><span class="n">Execute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">iStep</span><span class="o">:=</span><span class="mi">10</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="n">END_CASE</span>

<span class="o">//</span><span class="n">Reset</span> <span class="n">the</span> <span class="n">debugging</span> <span class="n">index</span>
<span class="n">IF</span> <span class="n">indexResult</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="n">THEN</span> <span class="n">indexResult</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Regulator</span> <span class="n">Percentage</span> <span class="n">Open</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Calculate</span> <span class="n">the</span> <span class="n">regulator</span> <span class="n">percentage</span> <span class="nb">open</span><span class="p">,</span> <span class="n">based</span> <span class="n">on</span> <span class="mf">6.5</span> <span class="n">turns</span> <span class="n">to</span> <span class="n">fully</span> <span class="nb">open</span> <span class="o">*</span><span class="p">)</span>

<span class="n">iq_stRegulator</span><span class="o">.</span><span class="n">wPercentageOpen</span> <span class="o">:=</span> <span class="n">LREAL_TO_WORD</span><span class="p">(</span> <span class="p">(</span><span class="n">iq_stRegulator</span><span class="o">.</span><span class="n">stRegulatorMotor</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPos</span> <span class="o">/</span> <span class="n">MAX</span><span class="p">(</span><span class="n">iq_stRegulator</span><span class="o">.</span><span class="n">lrUpperLimPos</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span><span class="p">);</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Run</span> <span class="n">the</span> <span class="n">mc</span> <span class="n">blocks</span> <span class="o">*</span><span class="p">)</span>
<span class="n">iq_stRegulator</span><span class="o">.</span><span class="n">stRegulatorMotor</span><span class="p">();</span>
<span class="n">ActPower</span><span class="p">();</span>

<span class="n">mcSetHome</span><span class="p">(</span><span class="n">Execute</span><span class="o">:=</span><span class="n">NOT</span><span class="p">(</span><span class="n">iq_stRegulator</span><span class="o">.</span><span class="n">xRegLoLS</span><span class="p">)</span> <span class="n">AND</span> <span class="n">iq_stRegulator</span><span class="o">.</span><span class="n">stRegulatorMotor</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">StandStill</span><span class="p">,</span> <span class="n">Axis</span><span class="o">:=</span><span class="n">iq_stRegulator</span><span class="o">.</span><span class="n">stRegulatorMotor</span><span class="p">,</span> <span class="n">Position</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Mode</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">iq_stRegulator</span><span class="o">.</span><span class="n">xRegHiLS</span> <span class="n">THEN</span> <span class="n">iq_stRegulator</span><span class="o">.</span><span class="n">lrUpperLimPos</span> <span class="o">:=</span> <span class="n">iq_stRegulator</span><span class="o">.</span><span class="n">stRegulatorMotor</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">ActPos</span><span class="p">;</span> <span class="n">END_IF</span>
<span class="n">mcReset</span><span class="p">(</span><span class="n">Axis</span><span class="o">:=</span><span class="n">iq_stRegulator</span><span class="o">.</span><span class="n">stRegulatorMotor</span><span class="p">);</span>

<span class="n">FOR</span> <span class="n">iI</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="mi">2</span> <span class="n">DO</span>
<span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">iI</span><span class="p">](</span><span class="n">Axis</span> <span class="o">:=</span> <span class="n">iq_stRegulator</span><span class="o">.</span><span class="n">stRegulatorMotor</span><span class="p">,</span> <span class="n">Velocity</span><span class="o">:=</span><span class="n">iq_stRegulator</span><span class="o">.</span><span class="n">lrVelocity</span><span class="p">,</span> <span class="n">BufferMode</span><span class="o">:=</span><span class="n">MC_Aborting</span><span class="p">);</span>
<span class="n">END_FOR</span>

<span class="n">IF</span> <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Error</span> <span class="n">OR</span> <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
    <span class="n">q_xError</span>        <span class="o">:=</span>      <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Execute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">Execute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">q_asResult</span><span class="p">[</span><span class="n">indexResult</span><span class="p">]</span> <span class="o">:=</span> <span class="s1">&#39;Error occured with motion blocks&#39;</span><span class="p">;</span>
    <span class="n">indexResult</span> <span class="o">:=</span> <span class="n">indexResult</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">mcPower</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
    <span class="n">q_xError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">q_asResult</span><span class="p">[</span><span class="n">indexResult</span><span class="p">]</span> <span class="o">:=</span> <span class="n">concat</span><span class="p">(</span><span class="s1">&#39;mcPower block error: &#39;</span><span class="p">,</span> <span class="n">UDINT_TO_STRING</span><span class="p">(</span><span class="n">mcPower</span><span class="o">.</span><span class="n">ErrorID</span><span class="p">));</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">ActPower</span><span class="p">:</span>

<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#f-rpressure">F_rPressure</a></p></li>
<li><p><a class="reference internal" href="#st-regulator">ST_Regulator</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-selectorm3">
<h2>FB_SelectorM3<a class="headerlink" href="#fb-selectorm3" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_SelectorM3</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>

<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">IO</span>
     <span class="s1">&#39;}</span>
    <span class="n">stBaseIO</span> <span class="p">:</span> <span class="n">ST_M3DeviceBaseIO</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span>
     <span class="s1">&#39;}</span>
    <span class="n">stSelector</span>      <span class="p">:</span>       <span class="n">ST_SelectorM3</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Shakers</span>
        <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
            <span class="n">pv</span><span class="p">:</span> <span class="n">Shaker</span><span class="p">:</span><span class="mi">01</span>
         <span class="s1">&#39;}</span>
        <span class="n">stShaker01</span>  <span class="p">:</span>       <span class="n">ST_Shaker</span><span class="p">;</span>
        <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
            <span class="n">pv</span><span class="p">:</span> <span class="n">Shaker</span><span class="p">:</span><span class="mi">02</span>
         <span class="s1">&#39;}</span>
        <span class="n">stShaker02</span>  <span class="p">:</span>       <span class="n">ST_Shaker</span><span class="p">;</span>
        <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
            <span class="n">pv</span><span class="p">:</span> <span class="n">Shaker</span><span class="p">:</span><span class="mi">03</span>
         <span class="s1">&#39;}</span>
        <span class="n">stShaker03</span>  <span class="p">:</span>       <span class="n">ST_Shaker</span><span class="p">;</span>
        <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
            <span class="n">pv</span><span class="p">:</span> <span class="n">Shaker</span><span class="p">:</span><span class="mi">04</span>
         <span class="s1">&#39;}</span>
        <span class="n">stShaker04</span>  <span class="p">:</span>       <span class="n">ST_Shaker</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Vici</span> <span class="n">valves</span>
        <span class="n">fbSelectorSync</span>      <span class="p">:</span>       <span class="n">FB_SelectorSync</span><span class="p">;</span>

        <span class="n">afbViciDriver</span> <span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">1..2</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_ViciDriver</span><span class="p">;</span>

        <span class="n">fbViciSerial</span>  <span class="p">:</span>   <span class="n">FB_SerialCommWrapper</span><span class="p">;</span>
        <span class="n">stViciSerial</span>  <span class="p">:</span>   <span class="n">ST_SerialComm</span><span class="p">;</span>


    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Sensirion</span>
     <span class="s1">&#39;}</span>
    <span class="n">astSelFM</span>        <span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..2</span><span class="p">]</span> <span class="n">OF</span>        <span class="n">ST_SensirionFM</span><span class="p">;</span> <span class="o">//</span><span class="n">Address</span> <span class="mi">1</span> <span class="ow">is</span> <span class="n">low</span> <span class="n">flow</span><span class="p">,</span> <span class="n">address</span> <span class="mi">2</span> <span class="ow">is</span> <span class="n">high</span> <span class="n">flow</span><span class="p">,</span> <span class="n">low</span> <span class="n">flow</span> <span class="ow">is</span> <span class="n">mapped</span> <span class="n">to</span> <span class="n">M2</span> <span class="n">flow</span>

    <span class="n">afbSensirionDriver</span>      <span class="p">:</span>       <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">1..2</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_SensirionDriver</span><span class="p">;</span>

    <span class="n">fbSensSerial</span> <span class="p">:</span> <span class="n">FB_SerialCommWrapper</span><span class="p">;</span>
    <span class="n">stSensSerial</span> <span class="p">:</span> <span class="n">ST_SerialComm</span><span class="p">;</span>

    <span class="n">stStatus</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">udCount</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>

    <span class="n">tofReset</span><span class="p">:</span> <span class="n">TOF</span><span class="p">;</span>

    <span class="n">iIdOld</span>  <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>

    <span class="n">viciIndex</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">fmIndex</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="o">//</span><span class="n">stComIn_EP6002P1</span>              <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span>  <span class="p">:</span>       <span class="n">EL6inData22B</span> <span class="p">(</span><span class="o">*</span><span class="n">KL6inData22B</span><span class="o">*</span><span class="p">);</span>
    <span class="o">//</span><span class="n">stComOut_EP6002P1</span>             <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span>  <span class="p">:</span>       <span class="n">EL6outData22B</span> <span class="p">(</span><span class="o">*</span><span class="n">KL6outData22B</span><span class="o">*</span><span class="p">);</span>

<span class="n">END_VAR</span>
<span class="o">//</span><span class="n">Flowmeters</span>
<span class="o">//////////////////////////////////////</span>
<span class="n">Sensirion</span><span class="p">();</span>
<span class="o">//</span><span class="n">Bronkhorst</span><span class="p">();</span>

<span class="o">//</span><span class="n">Valve</span> <span class="n">control</span>
<span class="o">///////////////////////////////////</span>
    <span class="n">fbSelectorSync</span><span class="p">(</span><span class="n">iq_stSelector</span><span class="o">:=</span><span class="n">stSelector</span><span class="p">);</span>
    <span class="n">stSelector</span><span class="o">.</span><span class="n">astViciVlvCtrl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">iReqPos</span> <span class="o">:=</span> <span class="n">LIMIT</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">stSelector</span><span class="o">.</span><span class="n">iVici1ReqPos</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
    <span class="n">stSelector</span><span class="o">.</span><span class="n">astViciVlvCtrl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">iReqPos</span> <span class="o">:=</span> <span class="n">LIMIT</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">stSelector</span><span class="o">.</span><span class="n">iVici2ReqPos</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
    <span class="n">ViciDrivers</span><span class="p">();</span>

    <span class="o">//</span><span class="k">for</span> <span class="n">epics</span> <span class="n">readback</span> <span class="n">to</span> <span class="n">be</span> <span class="n">consistent</span>
    <span class="n">IF</span> <span class="n">stSelector</span><span class="o">.</span><span class="n">xResSyncd</span> <span class="n">THEN</span> <span class="n">stSelector</span><span class="o">.</span><span class="n">iSyncResPos</span> <span class="o">:=</span> <span class="n">stSelector</span><span class="o">.</span><span class="n">astViciVlvStatus</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">iCurrPos</span><span class="p">;</span> <span class="n">END_IF</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Shakers</span> <span class="o">*</span><span class="p">)</span>
<span class="n">stShaker01</span><span class="o">.</span><span class="n">q_xPwrDO</span> <span class="o">:=</span> <span class="n">stShaker01</span><span class="o">.</span><span class="n">i_xEpics</span><span class="p">;</span>
<span class="n">stShaker02</span><span class="o">.</span><span class="n">q_xPwrDO</span> <span class="o">:=</span> <span class="n">stShaker02</span><span class="o">.</span><span class="n">i_xEpics</span><span class="p">;</span>
<span class="n">stShaker03</span><span class="o">.</span><span class="n">q_xPwrDO</span> <span class="o">:=</span> <span class="n">stShaker03</span><span class="o">.</span><span class="n">i_xEpics</span><span class="p">;</span>
<span class="n">stShaker04</span><span class="o">.</span><span class="n">q_xPwrDO</span> <span class="o">:=</span> <span class="n">stShaker04</span><span class="o">.</span><span class="n">i_xEpics</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">Sensirion</span><span class="p">:</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Sensirion</span> <span class="n">Flowmeter</span> <span class="n">driver</span> <span class="n">encapsulation</span><span class="o">*</span><span class="p">)</span>

<span class="p">(</span><span class="o">*</span> <span class="n">M3</span> <span class="n">selector</span> <span class="n">has</span> <span class="n">two</span> <span class="n">flow</span> <span class="n">meters</span><span class="o">.</span> <span class="n">Sample</span> <span class="ow">and</span> <span class="n">sheath</span><span class="o">.</span> <span class="n">Sample</span> <span class="ow">is</span> <span class="s2">&quot;low flow.&quot;</span><span class="o">*</span><span class="p">)</span>

<span class="n">astSelFM</span><span class="p">[</span><span class="n">fmIndex</span><span class="p">]</span><span class="o">.</span><span class="n">stCtrl</span><span class="o">.</span><span class="n">xReset</span> <span class="o">:=</span> <span class="n">astSelFM</span><span class="p">[</span><span class="n">fmIndex</span><span class="p">]</span><span class="o">.</span><span class="n">xFMReset</span><span class="p">;</span>
<span class="n">astSelFM</span><span class="p">[</span><span class="n">fmIndex</span><span class="p">]</span><span class="o">.</span><span class="n">stCtrl</span><span class="o">.</span><span class="n">xCalMode</span> <span class="o">:=</span> <span class="n">astSelFM</span><span class="p">[</span><span class="n">fmIndex</span><span class="p">]</span><span class="o">.</span><span class="n">xFMModeReq</span><span class="p">;</span>
<span class="n">astSelFM</span><span class="p">[</span><span class="n">fmIndex</span><span class="p">]</span><span class="o">.</span><span class="n">stCtrl</span><span class="o">.</span><span class="n">bAdr</span> <span class="o">:=</span> <span class="n">INT_TO_BYTE</span><span class="p">(</span><span class="n">fmIndex</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

<span class="n">afbSensirionDriver</span><span class="p">[</span><span class="n">fmIndex</span><span class="p">](</span>
    <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">i_tTimeOut</span><span class="o">:=</span> <span class="n">t</span><span class="c1">#1s,</span>
    <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">stSensSerial</span><span class="o">.</span><span class="n">RxBuffer</span><span class="p">,</span>
    <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">stSensSerial</span><span class="o">.</span><span class="n">TxBuffer</span><span class="p">,</span>
    <span class="n">q_stStatus</span><span class="o">=&gt;</span><span class="n">astSelFM</span><span class="p">[</span><span class="n">fmIndex</span><span class="p">]</span><span class="o">.</span><span class="n">stStat</span><span class="p">,</span>
    <span class="n">i_stControl</span><span class="o">:=</span><span class="n">astSelFM</span><span class="p">[</span><span class="n">fmIndex</span><span class="p">]</span><span class="o">.</span><span class="n">stCtrl</span><span class="p">);</span>

<span class="n">IF</span> <span class="n">afbSensirionDriver</span><span class="p">[</span><span class="n">fmIndex</span><span class="p">]</span><span class="o">.</span><span class="n">q_xDone</span> <span class="n">OR</span>
    <span class="n">afbSensirionDriver</span><span class="p">[</span><span class="n">fmIndex</span><span class="p">]</span><span class="o">.</span><span class="n">q_xError</span> <span class="n">OR</span>
    <span class="n">afbSensirionDriver</span><span class="p">[</span><span class="n">fmIndex</span><span class="p">]</span><span class="o">.</span><span class="n">q_xTimeout</span> <span class="n">THEN</span>

    <span class="n">astSelFM</span><span class="p">[</span><span class="n">fmIndex</span><span class="p">]</span><span class="o">.</span><span class="n">rFlow</span> <span class="o">:=</span> <span class="n">astSelFM</span><span class="p">[</span><span class="n">fmIndex</span><span class="p">]</span><span class="o">.</span><span class="n">stStat</span><span class="o">.</span><span class="n">rFlow</span><span class="p">;</span>
    <span class="n">astSelFM</span><span class="p">[</span><span class="n">fmIndex</span><span class="p">]</span><span class="o">.</span><span class="n">xFMOoR</span> <span class="o">:=</span> <span class="n">astSelFM</span><span class="p">[</span><span class="n">fmIndex</span><span class="p">]</span><span class="o">.</span><span class="n">stStat</span><span class="o">.</span><span class="n">xOoR</span><span class="p">;</span>
    <span class="n">astSelFM</span><span class="p">[</span><span class="n">fmIndex</span><span class="p">]</span><span class="o">.</span><span class="n">xFlowValid</span> <span class="o">:=</span> <span class="n">astSelFM</span><span class="p">[</span><span class="n">fmIndex</span><span class="p">]</span><span class="o">.</span><span class="n">stStat</span><span class="o">.</span><span class="n">xFlowValid</span><span class="p">;</span>
    <span class="n">astSelFM</span><span class="p">[</span><span class="n">fmIndex</span><span class="p">]</span><span class="o">.</span><span class="n">eFMState</span> <span class="o">:=</span> <span class="n">astSelFM</span><span class="p">[</span><span class="n">fmIndex</span><span class="p">]</span><span class="o">.</span><span class="n">stStat</span><span class="o">.</span><span class="n">iState</span><span class="p">;</span>
    <span class="n">astSelFM</span><span class="p">[</span><span class="n">fmIndex</span><span class="p">]</span><span class="o">.</span><span class="n">xFMModeRb</span> <span class="o">:=</span> <span class="n">astSelFM</span><span class="p">[</span><span class="n">fmIndex</span><span class="p">]</span><span class="o">.</span><span class="n">stStat</span><span class="o">.</span><span class="n">xFMMode</span><span class="p">;</span>

    <span class="o">//</span><span class="n">M3</span> <span class="n">flows</span>
    <span class="n">IF</span> <span class="n">fmIndex</span> <span class="o">=</span> <span class="mi">1</span> <span class="n">THEN</span>
        <span class="n">stSelector</span><span class="o">.</span><span class="n">rLowFlow</span> <span class="o">:=</span> <span class="n">astSelFM</span><span class="p">[</span><span class="n">fmIndex</span><span class="p">]</span><span class="o">.</span><span class="n">stStat</span><span class="o">.</span><span class="n">rFlow</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">fmIndex</span> <span class="o">=</span> <span class="mi">2</span> <span class="n">THEN</span>
        <span class="n">stSelector</span><span class="o">.</span><span class="n">rHighFlow</span> <span class="o">:=</span> <span class="n">astSelFM</span><span class="p">[</span><span class="n">fmIndex</span><span class="p">]</span><span class="o">.</span><span class="n">stStat</span><span class="o">.</span><span class="n">rFlow</span><span class="p">;</span>
    <span class="n">END_IF</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="n">function</span> <span class="k">for</span> <span class="nb">next</span> <span class="n">time</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">afbSensirionDriver</span><span class="p">[</span><span class="n">fmIndex</span><span class="p">]</span><span class="o">.</span><span class="n">Reset</span><span class="p">();</span>

    <span class="n">fmIndex</span> <span class="o">:=</span> <span class="n">fmIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">fmIndex</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="n">THEN</span> <span class="n">fmIndex</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>       <span class="n">END_IF</span>
<span class="n">END_IF</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">SerialComm</span><span class="p">:</span>
<span class="n">fbSensSerial</span><span class="p">(</span><span class="n">stSerialComm</span> <span class="o">:=</span> <span class="n">stSensSerial</span><span class="p">);</span>

<span class="n">fbViciSerial</span><span class="p">(</span><span class="n">stSerialComm</span> <span class="o">:=</span> <span class="n">stViciSerial</span><span class="p">);</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">ViciDrivers</span><span class="p">:</span>
<span class="n">stSelector</span><span class="o">.</span><span class="n">astViciVlvCtrl</span><span class="p">[</span><span class="n">viciIndex</span><span class="p">]</span><span class="o">.</span><span class="n">iAddress</span> <span class="o">:=</span> <span class="n">viciIndex</span><span class="p">;</span>

<span class="n">afbViciDriver</span><span class="p">[</span><span class="n">viciIndex</span><span class="p">](</span>
    <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">i_tTimeOut</span><span class="o">:=</span> <span class="n">t</span><span class="c1">#10s,</span>
    <span class="n">i_stControl</span><span class="o">:=</span> <span class="n">stSelector</span><span class="o">.</span><span class="n">astViciVlvCtrl</span><span class="p">[</span><span class="n">viciIndex</span><span class="p">],</span>
    <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">stViciSerial</span><span class="o">.</span><span class="n">RxBuffer</span><span class="p">,</span>
    <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">stViciSerial</span><span class="o">.</span><span class="n">TxBuffer</span><span class="p">,</span>
    <span class="n">q_stStatus</span><span class="o">=&gt;</span><span class="n">stSelector</span><span class="o">.</span><span class="n">astViciVlvStatus</span><span class="p">[</span><span class="n">viciIndex</span><span class="p">]);</span>

<span class="n">IF</span>  <span class="n">afbViciDriver</span><span class="p">[</span><span class="n">viciIndex</span><span class="p">]</span><span class="o">.</span><span class="n">q_xDone</span> <span class="n">OR</span>
    <span class="n">afbViciDriver</span><span class="p">[</span><span class="n">viciIndex</span><span class="p">]</span><span class="o">.</span><span class="n">q_xError</span> <span class="n">OR</span>
    <span class="n">afbViciDriver</span><span class="p">[</span><span class="n">viciIndex</span><span class="p">]</span><span class="o">.</span><span class="n">q_xTimeout</span> <span class="n">THEN</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="n">function</span> <span class="k">for</span> <span class="nb">next</span> <span class="n">time</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">afbViciDriver</span><span class="p">[</span><span class="n">viciIndex</span><span class="p">](</span><span class="n">i_xExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
        <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">stViciSerial</span><span class="o">.</span><span class="n">RxBuffer</span><span class="p">,</span>
        <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">stViciSerial</span><span class="o">.</span><span class="n">TxBuffer</span><span class="p">);</span>

    <span class="n">viciIndex</span> <span class="o">:=</span> <span class="n">viciIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">viciIndex</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="n">THEN</span> <span class="n">viciIndex</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">END_IF</span>

<span class="n">END_IF</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-selectorsync">FB_SelectorSync</a></p></li>
<li><p><a class="reference internal" href="#fb-sensiriondriver">FB_SensirionDriver</a></p></li>
<li><p><a class="reference internal" href="#fb-serialcommwrapper">FB_SerialCommWrapper</a></p></li>
<li><p><a class="reference internal" href="#fb-vicidriver">FB_ViciDriver</a></p></li>
<li><p><a class="reference internal" href="#st-m3devicebaseio">ST_M3DeviceBaseIO</a></p></li>
<li><p><a class="reference internal" href="#st-selectorm3">ST_SelectorM3</a></p></li>
<li><p><a class="reference internal" href="#st-sensirionfm">ST_SensirionFM</a></p></li>
<li><p><a class="reference internal" href="#st-serialcomm">ST_SerialComm</a></p></li>
<li><p><a class="reference internal" href="#st-shaker">ST_Shaker</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-selectorsync">
<h2>FB_SelectorSync<a class="headerlink" href="#fb-selectorsync" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_SelectorSync</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">iq_stSelector</span>   <span class="p">:</span>       <span class="n">ST_SelectorM3</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">tofResSyncd</span> <span class="p">:</span> <span class="n">TOF</span><span class="p">;</span>
    <span class="n">rtResLocked</span>     <span class="p">:</span>       <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">rsResLocked</span>     <span class="p">:</span>       <span class="n">RS</span><span class="p">;</span>

    <span class="n">rtResLock</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">rtResUnlock</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Selector</span> <span class="n">valve</span> <span class="n">sync</span> <span class="n">FB</span> <span class="k">for</span> <span class="n">vici</span> <span class="n">valves</span> <span class="o">*</span><span class="p">)</span>



<span class="p">(</span><span class="o">*</span> <span class="n">Check</span> <span class="k">if</span> <span class="n">both</span> <span class="n">valves</span> <span class="n">are</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">same</span> <span class="n">position</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Should</span> <span class="n">probably</span> <span class="n">add</span> <span class="n">something</span> <span class="n">to</span> <span class="n">the</span> <span class="n">driver</span> <span class="n">to</span> <span class="n">check</span> <span class="k">if</span> <span class="n">we</span> <span class="n">are</span> <span class="ow">in</span> <span class="n">motion</span><span class="o">*</span><span class="p">)</span>
<span class="n">tofResSyncd</span><span class="o">.</span><span class="n">IN</span> <span class="o">:=</span> <span class="p">(</span><span class="n">iq_stSelector</span><span class="o">.</span><span class="n">astViciVlvStatus</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">iCurrPos</span> <span class="o">=</span> <span class="n">iq_stSelector</span><span class="o">.</span><span class="n">astViciVlvStatus</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">iCurrPos</span> <span class="p">)</span> <span class="n">AND</span>
            <span class="p">(</span><span class="n">iq_stSelector</span><span class="o">.</span><span class="n">astViciVlvStatus</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">xPosValid</span>  <span class="p">)</span> <span class="n">AND</span> <span class="p">(</span><span class="n">iq_stSelector</span><span class="o">.</span><span class="n">astViciVlvStatus</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">xPosValid</span><span class="p">);</span> <span class="p">(</span><span class="o">*</span> <span class="n">Check</span> <span class="k">for</span> <span class="n">valid</span> <span class="n">position</span> <span class="n">rb</span> <span class="o">*</span><span class="p">)</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Delay</span> <span class="n">the</span> <span class="n">loss</span> <span class="n">of</span> <span class="n">ResSyncd</span> <span class="n">so</span> <span class="n">the</span> <span class="n">valves</span> <span class="n">can</span> <span class="n">both</span> <span class="n">be</span> <span class="n">queried</span> <span class="n">before</span> <span class="n">overriding</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Using</span> <span class="n">a</span> <span class="n">tof</span><span class="p">,</span> <span class="n">but</span> <span class="n">you</span> <span class="n">can</span> <span class="n">also</span> <span class="n">check</span> <span class="n">that</span> <span class="n">both</span> <span class="n">valves</span> <span class="n">have</span> <span class="n">been</span> <span class="n">queried</span> <span class="o">*</span><span class="p">)</span>
<span class="n">tofResSyncd</span><span class="p">(</span><span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#10S);</span>
<span class="n">iq_stSelector</span><span class="o">.</span><span class="n">xResSyncd</span> <span class="o">:=</span> <span class="n">tofResSyncd</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>

<span class="o">//</span><span class="n">Set</span><span class="p">,</span> <span class="n">reset</span> <span class="n">of</span> <span class="n">valve</span> <span class="n">lock</span>
<span class="n">rtResLock</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">iq_stSelector</span><span class="o">.</span><span class="n">xResLock</span><span class="p">);</span>
<span class="n">rtResUnlock</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">iq_stSelector</span><span class="o">.</span><span class="n">xResUnlock</span><span class="p">);</span>
<span class="n">rsResLocked</span><span class="p">(</span><span class="nb">set</span><span class="o">:=</span><span class="n">rtResLock</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">g_xFirstPass</span><span class="p">,</span> <span class="n">reset1</span><span class="o">:=</span><span class="n">rtResUnlock</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="n">iq_stSelector</span><span class="o">.</span><span class="n">xResSyncd</span><span class="p">);</span>
<span class="n">iq_stSelector</span><span class="o">.</span><span class="n">xResLocked</span> <span class="o">:=</span> <span class="n">rsResLocked</span><span class="o">.</span><span class="n">Q1</span><span class="p">;</span>


<span class="p">(</span><span class="o">*</span> <span class="n">If</span> <span class="n">valve</span> <span class="n">lock</span> <span class="n">just</span> <span class="n">became</span> <span class="n">active</span><span class="p">,</span> <span class="nb">set</span> <span class="n">the</span> <span class="n">SyncReqPos</span> <span class="n">to</span> <span class="n">current</span> <span class="n">locked</span> <span class="n">position</span> <span class="o">*</span><span class="p">)</span>
<span class="n">rtResLocked</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">iq_stSelector</span><span class="o">.</span><span class="n">xResLocked</span><span class="p">);</span>
<span class="p">(</span><span class="o">*</span>
<span class="n">IF</span> <span class="n">rtResLocked</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">iq_stSelector</span><span class="o">.</span><span class="n">iSyncReqPos</span> <span class="o">:=</span> <span class="n">iq_stSelector</span><span class="o">.</span><span class="n">iVici1ReqPos</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">If</span> <span class="n">valve</span> <span class="n">lock</span> <span class="n">active</span><span class="p">,</span> <span class="n">match</span> <span class="n">valve</span> <span class="n">positions</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">valve</span> <span class="n">req</span> <span class="n">that</span> <span class="n">changes</span> <span class="n">req</span> <span class="n">number</span> <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">logic</span> <span class="n">permits</span> <span class="n">synchronized</span> <span class="n">requests</span> <span class="kn">from</span><span class="w"> </span><span class="nn">EITHER</span> <span class="n">valve</span> <span class="ow">in</span> <span class="n">EPICS</span><span class="p">,</span> <span class="n">ie</span><span class="o">.</span> <span class="n">once</span> <span class="n">sync</span> <span class="ow">and</span> <span class="n">locked</span><span class="p">,</span>
<span class="n">commanding</span> <span class="n">either</span> <span class="n">valve</span> <span class="n">will</span> <span class="n">move</span> <span class="n">both</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">iq_stSelector</span><span class="o">.</span><span class="n">xResLocked</span> <span class="n">AND</span> <span class="n">iq_stSelector</span><span class="o">.</span><span class="n">xResSyncd</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">iq_stSelector</span><span class="o">.</span><span class="n">iVici1ReqPos</span> <span class="o">&lt;&gt;</span> <span class="n">iq_stSelector</span><span class="o">.</span><span class="n">iSyncReqPos</span> <span class="n">THEN</span>
        <span class="n">iq_stSelector</span><span class="o">.</span><span class="n">iSyncReqPos</span> <span class="o">:=</span> <span class="n">iq_stSelector</span><span class="o">.</span><span class="n">iVici1ReqPos</span><span class="p">;</span>
        <span class="n">iq_stSelector</span><span class="o">.</span><span class="n">iVici2ReqPos</span> <span class="o">:=</span> <span class="n">iq_stSelector</span><span class="o">.</span><span class="n">iVici1ReqPos</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">iq_stSelector</span><span class="o">.</span><span class="n">iVici2ReqPos</span> <span class="o">&lt;&gt;</span> <span class="n">iq_stselector</span><span class="o">.</span><span class="n">iSyncReqPos</span> <span class="n">THEN</span>
        <span class="n">iq_stSelector</span><span class="o">.</span><span class="n">iSyncReqPos</span> <span class="o">:=</span> <span class="n">iq_stSelector</span><span class="o">.</span><span class="n">iVici2ReqPos</span><span class="p">;</span>
        <span class="n">iq_stSelector</span><span class="o">.</span><span class="n">iVici1ReqPos</span> <span class="o">:=</span> <span class="n">iq_stSelector</span><span class="o">.</span><span class="n">iVici2ReqPos</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">iq_stSelector</span><span class="o">.</span><span class="n">xResLock</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">iq_stSelector</span><span class="o">.</span><span class="n">xResUnlock</span> <span class="o">:=</span> <span class="kc">False</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-selectorm3">ST_SelectorM3</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-sensiriondriver">
<h2>FB_SensirionDriver<a class="headerlink" href="#fb-sensiriondriver" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_SensirionDriver</span>

<span class="n">VAR_INPUT</span>
    <span class="n">i_xExecute</span>                              <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>                <span class="p">(</span><span class="o">*</span> <span class="n">rising</span> <span class="n">edge</span> <span class="n">execute</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">i_tTimeOut</span>                              <span class="p">:</span> <span class="n">TIME</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#10S;                (* Maximum wait time for reply *)</span>
    <span class="n">i_stControl</span>                             <span class="p">:</span> <span class="n">ST_SensirionFMControl</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">q_xDone</span>                                 <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_xError</span>                                <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_xWarning</span>                              <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>                                 <span class="p">(</span><span class="o">*</span> <span class="nb">set</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">event</span> <span class="n">of</span> <span class="n">an</span> <span class="n">unexpected</span> <span class="n">reply</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">q_xTimeout</span>                              <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_asResult</span>                              <span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..60</span><span class="p">]</span> <span class="n">OF</span> <span class="n">STRING</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
    <span class="n">q_stStatus</span>                              <span class="p">:</span> <span class="n">ST_SensirionFMStatus</span><span class="p">;</span>
    <span class="n">q_xInitComplete</span>                 <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">iq_stSerialRXBuffer</span>     <span class="p">:</span> <span class="n">ComBuffer</span><span class="p">;</span>
    <span class="n">iq_stSerialTXBuffer</span>     <span class="p">:</span> <span class="n">ComBuffer</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="o">//</span><span class="n">Usual</span> <span class="n">stuff</span>
    <span class="n">rtExecute</span>                               <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">rtReInit</span>                                <span class="p">:</span>       <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">iStep</span>                                   <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">iResultIndex</span>                    <span class="p">:</span>       <span class="n">INT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">aiSteps</span> <span class="p">:</span>       <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..256</span><span class="p">]</span> <span class="n">OF</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">iStepIndex</span>      <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>
    <span class="n">fbSensirionTransaction</span>          <span class="p">:</span> <span class="n">FB_SensirionTransaction</span><span class="p">;</span>

    <span class="o">//</span><span class="n">Device</span> <span class="n">Specific</span> <span class="n">Working</span> <span class="n">Variables</span>
    <span class="n">tonDelay</span> <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">bLen</span>    <span class="p">:</span>       <span class="n">BYTE</span><span class="p">;</span>
    <span class="n">abTxData</span>        <span class="p">:</span>       <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..256</span><span class="p">]</span> <span class="n">OF</span> <span class="n">BYTE</span><span class="p">;</span>
    <span class="n">xInitComplete</span>   <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">abRxData</span>        <span class="p">:</span>       <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..256</span><span class="p">]</span> <span class="n">OF</span> <span class="n">BYTE</span><span class="p">;</span>

    <span class="n">iScale</span>  <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>
    <span class="n">iUnit</span>   <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>
    <span class="n">xType</span>   <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">xMode</span>   <span class="p">:</span>       <span class="n">BYTE</span><span class="p">;</span>
    <span class="n">xLinear</span> <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">uiOffset</span>        <span class="p">:</span>       <span class="n">UINT</span><span class="p">;</span>
    <span class="n">iIdleAttempt</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>

    <span class="o">//</span><span class="n">Command</span> <span class="n">delays</span>
    <span class="n">tonCommandDelay</span> <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
<span class="n">xcatch</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="n">performs</span> <span class="n">serial</span> <span class="n">communication</span> <span class="k">with</span> <span class="n">a</span> <span class="n">Sensirion</span> <span class="n">meter</span> <span class="o">*</span><span class="p">)</span>


<span class="p">(</span><span class="o">*</span> <span class="n">rising</span> <span class="n">edge</span> <span class="n">trigger</span> <span class="o">*</span><span class="p">)</span>
<span class="n">rtExecute</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="n">i_xExecute</span><span class="p">);</span>
<span class="n">rtReInit</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="n">i_stControl</span><span class="o">.</span><span class="n">xReset</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">rtReInit</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span> <span class="n">xInitComplete</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span> <span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">rtExecute</span><span class="o">.</span><span class="n">Q</span>  <span class="n">THEN</span>
    <span class="n">q_xDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">q_xError</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">q_xWarning</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">q_xTimeout</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span><span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="n">fbSensirionTransaction</span><span class="p">(</span> <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span> <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span> <span class="p">);</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">IF</span> <span class="n">xInitComplete</span> <span class="n">THEN</span>
        <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">30</span><span class="p">;</span>
        <span class="p">(</span><span class="o">*</span> <span class="n">Branch</span> <span class="n">to</span> <span class="n">reset</span> <span class="n">device</span> <span class="k">if</span> <span class="n">reset</span> <span class="n">bit</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">here</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">IF</span> <span class="n">rtReInit</span><span class="o">.</span><span class="n">Q</span>  <span class="n">OR</span> <span class="p">(</span><span class="n">i_stControl</span><span class="o">.</span><span class="n">xCalMode</span> <span class="o">&lt;&gt;</span> <span class="n">q_stStatus</span><span class="o">.</span><span class="n">xFMMode</span><span class="p">)</span> <span class="n">THEN</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">400</span><span class="p">;</span>
            <span class="n">xInitComplete</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">q_stStatus</span><span class="o">.</span><span class="n">xFlowValid</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="s1">&#39;Reinitializing&#39;</span><span class="p">;</span>
            <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">ELSIF</span> <span class="n">i_stControl</span><span class="o">.</span><span class="n">xReset</span> <span class="n">THEN</span>
        <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">400</span><span class="p">;</span>
        <span class="n">q_stStatus</span><span class="o">.</span><span class="n">xFlowValid</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="s1">&#39;Reinitializing&#39;</span><span class="p">;</span>
        <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">CASE</span> <span class="n">iStep</span> <span class="n">OF</span>
    <span class="mi">0</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span> <span class="n">idle</span> <span class="o">*</span><span class="p">)</span>
        <span class="p">;</span>

    <span class="mi">9</span><span class="p">:</span> <span class="o">//</span><span class="n">Get</span> <span class="n">cal</span> <span class="n">mode</span>
    <span class="n">fbSensirionTransaction</span><span class="p">(</span>
        <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">i_bAdr</span><span class="o">:=</span> <span class="n">i_stControl</span><span class="o">.</span><span class="n">bAdr</span><span class="p">,</span>
        <span class="n">i_bLen</span><span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">i_bCmd</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#43,</span>
        <span class="n">i_abTxData</span> <span class="o">:=</span> <span class="n">abTxData</span><span class="p">,</span>
        <span class="n">i_tTimeOut</span><span class="o">:=</span> <span class="n">i_tTimeOut</span><span class="p">,</span>
        <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span>
        <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span>
        <span class="p">);</span>
    <span class="n">IF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xError</span> <span class="n">THEN</span>
        <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;in Step 9 serial transaction failed with message: &#39;</span><span class="p">,</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_sResult</span><span class="p">);</span>
        <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xDone</span> <span class="n">THEN</span>
        <span class="o">//</span><span class="n">abRxdata</span> <span class="o">:=</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_baRxData</span><span class="p">;</span>
        <span class="n">IF</span> <span class="n">UDINT_TO_BOOL</span><span class="p">(</span><span class="n">MEMCPY</span><span class="p">(</span><span class="n">destAddr</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">xMode</span><span class="p">),</span> <span class="n">srcAddr</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_baRxData</span><span class="p">),</span> <span class="n">n</span><span class="o">:=</span><span class="mi">1</span><span class="p">))</span> <span class="n">THEN</span>
            <span class="n">q_stStatus</span><span class="o">.</span><span class="n">xFMMode</span> <span class="o">:=</span> <span class="n">BYTE_TO_BOOL</span><span class="p">(</span><span class="n">xMode</span><span class="p">);</span>
            <span class="n">fbSensirionTransaction</span><span class="p">(</span> <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span> <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span> <span class="p">);</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
            <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Step 9 complete. Cal mode is set to: &#39;</span><span class="p">,</span> <span class="n">BYTE_TO_STRING</span><span class="p">(</span><span class="n">xMode</span><span class="p">));</span>
            <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">ELSE</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
            <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="s1">&#39;Memcpy in step 9 failed&#39;</span><span class="p">;</span>
            <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">END_IF</span>
        <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">END_IF</span>

    <span class="mi">10</span><span class="p">:</span> <span class="o">//</span> <span class="n">Set</span> <span class="n">calibration</span>
    <span class="o">//</span><span class="n">calibration</span> <span class="n">of</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">precision</span> <span class="n">mode</span><span class="p">,</span> <span class="mi">250</span> <span class="n">nL</span><span class="o">/</span><span class="nb">min</span> <span class="o">-</span> <span class="mi">5000</span> <span class="n">nL</span><span class="o">/</span><span class="nb">min</span>
    <span class="o">//</span> <span class="n">calibration</span> <span class="n">of</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">extended</span> <span class="n">mode</span><span class="p">,</span> <span class="mi">2000</span> <span class="n">nL</span><span class="o">/</span><span class="nb">min</span> <span class="o">-</span> <span class="mi">20000</span> <span class="n">nL</span><span class="o">/</span><span class="nb">min</span>
    <span class="n">IF</span> <span class="n">q_stStatus</span><span class="o">.</span><span class="n">xFMMode</span> <span class="o">&lt;&gt;</span> <span class="n">i_stControl</span><span class="o">.</span><span class="n">xCalMode</span> <span class="n">THEN</span>
        <span class="n">IF</span> <span class="n">i_stControl</span><span class="o">.</span><span class="n">xCalMode</span> <span class="n">THEN</span> <span class="n">abTxData</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">:=</span><span class="mi">1</span><span class="p">;</span> <span class="n">ELSE</span> <span class="n">abTxData</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span> <span class="n">END_IF</span>
        <span class="n">fbSensirionTransaction</span><span class="p">(</span>
            <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
            <span class="n">i_bAdr</span><span class="o">:=</span> <span class="n">i_stControl</span><span class="o">.</span><span class="n">bAdr</span><span class="p">,</span>
            <span class="n">i_bLen</span><span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">i_bCmd</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#43,</span>
            <span class="n">i_abTxData</span> <span class="o">:=</span> <span class="n">abTxData</span><span class="p">,</span>
            <span class="n">i_tTimeOut</span><span class="o">:=</span> <span class="n">i_tTimeOut</span><span class="p">,</span>
            <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span>
            <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span>
            <span class="p">);</span>
        <span class="n">IF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xError</span> <span class="n">THEN</span>
            <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;in Step 10 serial transaction failed with message: &#39;</span><span class="p">,</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_sResult</span><span class="p">);</span>
            <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
        <span class="n">ELSIF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xDone</span> <span class="n">THEN</span>
            <span class="n">tonCommandDelay</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xDone</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#1S);</span>
            <span class="n">IF</span> <span class="n">tonCommandDelay</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
                <span class="p">(</span><span class="o">*</span> <span class="n">No</span> <span class="n">response</span><span class="p">,</span> <span class="n">completed</span> <span class="n">transaction</span> <span class="n">confirmed</span> <span class="n">by</span> <span class="n">a</span> <span class="n">response</span><span class="o">*</span><span class="p">)</span>
                <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="s1">&#39;Step 10 complete&#39;</span><span class="p">;</span>
                <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
                <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">11</span><span class="p">;</span>
                <span class="n">fbSensirionTransaction</span><span class="p">(</span> <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span> <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span> <span class="p">);</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
            <span class="n">END_IF</span>
        <span class="n">END_IF</span>
    <span class="n">ELSE</span>
        <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="s1">&#39;Calmode already set&#39;</span><span class="p">;</span>
        <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">11</span><span class="p">;</span>
    <span class="n">END_IF</span>

    <span class="mi">11</span><span class="p">:</span> <span class="o">//</span><span class="n">Get</span> <span class="n">cal</span> <span class="n">mode</span>
    <span class="n">fbSensirionTransaction</span><span class="p">(</span>
        <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">i_bAdr</span><span class="o">:=</span> <span class="n">i_stControl</span><span class="o">.</span><span class="n">bAdr</span><span class="p">,</span>
        <span class="n">i_bLen</span><span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">i_bCmd</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#43,</span>
        <span class="n">i_abTxData</span> <span class="o">:=</span> <span class="n">abTxData</span><span class="p">,</span>
        <span class="n">i_tTimeOut</span><span class="o">:=</span> <span class="n">i_tTimeOut</span><span class="p">,</span>
        <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span>
        <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span>
        <span class="p">);</span>
    <span class="n">IF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xError</span> <span class="n">THEN</span>
        <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;in Step 11 serial transaction failed with message: &#39;</span><span class="p">,</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_sResult</span><span class="p">);</span>
        <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_bState</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
        <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;in Step 11 serial transaction failed with error state: &#39;</span><span class="p">,</span> <span class="n">BYTE_TO_STRING</span><span class="p">(</span><span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_bState</span><span class="p">));</span>
        <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">fbSensirionTransaction</span><span class="p">(</span> <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span> <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span> <span class="p">);</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xDone</span> <span class="n">THEN</span>
        <span class="n">tonCommandDelay</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xDone</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#100MS);</span>
        <span class="n">IF</span> <span class="n">tonCommandDelay</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
            <span class="n">IF</span> <span class="n">UDINT_TO_BOOL</span><span class="p">(</span><span class="n">MEMCPY</span><span class="p">(</span><span class="n">destAddr</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">xMode</span><span class="p">),</span> <span class="n">srcAddr</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_baRxData</span><span class="p">),</span> <span class="n">n</span><span class="o">:=</span><span class="mi">1</span><span class="p">))</span> <span class="n">THEN</span>
                <span class="n">q_stStatus</span><span class="o">.</span><span class="n">xFMMode</span> <span class="o">:=</span> <span class="n">BYTE_TO_BOOL</span><span class="p">(</span><span class="n">xMode</span><span class="p">);</span>
                <span class="n">fbSensirionTransaction</span><span class="p">(</span> <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span> <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span> <span class="p">);</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
                <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="s1">&#39;Step 11 complete&#39;</span><span class="p">;</span>
                <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
                <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">12</span><span class="p">;</span>
            <span class="n">ELSE</span>
                <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
                <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="s1">&#39;Memcpy in step 9 failed&#39;</span><span class="p">;</span>
                <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
            <span class="n">END_IF</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>

    <span class="mi">12</span><span class="p">:</span> <span class="o">//</span><span class="n">Get</span> <span class="n">scale</span> <span class="n">factor</span>
    <span class="n">fbSensirionTransaction</span><span class="p">(</span>
        <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">i_bAdr</span><span class="o">:=</span> <span class="n">i_stControl</span><span class="o">.</span><span class="n">bAdr</span><span class="p">,</span>
        <span class="n">i_bLen</span><span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">i_bCmd</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#53,</span>
        <span class="n">i_abTxData</span> <span class="o">:=</span> <span class="n">abTxData</span><span class="p">,</span>
        <span class="n">i_tTimeOut</span><span class="o">:=</span> <span class="n">i_tTimeOut</span><span class="p">,</span>
        <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span>
        <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span>
        <span class="p">);</span>
    <span class="n">IF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xError</span> <span class="n">THEN</span>
        <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;in Step 12 serial transaction failed with message: &#39;</span><span class="p">,</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_sResult</span><span class="p">);</span>
        <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_bState</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
        <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;in Step 12 serial transaction failed with error state: &#39;</span><span class="p">,</span> <span class="n">BYTE_TO_STRING</span><span class="p">(</span><span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_bState</span><span class="p">));</span>
        <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">fbSensirionTransaction</span><span class="p">(</span> <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span> <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span> <span class="p">);</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xDone</span> <span class="n">THEN</span>
        <span class="n">tonCommandDelay</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xDone</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#100MS);</span>
        <span class="n">IF</span> <span class="n">tonCommandDelay</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
            <span class="n">IF</span> <span class="n">UDINT_TO_BOOL</span><span class="p">(</span><span class="n">MEMCPY</span><span class="p">(</span><span class="n">destAddr</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">iScale</span><span class="p">),</span> <span class="n">srcAddr</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_baRxData</span><span class="p">),</span> <span class="n">n</span><span class="o">:=</span><span class="mi">2</span><span class="p">))</span> <span class="n">THEN</span> <span class="o">//</span><span class="n">always</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">the</span> <span class="mi">16</span> <span class="n">bit</span> <span class="n">wide</span> <span class="n">integer</span>
                <span class="n">iScale</span> <span class="o">:=</span> <span class="n">WORD_TO_INT</span><span class="p">(</span><span class="n">HOST_TO_BE16</span><span class="p">(</span><span class="n">INT_TO_WORD</span><span class="p">(</span><span class="n">iScale</span><span class="p">)));</span>
                <span class="n">fbSensirionTransaction</span><span class="p">(</span> <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span> <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span> <span class="p">);</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
                <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="s1">&#39;Step 12 complete&#39;</span><span class="p">;</span>
                <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
                <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">13</span><span class="p">;</span>
            <span class="n">ELSE</span>
                <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
                <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="s1">&#39;Memcpy in step 12 failed&#39;</span><span class="p">;</span>
                <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
            <span class="n">END_IF</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>

    <span class="mi">13</span><span class="p">:</span> <span class="o">//</span><span class="n">Get</span> <span class="n">flow</span> <span class="n">unit</span>
    <span class="n">fbSensirionTransaction</span><span class="p">(</span>
        <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">i_bAdr</span><span class="o">:=</span> <span class="n">i_stControl</span><span class="o">.</span><span class="n">bAdr</span><span class="p">,</span>
        <span class="n">i_bLen</span><span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">i_bCmd</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#52,</span>
        <span class="n">i_abTxData</span> <span class="o">:=</span> <span class="n">abTxData</span><span class="p">,</span>
        <span class="n">i_tTimeOut</span><span class="o">:=</span> <span class="n">i_tTimeOut</span><span class="p">,</span>
        <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span>
        <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span>
        <span class="p">);</span>
    <span class="n">IF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xError</span> <span class="n">THEN</span>
        <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;in Step 13 serial transaction failed with message: &#39;</span><span class="p">,</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_sResult</span><span class="p">);</span>
        <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_bState</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
        <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;in Step 13 serial transaction failed with error state: &#39;</span><span class="p">,</span> <span class="n">BYTE_TO_STRING</span><span class="p">(</span><span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_bState</span><span class="p">));</span>
        <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">fbSensirionTransaction</span><span class="p">(</span> <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span> <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span> <span class="p">);</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xDone</span> <span class="n">THEN</span>
        <span class="n">tonCommandDelay</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xDone</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#100MS);</span>
        <span class="n">IF</span> <span class="n">tonCommandDelay</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
            <span class="n">IF</span> <span class="n">UDINT_TO_BOOL</span><span class="p">(</span><span class="n">MEMCPY</span><span class="p">(</span><span class="n">destAddr</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">iUnit</span><span class="p">),</span> <span class="n">srcAddr</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_baRxData</span><span class="p">),</span> <span class="n">n</span><span class="o">:=</span><span class="mi">2</span><span class="p">))</span> <span class="n">THEN</span> <span class="o">//</span><span class="n">always</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">the</span> <span class="mi">16</span> <span class="n">bit</span> <span class="n">wide</span> <span class="n">integer</span>
                <span class="n">iUnit</span> <span class="o">:=</span> <span class="n">WORD_TO_INT</span><span class="p">(</span><span class="n">HOST_TO_BE16</span><span class="p">(</span><span class="n">INT_TO_WORD</span><span class="p">(</span><span class="n">iUnit</span><span class="p">)));</span>
                <span class="n">fbSensirionTransaction</span><span class="p">(</span> <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span> <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span> <span class="p">);</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
                <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="s1">&#39;Step 13 complete&#39;</span><span class="p">;</span>
                <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
                <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">14</span><span class="p">;</span>
            <span class="n">ELSE</span>
                <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
                <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="s1">&#39;Memcpy in step 13 failed&#39;</span><span class="p">;</span>
                <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
            <span class="n">END_IF</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>

    <span class="mi">14</span><span class="p">:</span> <span class="o">//</span><span class="n">Get</span> <span class="n">measurement</span> <span class="nb">type</span>
    <span class="n">fbSensirionTransaction</span><span class="p">(</span>
        <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">i_bAdr</span><span class="o">:=</span> <span class="n">i_stControl</span><span class="o">.</span><span class="n">bAdr</span><span class="p">,</span>
        <span class="n">i_bLen</span><span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">i_bCmd</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#55,</span>
        <span class="n">i_abTxData</span> <span class="o">:=</span> <span class="n">abTxData</span><span class="p">,</span>
        <span class="n">i_tTimeOut</span><span class="o">:=</span> <span class="n">i_tTimeOut</span><span class="p">,</span>
        <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span>
        <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span>
        <span class="p">);</span>
    <span class="n">IF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xError</span> <span class="n">THEN</span>
        <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;in Step 14 serial transaction failed with message: &#39;</span><span class="p">,</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_sResult</span><span class="p">);</span>
        <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_bState</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
        <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;in Step 14 serial transaction failed with error state: &#39;</span><span class="p">,</span> <span class="n">BYTE_TO_STRING</span><span class="p">(</span><span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_bState</span><span class="p">));</span>
        <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">fbSensirionTransaction</span><span class="p">(</span> <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span> <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span> <span class="p">);</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xDone</span> <span class="n">THEN</span>
        <span class="n">tonCommandDelay</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xDone</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#100MS);</span>
        <span class="n">IF</span> <span class="n">tonCommandDelay</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
            <span class="n">xType</span> <span class="o">:=</span> <span class="n">BYTE_TO_BOOL</span><span class="p">(</span><span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_baRxData</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
            <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="s1">&#39;Step 14 complete&#39;</span><span class="p">;</span>
            <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">16</span><span class="p">;</span>
            <span class="n">fbSensirionTransaction</span><span class="p">(</span> <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span> <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span> <span class="p">);</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>

    <span class="mi">15</span><span class="p">:</span> <span class="o">//</span><span class="n">Get</span> <span class="n">offset</span>
    <span class="n">fbSensirionTransaction</span><span class="p">(</span>
        <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">i_bAdr</span><span class="o">:=</span> <span class="n">i_stControl</span><span class="o">.</span><span class="n">bAdr</span><span class="p">,</span>
        <span class="n">i_bLen</span><span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">i_bCmd</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#56,</span>
        <span class="n">i_abTxData</span> <span class="o">:=</span> <span class="n">abTxData</span><span class="p">,</span>
        <span class="n">i_tTimeOut</span><span class="o">:=</span> <span class="n">i_tTimeOut</span><span class="p">,</span>
        <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span>
        <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span>
        <span class="p">);</span>
    <span class="n">IF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xError</span> <span class="n">THEN</span>
        <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;in Step 15 serial transaction failed with message: &#39;</span><span class="p">,</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_sResult</span><span class="p">);</span>
        <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_bState</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
        <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;in Step 15 serial transaction failed with error state: &#39;</span><span class="p">,</span> <span class="n">BYTE_TO_STRING</span><span class="p">(</span><span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_bState</span><span class="p">));</span>
        <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">fbSensirionTransaction</span><span class="p">(</span> <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span> <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span> <span class="p">);</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xDone</span> <span class="n">THEN</span>
        <span class="n">tonCommandDelay</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xDone</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#100MS);</span>
        <span class="n">IF</span> <span class="n">tonCommandDelay</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
            <span class="n">IF</span> <span class="n">UDINT_TO_BOOL</span><span class="p">(</span><span class="n">MEMCPY</span><span class="p">(</span><span class="n">destAddr</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">uiOffset</span><span class="p">),</span> <span class="n">srcAddr</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_baRxData</span><span class="p">),</span> <span class="n">n</span><span class="o">:=</span><span class="mi">2</span><span class="p">))</span> <span class="n">THEN</span> <span class="o">//</span><span class="n">always</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">the</span> <span class="mi">16</span> <span class="n">bit</span> <span class="n">wide</span> <span class="n">integer</span>
                <span class="n">uiOffset</span> <span class="o">:=</span> <span class="n">WORD_TO_UINT</span><span class="p">(</span><span class="n">HOST_TO_BE16</span><span class="p">(</span><span class="n">UINT_TO_WORD</span><span class="p">(</span><span class="n">uiOffset</span><span class="p">)));</span>
                <span class="n">A_ClearTransaction</span><span class="p">();</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
                <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Step 15 complete, offset is: &#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">uiOffset</span><span class="p">));</span>
                <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
                <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">16</span><span class="p">;</span>
            <span class="n">ELSE</span>
                <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
                <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="s1">&#39;Memcpy in step 15 failed&#39;</span><span class="p">;</span>
                <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
            <span class="n">END_IF</span>
            <span class="n">A_ClearTransaction</span><span class="p">();</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>

    <span class="mi">16</span><span class="p">:</span> <span class="o">//</span><span class="n">Get</span> <span class="n">linear</span> <span class="n">mode</span>
    <span class="n">fbSensirionTransaction</span><span class="p">(</span>
        <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">i_bAdr</span><span class="o">:=</span> <span class="n">i_stControl</span><span class="o">.</span><span class="n">bAdr</span><span class="p">,</span>
        <span class="n">i_bLen</span><span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">i_bCmd</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#45,</span>
        <span class="n">i_abTxData</span> <span class="o">:=</span> <span class="n">abTxData</span><span class="p">,</span>
        <span class="n">i_tTimeOut</span><span class="o">:=</span> <span class="n">i_tTimeOut</span><span class="p">,</span>
        <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span>
        <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span>
        <span class="p">);</span>
    <span class="n">IF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xError</span> <span class="n">THEN</span>
        <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;in Step 16 serial transaction failed with message: &#39;</span><span class="p">,</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_sResult</span><span class="p">);</span>
        <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_bState</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
        <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;in Step 16 serial transaction failed with error state: &#39;</span><span class="p">,</span> <span class="n">BYTE_TO_STRING</span><span class="p">(</span><span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_bState</span><span class="p">));</span>
        <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">fbSensirionTransaction</span><span class="p">(</span> <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span> <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span> <span class="p">);</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xDone</span> <span class="n">THEN</span>
        <span class="n">tonCommandDelay</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xDone</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#100MS);</span>
        <span class="n">IF</span> <span class="n">tonCommandDelay</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
            <span class="n">xLinear</span> <span class="o">:=</span> <span class="n">BYTE_TO_BOOL</span><span class="p">(</span><span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_baRxData</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
            <span class="n">A_ClearTransaction</span><span class="p">();</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
            <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Step 16 complete, linear is: &#39;</span><span class="p">,</span> <span class="n">BOOL_TO_STRING</span><span class="p">(</span><span class="n">xLinear</span><span class="p">));</span>
            <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>

<span class="o">//////////////////////////////////////////////////////////////////</span>
<span class="o">//</span> <span class="n">Reset</span> <span class="n">sequence</span>
<span class="o">//////////////////////////////////////////////////////////////////</span>
<span class="p">(</span><span class="o">*</span>
<span class="mf">1.</span> <span class="n">Issue</span> <span class="n">a</span> <span class="n">stop</span> <span class="n">command</span> <span class="n">to</span> <span class="n">halt</span> <span class="n">continuous</span> <span class="n">measurement</span>
<span class="mf">2.</span> <span class="n">Reset</span> <span class="n">command</span>
<span class="mf">3.</span> <span class="n">Reset</span> <span class="n">initcomplete</span> <span class="n">bit</span><span class="p">,</span> <span class="ow">and</span> <span class="n">xReset</span>
<span class="mf">4.</span> <span class="n">Move</span> <span class="n">to</span> <span class="n">done</span> <span class="n">state</span>
<span class="o">*</span><span class="p">)</span>

    <span class="mi">400</span><span class="p">:</span> <span class="o">//</span><span class="n">Stop</span> <span class="n">measurement</span>
    <span class="n">fbSensirionTransaction</span><span class="p">(</span>
        <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">i_bAdr</span><span class="o">:=</span> <span class="n">i_stControl</span><span class="o">.</span><span class="n">bAdr</span><span class="p">,</span>
        <span class="n">i_bLen</span><span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">i_bCmd</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#34,</span>
        <span class="n">i_abTxData</span> <span class="o">:=</span> <span class="n">abTxData</span><span class="p">,</span>
        <span class="n">i_tTimeOut</span><span class="o">:=</span> <span class="n">i_tTimeOut</span><span class="p">,</span>
        <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span>
        <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span>
        <span class="p">);</span>
    <span class="n">IF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xError</span> <span class="n">THEN</span>
        <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;in Step 400 serial transaction failed with message: &#39;</span><span class="p">,</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_sResult</span><span class="p">);</span>
        <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xDone</span> <span class="n">THEN</span>
        <span class="n">tonCommandDelay</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xDone</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#250MS);</span>
        <span class="n">IF</span> <span class="n">tonCommandDelay</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
            <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="s1">&#39;Measurement stop command sent&#39;</span><span class="p">;</span>
            <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
            <span class="n">iStep</span><span class="o">:=</span><span class="mi">405</span><span class="p">;</span>
            <span class="n">fbSensirionTransaction</span><span class="p">(</span> <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span> <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span> <span class="p">);</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>

    <span class="mi">405</span><span class="p">:</span> <span class="o">//</span><span class="n">Check</span> <span class="n">sensor</span> <span class="n">status</span>
    <span class="n">fbSensirionTransaction</span><span class="p">(</span>
        <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">i_bAdr</span><span class="o">:=</span> <span class="n">i_stControl</span><span class="o">.</span><span class="n">bAdr</span><span class="p">,</span>
        <span class="n">i_bLen</span><span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">i_bCmd</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#30,</span>
        <span class="n">i_abTxData</span> <span class="o">:=</span> <span class="n">abTxData</span><span class="p">,</span>
        <span class="n">i_tTimeOut</span><span class="o">:=</span> <span class="n">i_tTimeOut</span><span class="p">,</span>
        <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span>
        <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span>
        <span class="p">);</span>
    <span class="n">IF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xError</span> <span class="n">THEN</span>
        <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;in Step 405 serial transaction failed with message: &#39;</span><span class="p">,</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_sResult</span><span class="p">);</span>
        <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xDone</span> <span class="n">THEN</span>
        <span class="p">(</span><span class="o">*</span> <span class="n">The</span> <span class="n">status</span> <span class="n">measurement</span> <span class="ow">is</span> <span class="n">available</span> <span class="n">at</span> <span class="n">the</span> <span class="n">rx</span> <span class="n">data</span> <span class="n">here</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">IF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_iRxLen</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
            <span class="n">IF</span> <span class="n">UDINT_TO_BOOL</span><span class="p">(</span><span class="n">MEMCPY</span><span class="p">(</span><span class="n">destAddr</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">q_stStatus</span><span class="o">.</span><span class="n">bStatus</span><span class="p">),</span> <span class="n">srcAddr</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_baRxData</span><span class="p">),</span> <span class="n">n</span><span class="o">:=</span><span class="mi">1</span><span class="p">))</span> <span class="n">THEN</span>
                <span class="n">IF</span> <span class="n">q_stStatus</span><span class="o">.</span><span class="n">bStatus</span><span class="mf">.0</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span> <span class="o">//</span><span class="n">lsb</span> <span class="n">of</span> <span class="n">bStatus</span> <span class="ow">is</span> <span class="n">idle</span>
                    <span class="n">iStep</span> <span class="o">:=</span><span class="mi">410</span><span class="p">;</span>
                    <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="s1">&#39;Sensor is idle.&#39;</span><span class="p">;</span>
                    <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
                    <span class="n">fbSensirionTransaction</span><span class="p">(</span> <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span> <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span> <span class="p">);</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
                <span class="n">ELSE</span>
                    <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">400</span><span class="p">;</span>
                    <span class="n">iIdleAttempt</span> <span class="o">:=</span> <span class="n">iIdleAttempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Failed to move to idle state in step 405, attempt &#39;</span> <span class="p">,</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">INT_TO_STRING</span><span class="p">(</span><span class="n">iIdleAttempt</span><span class="p">)</span> <span class="p">,</span> <span class="s1">&#39; of 3&#39;</span><span class="p">));</span>
                    <span class="n">IF</span> <span class="n">iIdleAttempt</span> <span class="o">=</span> <span class="mi">3</span> <span class="n">THEN</span> <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span> <span class="n">iIdleAttempt</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">END_IF</span>
                    <span class="n">fbSensirionTransaction</span><span class="p">(</span> <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span> <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span> <span class="p">);</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
                <span class="n">END_IF</span>
            <span class="n">ELSE</span>
                <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
                <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="s1">&#39;Memcpy in step 405 failed&#39;</span><span class="p">;</span>
                <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
            <span class="n">END_IF</span>
        <span class="n">ELSE</span>
            <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="s1">&#39;No status data returned&#39;</span><span class="p">;</span>
            <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>

    <span class="mi">410</span><span class="p">:</span> <span class="o">//</span><span class="n">Reset</span> <span class="n">device</span>
    <span class="n">fbSensirionTransaction</span><span class="p">(</span>
        <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">i_bAdr</span><span class="o">:=</span> <span class="n">i_stControl</span><span class="o">.</span><span class="n">bAdr</span><span class="p">,</span>
        <span class="n">i_bLen</span><span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">i_bCmd</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#65,</span>
        <span class="n">i_abTxData</span> <span class="o">:=</span> <span class="n">abTxData</span><span class="p">,</span>
        <span class="n">i_tTimeOut</span><span class="o">:=</span> <span class="n">i_tTimeOut</span><span class="p">,</span>
        <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span>
        <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span>
        <span class="p">);</span>
    <span class="n">IF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xError</span> <span class="n">THEN</span>
        <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;in Step 400 serial transaction failed with message: &#39;</span><span class="p">,</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_sResult</span><span class="p">);</span>
        <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xDone</span> <span class="n">THEN</span>
        <span class="n">tonCommandDelay</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xDone</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#200MS);</span>
        <span class="n">IF</span> <span class="n">tonCommandDelay</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
            <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="s1">&#39;Device reset command sent&#39;</span><span class="p">;</span>
            <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
            <span class="n">iStep</span><span class="o">:=</span><span class="mi">8000</span><span class="p">;</span>
            <span class="n">xInitComplete</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">fbSensirionTransaction</span><span class="p">(</span> <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span> <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span> <span class="p">);</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>


    <span class="mi">20</span><span class="p">:</span> <span class="o">//</span><span class="n">Start</span> <span class="n">continuous</span> <span class="n">measurement</span>
    <span class="n">abTxData</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">abTxData</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
        <span class="n">fbSensirionTransaction</span><span class="p">(</span>
            <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
            <span class="n">i_bAdr</span><span class="o">:=</span> <span class="n">i_stControl</span><span class="o">.</span><span class="n">bAdr</span><span class="p">,</span>
            <span class="n">i_bLen</span><span class="o">:=</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">i_bCmd</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#33,</span>
            <span class="n">i_abTxData</span> <span class="o">:=</span> <span class="n">abTxData</span><span class="p">,</span>
            <span class="n">i_tTimeOut</span><span class="o">:=</span> <span class="n">i_tTimeOut</span><span class="p">,</span>
            <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span>
            <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span>
            <span class="p">);</span>
        <span class="n">IF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xError</span> <span class="n">THEN</span>
            <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;in Step 20 serial transaction failed with message: &#39;</span><span class="p">,</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_sResult</span><span class="p">);</span>
            <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
        <span class="n">ELSIF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xDone</span> <span class="n">THEN</span>
            <span class="n">tonCommandDelay</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xDone</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#250MS);</span>
            <span class="n">IF</span> <span class="n">tonCommandDelay</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
                <span class="p">(</span><span class="o">*</span> <span class="n">No</span> <span class="n">response</span><span class="p">,</span> <span class="n">completed</span> <span class="n">transaction</span> <span class="n">confirmed</span> <span class="n">by</span> <span class="n">a</span> <span class="n">response</span><span class="o">*</span><span class="p">)</span>
                <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">21</span><span class="p">;</span>
                <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;Sent start measurement command&#39;</span><span class="p">,</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_sResult</span><span class="p">);</span>
                <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
                <span class="n">fbSensirionTransaction</span><span class="p">(</span> <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span> <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span> <span class="p">);</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
            <span class="n">END_IF</span>
        <span class="n">END_IF</span>

    <span class="mi">21</span><span class="p">:</span> <span class="o">//</span><span class="n">Check</span> <span class="n">sensor</span> <span class="n">status</span>
    <span class="n">fbSensirionTransaction</span><span class="p">(</span>
        <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">i_bAdr</span><span class="o">:=</span> <span class="n">i_stControl</span><span class="o">.</span><span class="n">bAdr</span><span class="p">,</span>
        <span class="n">i_bLen</span><span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">i_bCmd</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#30,</span>
        <span class="n">i_abTxData</span> <span class="o">:=</span> <span class="n">abTxData</span><span class="p">,</span>
        <span class="n">i_tTimeOut</span><span class="o">:=</span> <span class="n">i_tTimeOut</span><span class="p">,</span>
        <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span>
        <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span>
        <span class="p">);</span>
    <span class="n">IF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xError</span> <span class="n">THEN</span>
        <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;in Step 21 serial transaction failed with message: &#39;</span><span class="p">,</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_sResult</span><span class="p">);</span>
        <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xDone</span> <span class="n">THEN</span>
        <span class="p">(</span><span class="o">*</span> <span class="n">The</span> <span class="n">status</span> <span class="n">measurement</span> <span class="ow">is</span> <span class="n">available</span> <span class="n">at</span> <span class="n">the</span> <span class="n">rx</span> <span class="n">data</span> <span class="n">here</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">IF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_iRxLen</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
            <span class="n">IF</span> <span class="n">UDINT_TO_BOOL</span><span class="p">(</span><span class="n">MEMCPY</span><span class="p">(</span><span class="n">destAddr</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">q_stStatus</span><span class="o">.</span><span class="n">bStatus</span><span class="p">),</span> <span class="n">srcAddr</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_baRxData</span><span class="p">),</span> <span class="n">n</span><span class="o">:=</span><span class="mi">1</span><span class="p">))</span> <span class="n">THEN</span>
                <span class="n">IF</span> <span class="n">q_stStatus</span><span class="o">.</span><span class="n">bStatus</span><span class="mf">.1</span> <span class="o">=</span> <span class="mi">1</span> <span class="n">THEN</span>
                    <span class="n">iStep</span> <span class="o">:=</span><span class="mi">30</span><span class="p">;</span>
                    <span class="n">xInitComplete</span>   <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
                    <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="s1">&#39;Init success, sensor is measuring.&#39;</span><span class="p">;</span>
                    <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
                    <span class="n">fbSensirionTransaction</span><span class="p">(</span> <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span> <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span> <span class="p">);</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
                <span class="n">ELSIF</span> <span class="n">q_stStatus</span><span class="o">.</span><span class="n">bStatus</span><span class="mf">.0</span> <span class="o">=</span> <span class="mi">1</span> <span class="n">THEN</span>
                    <span class="n">iStep</span> <span class="o">:=</span><span class="mi">21</span><span class="p">;</span> <span class="o">//</span> <span class="k">if</span> <span class="n">the</span> <span class="n">sensor</span> <span class="ow">is</span> <span class="n">busy</span><span class="p">,</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">yet</span> <span class="n">measuring</span><span class="p">,</span> <span class="n">perhaps</span> <span class="n">we</span> <span class="k">try</span> <span class="n">again</span>
                    <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="s1">&#39;Sensor is busy...&#39;</span><span class="p">;</span>
                    <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
                    <span class="n">fbSensirionTransaction</span><span class="p">(</span> <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span> <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span> <span class="p">);</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
                <span class="n">ELSE</span>
                    <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
                    <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">:=</span> <span class="s1">&#39;Failed to start cont. measurement in step 21&#39;</span><span class="p">;</span>
                <span class="n">END_IF</span>
            <span class="n">ELSE</span>
                <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
                <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="s1">&#39;Memcpy in step 21 failed&#39;</span><span class="p">;</span>
                <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
            <span class="n">END_IF</span>
        <span class="n">ELSE</span>
            <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="s1">&#39;No status data returned in step 21&#39;</span><span class="p">;</span>
            <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>

    <span class="mi">30</span><span class="p">:</span> <span class="o">//</span><span class="n">Get</span> <span class="n">last</span> <span class="n">measurement</span>
        <span class="n">tonDelay</span><span class="o">.</span><span class="n">IN</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
        <span class="n">abTxData</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">:=</span><span class="mi">0</span><span class="p">;</span>
        <span class="n">fbSensirionTransaction</span><span class="p">(</span>
        <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">tonDelay</span><span class="o">.</span><span class="n">Q</span><span class="p">,</span>
        <span class="n">i_bAdr</span><span class="o">:=</span> <span class="n">i_stControl</span><span class="o">.</span><span class="n">bAdr</span><span class="p">,</span>
        <span class="n">i_bLen</span><span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">i_bCmd</span><span class="o">:=</span> <span class="mi">16</span><span class="c1">#35,</span>
        <span class="n">i_abTxData</span> <span class="o">:=</span> <span class="n">abTxData</span><span class="p">,</span>
        <span class="n">i_tTimeOut</span><span class="o">:=</span> <span class="n">i_tTimeOut</span><span class="p">,</span>
        <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span>
        <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span>
        <span class="p">);</span>
    <span class="n">IF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xError</span> <span class="n">THEN</span>
        <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;in Step 30 serial transaction failed with message: &#39;</span><span class="p">,</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_sResult</span><span class="p">);</span>
        <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xDone</span> <span class="n">THEN</span>
        <span class="p">(</span><span class="o">*</span> <span class="n">The</span> <span class="n">flow</span> <span class="n">measurement</span> <span class="ow">is</span> <span class="n">available</span> <span class="n">at</span> <span class="n">the</span> <span class="n">rx</span> <span class="n">data</span> <span class="n">here</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">IF</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_iRxLen</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
            <span class="n">IF</span> <span class="n">UDINT_TO_BOOL</span><span class="p">(</span><span class="n">MEMCPY</span><span class="p">(</span><span class="n">destAddr</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">q_stStatus</span><span class="o">.</span><span class="n">uiSensorOutput</span><span class="p">),</span> <span class="n">srcAddr</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_baRxData</span><span class="p">),</span> <span class="n">n</span><span class="o">:=</span><span class="mi">2</span><span class="p">))</span> <span class="n">THEN</span> <span class="o">//</span><span class="n">always</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">the</span> <span class="mi">16</span> <span class="n">bit</span> <span class="n">wide</span> <span class="n">integer</span>
                <span class="n">q_stStatus</span><span class="o">.</span><span class="n">uiSensorOutput</span> <span class="o">:=</span> <span class="n">WORD_TO_UINT</span><span class="p">(</span><span class="n">HOST_TO_BE16</span><span class="p">(</span><span class="n">UINT_TO_WORD</span><span class="p">(</span><span class="n">q_stStatus</span><span class="o">.</span><span class="n">uiSensorOutput</span><span class="p">)));</span> <span class="o">//</span><span class="n">memcpy</span> <span class="n">effs</span> <span class="n">up</span> <span class="n">an</span> <span class="n">produces</span> <span class="n">a</span> <span class="n">little</span> <span class="n">endian</span> <span class="n">number</span><span class="p">,</span> <span class="n">sensirion</span> <span class="n">transmits</span> <span class="n">be</span>
                <span class="n">IF</span> <span class="p">(</span><span class="n">q_stStatus</span><span class="o">.</span><span class="n">uiSensorOutput</span> <span class="n">AND</span> <span class="mi">32768</span><span class="p">)</span> <span class="o">=</span> <span class="mi">32768</span> <span class="n">THEN</span>
                    <span class="n">q_stStatus</span><span class="o">.</span><span class="n">iFlowTicks</span> <span class="o">:=</span> <span class="n">UINT_TO_INT</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="p">((</span><span class="n">q_stStatus</span><span class="o">.</span><span class="n">uiSensorOutput</span> <span class="n">XOR</span> <span class="mi">65535</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
                <span class="n">ELSE</span>
                    <span class="n">q_stStatus</span><span class="o">.</span><span class="n">iFlowTicks</span> <span class="o">:=</span> <span class="n">UINT_TO_INT</span><span class="p">(</span><span class="n">q_stStatus</span><span class="o">.</span><span class="n">uiSensorOutput</span><span class="p">);</span>
                <span class="n">END_IF</span>
                <span class="o">//</span><span class="n">Conversion</span> <span class="kn">from</span><span class="w"> </span><span class="nn">int</span> <span class="n">to</span> <span class="n">real</span> <span class="n">value</span> <span class="n">using</span> <span class="n">the</span> <span class="n">unit</span>
                <span class="n">IF</span> <span class="p">((</span><span class="n">INT_TO_WORD</span><span class="p">(</span><span class="n">iUnit</span><span class="p">)</span> <span class="n">AND</span> <span class="mi">16</span><span class="c1">#000F)=16#0003) OR ((INT_TO_WORD(iUnit) AND 16#000F)=16#0004) THEN //lsb of iUnit is magnitude, should only be one thing</span>

                    <span class="n">q_stStatus</span><span class="o">.</span><span class="n">rFlow</span> <span class="o">:=</span> <span class="p">(</span><span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">q_stStatus</span><span class="o">.</span><span class="n">iFlowTicks</span><span class="p">)</span><span class="o">/</span><span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">iScale</span><span class="p">))</span><span class="o">*</span><span class="n">EXPT</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">);</span> <span class="o">//</span><span class="n">converting</span> <span class="kn">from</span><span class="w"> </span><span class="nn">nL</span> <span class="n">to</span> <span class="n">uL</span>

                    <span class="p">(</span><span class="o">*</span> <span class="n">Check</span> <span class="n">flow</span> <span class="n">readback</span> <span class="n">against</span> <span class="n">calibration</span> <span class="nb">range</span> <span class="k">for</span> <span class="n">OoR</span> <span class="o">*</span><span class="p">)</span>
                    <span class="o">//</span><span class="n">calibration</span> <span class="n">of</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">precision</span> <span class="n">mode</span><span class="p">,</span> <span class="mi">250</span> <span class="n">nL</span><span class="o">/</span><span class="nb">min</span> <span class="o">-</span> <span class="mi">5000</span> <span class="n">nL</span><span class="o">/</span><span class="nb">min</span>
                    <span class="o">//</span> <span class="n">calibration</span> <span class="n">of</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">extended</span> <span class="n">mode</span><span class="p">,</span> <span class="mi">2000</span> <span class="n">nL</span><span class="o">/</span><span class="nb">min</span> <span class="o">-</span> <span class="mi">20000</span> <span class="n">nL</span><span class="o">/</span><span class="nb">min</span>
                    <span class="n">IF</span> <span class="p">(</span><span class="n">q_stStatus</span><span class="o">.</span><span class="n">xFMMode</span> <span class="o">=</span><span class="mi">0</span> <span class="p">)</span> <span class="n">THEN</span>
                        <span class="n">IF</span> <span class="p">(</span><span class="n">ABS</span><span class="p">(</span><span class="n">q_stStatus</span><span class="o">.</span><span class="n">rFlow</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mf">250E-3</span><span class="p">))</span> <span class="n">THEN</span>
                            <span class="n">q_stStatus</span><span class="o">.</span><span class="n">iState</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span> <span class="o">//&lt;</span><span class="n">OoR</span>
                        <span class="n">ELSIF</span> <span class="p">(</span><span class="n">ABS</span><span class="p">(</span><span class="n">q_stStatus</span><span class="o">.</span><span class="n">rFlow</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mf">5000E-3</span><span class="p">))</span> <span class="n">THEN</span>
                            <span class="n">q_stStatus</span><span class="o">.</span><span class="n">iState</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="o">//</span><span class="n">OoR</span><span class="o">&gt;</span>
                        <span class="n">ELSE</span>
                            <span class="n">q_stStatus</span><span class="o">.</span><span class="n">iState</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">//</span><span class="n">OK</span>
                        <span class="n">END_IF</span>
                    <span class="n">ELSIF</span> <span class="p">(</span><span class="n">q_stStatus</span><span class="o">.</span><span class="n">xFMMode</span> <span class="o">=</span><span class="mi">1</span> <span class="p">)</span> <span class="n">THEN</span>
                        <span class="n">IF</span> <span class="p">(</span><span class="n">ABS</span><span class="p">(</span><span class="n">q_stStatus</span><span class="o">.</span><span class="n">rFlow</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mf">2000E-3</span><span class="p">))</span> <span class="n">THEN</span>
                            <span class="n">q_stStatus</span><span class="o">.</span><span class="n">iState</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span> <span class="o">//&lt;</span><span class="n">OoR</span> <span class="n">Add</span> <span class="n">to</span> <span class="n">xOoR</span> <span class="n">variable</span>
                        <span class="n">ELSIF</span> <span class="p">(</span><span class="n">ABS</span><span class="p">(</span><span class="n">q_stStatus</span><span class="o">.</span><span class="n">rFlow</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mf">20000E-3</span><span class="p">))</span> <span class="n">THEN</span>
                            <span class="n">q_stStatus</span><span class="o">.</span><span class="n">iState</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="o">//</span><span class="n">OoR</span><span class="o">&gt;</span>
                        <span class="n">ELSE</span>
                            <span class="n">q_stStatus</span><span class="o">.</span><span class="n">iState</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">//</span> <span class="n">OK</span>
                        <span class="n">END_IF</span>
                    <span class="n">END_IF</span>
                    <span class="n">q_stStatus</span><span class="o">.</span><span class="n">xFlowValid</span> <span class="o">:=</span> <span class="p">(</span><span class="n">q_stStatus</span><span class="o">.</span><span class="n">iState</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span> <span class="o">//</span> <span class="n">Flow</span> <span class="n">valid</span> <span class="k">if</span> <span class="n">OK</span>

                    <span class="o">//</span> <span class="n">Limit</span> <span class="n">the</span> <span class="n">measured</span> <span class="n">flowrate</span> <span class="n">based</span> <span class="n">on</span> <span class="n">the</span> <span class="n">calmode</span>
                    <span class="n">IF</span> <span class="n">q_stStatus</span><span class="o">.</span><span class="n">xFMMode</span> <span class="n">THEN</span>
                        <span class="n">q_stStatus</span><span class="o">.</span><span class="n">rFlow</span> <span class="o">:=</span> <span class="n">LIMIT</span><span class="p">(</span><span class="o">-</span><span class="mf">20000E-3</span><span class="p">,</span> <span class="n">q_stStatus</span><span class="o">.</span><span class="n">rFlow</span><span class="p">,</span> <span class="mf">20000E-3</span><span class="p">);</span>
                    <span class="n">ELSE</span>
                        <span class="n">q_stStatus</span><span class="o">.</span><span class="n">rFlow</span> <span class="o">:=</span> <span class="n">LIMIT</span><span class="p">(</span><span class="o">-</span><span class="mf">5000E-3</span><span class="p">,</span> <span class="n">q_stStatus</span><span class="o">.</span><span class="n">rFlow</span><span class="p">,</span> <span class="mf">5000E-3</span><span class="p">);</span>
                    <span class="n">END_IF</span>

                <span class="n">ELSE</span>
                    <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
                    <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="s1">&#39;iUnit not recognized in step 30&#39;</span><span class="p">;</span>
                    <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
                <span class="n">END_IF</span>
                <span class="p">(</span><span class="o">*</span> <span class="n">Stuff</span> <span class="n">worked</span><span class="p">,</span> <span class="n">go</span> <span class="n">to</span> <span class="mi">8000</span> <span class="o">*</span><span class="p">)</span>
                <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">8000</span><span class="p">;</span>
                <span class="n">fbSensirionTransaction</span><span class="p">(</span> <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span> <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span> <span class="p">);</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
                <span class="n">tonDelay</span><span class="o">.</span><span class="n">IN</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">ELSE</span>
                <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
                <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="s1">&#39;Memcpy in step 30 failed&#39;</span><span class="p">;</span>
                <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
            <span class="n">END_IF</span>
        <span class="n">ELSE</span>
            <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="s1">&#39;No flow data returned&#39;</span><span class="p">;</span>
            <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="n">END_IF</span>

    <span class="mi">8000</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span> <span class="n">done</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">q_xDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">IF</span> <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="n">THEN</span>
            <span class="n">q_asResult</span><span class="p">[</span><span class="n">iResultIndex</span><span class="p">]</span> <span class="o">:=</span> <span class="s1">&#39;Success&#39;</span><span class="p">;</span>
            <span class="n">iResultIndex</span> <span class="o">:=</span> <span class="n">iResultIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>

        <span class="n">END_IF</span>
        <span class="n">IF</span>  <span class="n">i_xExecute</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="n">THEN</span>
            <span class="n">q_xDone</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">END_IF</span>

    <span class="mi">9000</span><span class="p">:</span>
        <span class="n">q_xTimeout</span> <span class="o">:=</span> <span class="n">fbSensirionTransaction</span><span class="o">.</span><span class="n">q_xTimeout</span><span class="p">;</span>
        <span class="n">q_xError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="o">//</span> <span class="n">If</span> <span class="n">we</span><span class="s1">&#39;re having issues communicating we don&#39;</span><span class="n">t</span> <span class="n">want</span> <span class="n">to</span> <span class="n">be</span> <span class="n">left</span> <span class="n">thinking</span> <span class="n">there</span><span class="s1">&#39;s a flow... even if we know it&#39;</span><span class="n">s</span> <span class="ow">not</span> <span class="n">valid</span><span class="o">.</span>
        <span class="n">q_stStatus</span><span class="o">.</span><span class="n">xFlowValid</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">q_stStatus</span><span class="o">.</span><span class="n">iState</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">;</span> <span class="o">//</span> <span class="n">Flow</span> <span class="n">invalid</span>
        <span class="n">q_stStatus</span><span class="o">.</span><span class="n">rFlow</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_CASE</span>

<span class="n">tonDelay</span><span class="p">(</span><span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#500MS);</span>

<span class="o">//</span><span class="n">q_stStatus</span><span class="o">.</span><span class="n">rFlow</span> <span class="o">:=</span> <span class="n">INT_TO_REAL</span><span class="p">(</span><span class="n">iFlow</span><span class="p">);</span>
<span class="n">iStepIndex</span> <span class="o">:=</span> <span class="n">iStepIndex</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="n">aiSteps</span><span class="p">[</span><span class="n">iStepIndex</span><span class="p">]</span><span class="o">:=</span><span class="n">iStep</span><span class="p">;</span>


<span class="n">q_xInitComplete</span> <span class="o">:=</span> <span class="n">xInitComplete</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">iStepIndex</span> <span class="o">&gt;</span><span class="mi">256</span> <span class="n">THEN</span> <span class="n">iStepIndex</span><span class="o">:=</span><span class="mi">1</span><span class="p">;</span> <span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">iResultIndex</span> <span class="o">&gt;</span><span class="mi">60</span> <span class="n">THEN</span> <span class="n">iResultIndex</span><span class="o">:=</span><span class="mi">1</span><span class="p">;</span> <span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">A_ClearTransaction</span><span class="p">:</span>
<span class="n">fbSensirionTransaction</span><span class="p">(</span> <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span> <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span> <span class="p">);</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">Get</span><span class="p">:</span>

<span class="n">END_ACTION</span>

<span class="n">METHOD</span> <span class="n">Reset</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">If</span> <span class="n">this</span> <span class="n">works</span><span class="o">....</span>

<span class="n">THIS</span><span class="o">^</span><span class="p">(</span><span class="n">i_xExecute</span> <span class="o">:=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">iq_stSerialRXBuffer</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iq_stSerialRXBuffer</span><span class="p">,</span>
    <span class="n">iq_stSerialTXBuffer</span> <span class="o">:=</span> <span class="n">THIS</span><span class="o">^.</span><span class="n">iq_stSerialTXBuffer</span><span class="p">,);</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-sensiriontransaction">FB_SensirionTransaction</a></p></li>
<li><p><a class="reference internal" href="#st-sensirionfmcontrol">ST_SensirionFMControl</a></p></li>
<li><p><a class="reference internal" href="#st-sensirionfmstatus">ST_SensirionFMStatus</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-sensiriontransaction">
<h2>FB_SensirionTransaction<a class="headerlink" href="#fb-sensiriontransaction" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_SensirionTransaction</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">c_ArraySize</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">600</span><span class="p">;</span>
    <span class="n">c_DebugArraySize</span>        <span class="p">:</span>       <span class="n">INT</span><span class="o">:=</span><span class="mi">40</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_xExecute</span>                              <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>                           <span class="p">(</span><span class="o">*</span> <span class="n">Rising</span> <span class="n">edge</span> <span class="n">execute</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">i_bCmd</span>                                  <span class="p">:</span>       <span class="n">BYTE</span><span class="p">;</span>                           <span class="p">(</span><span class="o">*</span> <span class="n">Command</span> <span class="n">parameter</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">i_bAdr</span>                                  <span class="p">:</span>       <span class="n">BYTE</span><span class="p">;</span>   <span class="o">//</span><span class="n">Address</span> <span class="n">parameter</span>
    <span class="n">i_bLen</span>                                  <span class="p">:</span>       <span class="n">BYTE</span><span class="p">;</span>   <span class="o">//</span><span class="n">Length</span> <span class="n">of</span> <span class="n">transmission</span>
    <span class="n">i_abTxData</span>                              <span class="p">:</span>       <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..256</span><span class="p">]</span> <span class="n">OF</span> <span class="n">BYTE</span><span class="p">;</span> <span class="o">//</span><span class="n">Transmission</span>
    <span class="n">i_tTimeOut</span>                              <span class="p">:</span>       <span class="n">TIME</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#10S;          (* Maximum wait time for reply *)</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">q_xDone</span>                                 <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_baRxData</span>                              <span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">c_ArraySize</span><span class="p">]</span> <span class="n">OF</span> <span class="n">BYTE</span><span class="p">;</span> <span class="o">//</span><span class="n">Rx</span> <span class="n">data</span> <span class="kn">from</span><span class="w"> </span><span class="nn">the</span> <span class="n">frame</span><span class="p">,</span> <span class="n">parse</span> <span class="n">this</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">driver</span>
    <span class="n">q_iRxLen</span>                                <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">q_xError</span>                                <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_xTimeout</span>                              <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_sResult</span>                               <span class="p">:</span> <span class="n">STRING</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
    <span class="n">q_abLastTxData</span>          <span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">c_DebugArraySize</span><span class="p">,</span><span class="mf">1.</span><span class="o">.</span><span class="n">c_ArraySize</span><span class="p">]</span> <span class="n">OF</span> <span class="n">BYTE</span><span class="p">;</span>                    <span class="p">(</span><span class="o">*</span> <span class="n">Last</span> <span class="n">byte</span> <span class="n">stream</span> <span class="n">sent</span> <span class="n">to</span> <span class="n">serial</span> <span class="n">device</span> <span class="o">-</span> <span class="k">for</span> <span class="n">debugging</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">q_abLastRxData</span>          <span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">c_DebugArraySize</span><span class="p">,</span><span class="mf">1.</span><span class="o">.</span><span class="n">c_ArraySize</span><span class="p">]</span> <span class="n">OF</span> <span class="n">BYTE</span><span class="p">;</span>                    <span class="p">(</span><span class="o">*</span> <span class="n">Last</span> <span class="n">byte</span> <span class="n">stream</span> <span class="n">received</span> <span class="kn">from</span><span class="w"> </span><span class="nn">serial</span> <span class="n">device</span> <span class="o">-</span> <span class="k">for</span> <span class="n">debugging</span> <span class="o">*</span><span class="p">)</span>

    <span class="n">q_bState</span>        <span class="p">:</span>       <span class="n">BYTE</span><span class="p">;</span>

    <span class="n">q_baRxUnit</span>      <span class="p">:</span>       <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">c_ArraySize</span><span class="p">]</span> <span class="n">OF</span> <span class="n">BYTE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">iq_stSerialRXBuffer</span>     <span class="p">:</span> <span class="n">ComBuffer</span><span class="p">;</span>
    <span class="n">iq_stSerialTXBuffer</span>     <span class="p">:</span> <span class="n">ComBuffer</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="o">//</span><span class="n">Usual</span> <span class="n">stuff</span>
    <span class="n">rtExecute</span>                               <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">iStep</span>                                   <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">fbClearComBuffer</span>                <span class="p">:</span> <span class="n">ClearComBuffer</span><span class="p">;</span>
    <span class="n">fbSendData</span>                              <span class="p">:</span> <span class="n">SendData</span><span class="p">;</span>
    <span class="n">udiTxLen</span>                                <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">udiRxLen</span>                                <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>
    <span class="n">fbReceiveData</span>                   <span class="p">:</span> <span class="n">ReceiveData</span><span class="p">;</span>
    <span class="n">baRxData</span>                        <span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">c_ArraySize</span><span class="p">]</span> <span class="n">OF</span> <span class="n">BYTE</span><span class="p">;</span>
    <span class="n">baTxData</span>                        <span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">c_ArraySize</span><span class="p">]</span> <span class="n">OF</span> <span class="n">BYTE</span><span class="p">;</span>
    <span class="n">tonTimeout</span>                              <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">iDataTx</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">iDataRx</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="o">//</span><span class="n">Device</span> <span class="n">specific</span>
    <span class="n">iSeek</span> <span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span><span class="mi">1</span> <span class="p">;</span>
    <span class="n">bDelimiter</span>      <span class="p">:</span>       <span class="n">BYTE</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#7E;</span>
    <span class="n">bRxLen</span>  <span class="p">:</span>       <span class="n">BYTE</span><span class="p">;</span>
    <span class="n">fbShiftByteArray</span>        <span class="p">:</span>       <span class="n">FB_ShiftByteArray</span><span class="p">;</span>
    <span class="n">iFrameWidth</span>     <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>
    <span class="n">bCatch</span> <span class="p">:</span> <span class="n">BYTE</span><span class="p">;</span>
    <span class="n">xCatch</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="n">performs</span> <span class="n">serial</span> <span class="n">transactions</span> <span class="k">for</span> <span class="n">the</span> <span class="n">SHDCLC</span> <span class="p">(</span><span class="n">Sensirion</span><span class="p">)</span> <span class="n">Interface</span>  <span class="o">*</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Note</span> <span class="n">the</span> <span class="n">SHDLC</span> <span class="n">transaction</span> <span class="n">uses</span> <span class="nb">bytes</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">strings</span> <span class="o">*</span><span class="p">)</span>

<span class="p">(</span><span class="o">*</span> <span class="n">rising</span> <span class="n">edge</span> <span class="n">trigger</span> <span class="o">*</span><span class="p">)</span>
<span class="n">rtExecute</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="n">i_xExecute</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">rtExecute</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">q_xDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="o">//</span><span class="n">Clear</span> <span class="n">the</span> <span class="n">Tx</span> <span class="ow">and</span> <span class="n">Rx</span> <span class="n">buffer</span>
    <span class="n">MEMSET</span><span class="p">(</span><span class="n">destAddr</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">baRxData</span><span class="p">),</span> <span class="n">fillByte</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#00, n:=SIZEOF(baRxData));</span>
    <span class="n">MEMSET</span><span class="p">(</span><span class="n">destAddr</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">baTxData</span><span class="p">),</span> <span class="n">fillByte</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#00, n:=SIZEOF(baTxData));</span>
    <span class="n">q_xError</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">q_xTimeout</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">q_sResult</span><span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="o">//</span><span class="n">MEMSET</span><span class="p">(</span><span class="n">destAddr</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">q_abLastTxData</span><span class="p">[</span><span class="n">iDataTx</span><span class="p">,</span><span class="mi">1</span><span class="p">]),</span> <span class="n">fillByte</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#00, n:=c_ArraySize);</span>
    <span class="o">//</span><span class="n">MEMSET</span><span class="p">(</span><span class="n">destAddr</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">q_abLastTxData</span><span class="p">[</span><span class="n">iDataRx</span><span class="p">,</span><span class="mi">1</span><span class="p">]),</span> <span class="n">fillByte</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#00, n:=c_ArraySize);</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">clear</span> <span class="n">com</span> <span class="n">buffers</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">fbClearComBuffer</span><span class="p">(</span><span class="n">Buffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">);</span>
    <span class="n">fbClearComBuffer</span><span class="p">(</span><span class="n">Buffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span><span class="p">);</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">Reset</span> <span class="n">receive</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">fbReceiveData</span><span class="p">(</span>
        <span class="n">Reset</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">RXbuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span> <span class="p">);</span>
    <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">CASE</span> <span class="n">iStep</span> <span class="n">OF</span>
    <span class="mi">0</span><span class="p">:</span>
        <span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">idle</span> <span class="o">*</span><span class="p">)</span>

    <span class="mi">10</span><span class="p">:</span>
        <span class="p">(</span><span class="o">*</span> <span class="n">Build</span> <span class="n">the</span> <span class="n">byte</span> <span class="n">array</span> <span class="o">*</span><span class="p">)</span>
        <span class="o">//</span><span class="n">Every</span> <span class="n">message</span> <span class="n">starts</span> <span class="k">with</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="n">but</span> <span class="n">we</span> <span class="n">don</span><span class="s1">&#39;t add that here.</span>
        <span class="n">baTxData</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#00;</span>
        <span class="o">//</span><span class="n">Address</span><span class="p">,</span> <span class="n">command</span> <span class="ow">and</span> <span class="n">message</span> <span class="n">length</span>
        <span class="n">baTxData</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">:=</span><span class="n">i_bAdr</span><span class="p">;</span>
        <span class="n">baTxData</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">:=</span><span class="n">i_bCmd</span><span class="p">;</span>
        <span class="n">baTxData</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">:=</span><span class="n">i_bLen</span><span class="p">;</span>
        <span class="o">//</span><span class="n">Add</span> <span class="n">the</span> <span class="n">message</span>
        <span class="n">IF</span> <span class="n">i_bLen</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
            <span class="n">MEMCPY</span><span class="p">(</span><span class="n">destAddr</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">baTxData</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span> <span class="n">srcAddr</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">i_abTxData</span><span class="p">),</span> <span class="n">n</span><span class="o">:=</span><span class="n">i_bLen</span><span class="p">);</span>
        <span class="n">END_IF</span>
        <span class="o">//</span><span class="n">Add</span> <span class="n">the</span> <span class="n">checksum</span>
        <span class="n">baTxData</span><span class="p">[</span><span class="mi">5</span><span class="o">+</span><span class="n">i_bLen</span><span class="p">]</span><span class="o">:=</span><span class="n">fSHDLCChecksum</span><span class="p">(</span><span class="n">i_bAdr</span><span class="o">:=</span><span class="n">i_bAdr</span><span class="p">,</span> <span class="n">i_bCmd</span><span class="o">:=</span><span class="n">i_bCmd</span><span class="p">,</span> <span class="n">i_bLen</span><span class="o">:=</span><span class="n">i_bLen</span><span class="p">,</span> <span class="n">i_pbaTxData</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">i_abTxData</span><span class="p">));</span>



        <span class="o">//</span><span class="n">Calc</span> <span class="n">the</span> <span class="n">framewidth</span><span class="p">,</span> <span class="n">a</span> <span class="n">useful</span> <span class="n">number</span>
        <span class="o">//</span> <span class="n">start</span> <span class="o">+</span> <span class="n">adr</span> <span class="o">+</span> <span class="n">cmd</span> <span class="o">+</span> <span class="nb">len</span> <span class="o">+</span> <span class="n">tx</span> <span class="n">data</span> <span class="p">(</span><span class="nb">len</span><span class="p">)</span> <span class="o">+</span> <span class="n">chk</span> <span class="o">+</span> <span class="n">stop</span>
        <span class="n">udiTxLen</span><span class="o">:=</span><span class="p">(</span><span class="mi">4</span><span class="o">+</span><span class="n">BYTE_TO_UDINT</span><span class="p">(</span><span class="n">i_bLen</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">(</span><span class="o">*</span> <span class="n">Byte</span> <span class="n">stuffing</span>
        <span class="n">If</span> <span class="nb">any</span> <span class="n">special</span> <span class="nb">bytes</span> <span class="n">are</span> <span class="n">found</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">message</span><span class="p">,</span> <span class="n">they</span> <span class="n">must</span> <span class="n">be</span> <span class="n">replaced</span> <span class="k">with</span> <span class="n">a</span> <span class="n">special</span> <span class="n">pair</span> <span class="n">of</span> <span class="nb">bytes</span> <span class="o">*</span><span class="p">)</span>
        <span class="p">(</span><span class="o">*</span> <span class="n">Seek</span> <span class="n">through</span> <span class="n">the</span> <span class="n">byte</span> <span class="n">array</span> <span class="k">for</span> <span class="nb">any</span> <span class="n">of</span> <span class="n">the</span> <span class="n">special</span> <span class="nb">bytes</span>
         <span class="mh">0x7e</span>
         <span class="mh">0x7d</span>
         <span class="mh">0x11</span>
         <span class="mh">0x13</span> <span class="o">*</span><span class="p">)</span>
         <span class="n">FOR</span> <span class="n">iSeek</span><span class="o">:=</span><span class="mi">2</span> <span class="n">TO</span> <span class="n">UDINT_TO_INT</span><span class="p">(</span><span class="n">udiTxLen</span><span class="p">)</span> <span class="n">DO</span>
             <span class="n">IF</span> <span class="p">(</span><span class="n">baTxData</span><span class="p">[</span><span class="n">iSeek</span><span class="p">]</span><span class="o">=</span><span class="mi">16</span><span class="c1">#7E) OR (baTxData[iSeek]=16#7D) OR (baTxData[iSeek]=16#11) OR (baTxData[iSeek]=16#13) THEN</span>
                 <span class="p">(</span><span class="o">*</span> <span class="n">When</span> <span class="n">a</span> <span class="n">special</span> <span class="n">byte</span> <span class="ow">is</span> <span class="n">found</span><span class="p">,</span> <span class="n">move</span> <span class="n">the</span> <span class="n">remaining</span> <span class="n">message</span> <span class="n">to</span> <span class="n">the</span> <span class="n">right</span> <span class="n">by</span> <span class="n">one</span> <span class="n">byte</span> <span class="o">*</span><span class="p">)</span>
                 <span class="n">fbShiftByteArray</span><span class="p">(</span><span class="n">ptArray</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">baTxData</span><span class="p">),</span> <span class="n">iSize</span><span class="o">:=</span><span class="mi">256</span><span class="p">,</span> <span class="n">iCurrIndex</span><span class="o">:=</span><span class="n">iSeek</span><span class="p">,</span> <span class="n">iMessageLen</span><span class="o">:=</span><span class="p">(</span><span class="mi">5</span><span class="o">+</span><span class="n">BYTE_TO_INT</span><span class="p">(</span><span class="n">i_bLen</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">iShift</span><span class="o">:=</span><span class="mi">1</span><span class="p">);</span>
                 <span class="n">IF</span> <span class="n">fbShiftByteArray</span><span class="o">.</span><span class="n">q_xError</span> <span class="n">THEN</span>
                     <span class="n">q_sResult</span><span class="o">:=</span><span class="s1">&#39;Transaction failed in step 10 while making room for the stuffing&#39;</span><span class="p">;</span>
                     <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
                     <span class="n">RETURN</span><span class="p">;</span> <span class="o">//</span><span class="n">this</span> <span class="n">way</span> <span class="n">we</span> <span class="n">catch</span> <span class="n">what</span> <span class="n">happened</span><span class="o">.</span>
                    <span class="n">ELSE</span>
                        <span class="o">//</span><span class="n">Stuff</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">byte</span>
                        <span class="n">baTxData</span><span class="p">[</span><span class="n">iSeek</span><span class="p">]</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#7D;</span>
                        <span class="o">//</span><span class="n">Change</span> <span class="n">the</span> <span class="n">original</span> <span class="n">byte</span><span class="p">,</span> <span class="n">which</span> <span class="n">now</span> <span class="n">resides</span> <span class="n">at</span> <span class="n">iSeek</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">to</span> <span class="n">invert</span> <span class="n">the</span> <span class="n">fifth</span> <span class="n">bit</span>
                        <span class="n">baTxData</span><span class="p">[</span><span class="n">iSeek</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">:=</span><span class="n">baTxData</span><span class="p">[</span><span class="n">iSeek</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="n">XOR</span> <span class="mi">16</span><span class="c1">#10;</span>
                        <span class="o">//</span><span class="n">Update</span> <span class="n">the</span> <span class="n">framewidth</span> <span class="n">to</span> <span class="n">be</span> <span class="o">+</span><span class="mi">1</span>
                        <span class="n">udiTxLen</span> <span class="o">:=</span> <span class="n">udiTxLen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                 <span class="n">END_IF</span>
             <span class="n">END_IF</span>
         <span class="n">END_FOR</span>
         <span class="o">//</span><span class="n">If</span> <span class="n">we</span> <span class="n">made</span> <span class="n">it</span> <span class="n">this</span> <span class="n">far</span><span class="p">,</span> <span class="n">we</span><span class="s1">&#39;re done with building the message, and stuffing it, frame it</span>
         <span class="n">baTxData</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">:=</span><span class="n">bDelimiter</span><span class="p">;</span>
         <span class="o">//</span><span class="n">Add</span> <span class="n">one</span> <span class="n">to</span> <span class="n">the</span> <span class="n">frame</span> <span class="n">width</span>
         <span class="n">udiTxLen</span> <span class="o">:=</span> <span class="n">udiTxLen</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
         <span class="n">baTxData</span><span class="p">[</span><span class="n">udiTxLen</span><span class="p">]</span><span class="o">:=</span><span class="n">bDelimiter</span><span class="p">;</span>


        <span class="n">fbSendData</span><span class="p">(</span><span class="n">TXbuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span><span class="p">,</span><span class="n">pSendData</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">baTxData</span><span class="p">),</span> <span class="n">Length</span><span class="o">:=</span><span class="n">udiTxLen</span><span class="p">);</span>
        <span class="o">//</span><span class="n">For</span> <span class="n">debugging</span><span class="p">:</span>
        <span class="n">MEMCPY</span><span class="p">(</span><span class="n">destAddr</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">q_abLastTxData</span><span class="p">[</span><span class="n">iDataTx</span><span class="p">,</span><span class="mi">1</span><span class="p">]),</span> <span class="n">srcAddr</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">baTxData</span><span class="p">),</span> <span class="n">n</span><span class="o">:=</span><span class="n">INT_TO_UDINT</span><span class="p">(</span><span class="n">c_ArraySize</span><span class="p">));</span>
        <span class="n">IF</span> <span class="n">iDataTx</span> <span class="o">=</span> <span class="n">c_DebugArraySize</span> <span class="n">THEN</span> <span class="n">iDataTx</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ELSE</span> <span class="n">iDataTx</span> <span class="o">:=</span> <span class="n">iDataTx</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">END_IF</span>

        <span class="k">if</span> <span class="n">i_bCmd</span> <span class="o">=</span> <span class="n">bCatch</span> <span class="n">THEN</span> <span class="n">xCatch</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span> <span class="n">END_IF</span>

        <span class="n">iStep</span> <span class="o">:=</span> <span class="n">iStep</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>

    <span class="mi">20</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span> <span class="n">Finish</span> <span class="n">sending</span> <span class="n">the</span> <span class="n">data</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">IF</span> <span class="n">fbSendData</span><span class="o">.</span><span class="n">Busy</span> <span class="n">THEN</span>
            <span class="n">fbSendData</span><span class="p">(</span><span class="n">TXbuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span><span class="p">,</span><span class="n">pSendData</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">baTxData</span><span class="p">),</span> <span class="n">Length</span><span class="o">:=</span><span class="n">udiTxLen</span><span class="p">);</span>
        <span class="n">ELSIF</span> <span class="n">fbSendData</span><span class="o">.</span><span class="n">Error</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
            <span class="n">q_sResult</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;In step 20 fbSendData resulted in error: &#39;</span><span class="p">,</span> <span class="n">INT_TO_STRING</span><span class="p">(</span><span class="n">fbSendData</span><span class="o">.</span><span class="n">Error</span><span class="p">));</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
        <span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">fbSendData</span><span class="o">.</span><span class="n">Busy</span> <span class="n">THEN</span>
            <span class="n">iStep</span><span class="o">:=</span><span class="n">iStep</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>
        <span class="n">END_IF</span>
        <span class="n">tonTimeout</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">);</span>

    <span class="mi">30</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span> <span class="n">Get</span> <span class="n">reply</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">fbReceiveData</span><span class="p">(</span>
            <span class="n">pPrefix</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">bDelimiter</span><span class="p">),</span>
            <span class="n">LenPrefix</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">pSuffix</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">bDelimiter</span><span class="p">),</span>
            <span class="n">LenSuffix</span><span class="o">:=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">pReceiveData</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">baRxData</span><span class="p">),</span>
            <span class="n">SizeReceiveData</span><span class="o">:=</span><span class="n">SIZEOF</span><span class="p">(</span><span class="n">baRxData</span><span class="p">),</span>
            <span class="n">Timeout</span><span class="o">:=</span> <span class="n">i_tTimeOut</span><span class="p">,</span>
            <span class="n">Reset</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span>
            <span class="n">RXbuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span> <span class="p">);</span>
        <span class="n">tonTimeout</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span> <span class="n">i_tTimeOut</span><span class="p">);</span>
        <span class="n">IF</span> <span class="n">fbReceiveData</span><span class="o">.</span><span class="n">Error</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
            <span class="n">q_sResult</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;In step 30 fbReceiveData resulted in error: &#39;</span><span class="p">,</span> <span class="n">INT_TO_STRING</span><span class="p">(</span><span class="n">fbReceiveData</span><span class="o">.</span><span class="n">Error</span><span class="p">));</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
        <span class="n">ELSIF</span> <span class="n">fbReceiveData</span><span class="o">.</span><span class="n">RxTimeout</span> <span class="n">OR</span> <span class="n">tonTimeout</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
            <span class="n">q_sResult</span> <span class="o">:=</span> <span class="s1">&#39;Serial device failed to reply within timeout period&#39;</span><span class="p">;</span>
            <span class="n">q_xTimeout</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
        <span class="n">ELSIF</span> <span class="n">fbReceiveData</span><span class="o">.</span><span class="n">DataReceived</span> <span class="n">THEN</span>
            <span class="n">udiRxLen</span> <span class="o">:=</span> <span class="n">fbReceiveData</span><span class="o">.</span><span class="n">LenReceiveData</span><span class="p">;</span>
            <span class="o">//</span> <span class="n">For</span> <span class="n">troubleshooting</span><span class="p">,</span> <span class="n">use</span> <span class="n">this</span> <span class="n">to</span> <span class="n">capture</span> <span class="n">a</span> <span class="n">specific</span> <span class="n">command</span> <span class="n">message</span> <span class="n">reply</span>


            <span class="n">IF</span> <span class="n">udiRxLen</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
                <span class="o">//</span><span class="n">Remove</span> <span class="n">the</span> <span class="n">stuffing</span>
                <span class="n">FOR</span> <span class="n">iSeek</span><span class="o">:=</span><span class="mi">1</span> <span class="n">TO</span> <span class="n">UDINT_TO_INT</span><span class="p">(</span><span class="n">udiRxLen</span><span class="p">)</span> <span class="n">DO</span>
                    <span class="n">IF</span> <span class="n">baRxData</span><span class="p">[</span><span class="n">iSeek</span><span class="p">]</span><span class="o">=</span><span class="mi">16</span><span class="c1">#7D THEN</span>
                        <span class="n">fbShiftByteArray</span><span class="p">(</span><span class="n">ptArray</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">baRxData</span><span class="p">),</span> <span class="n">iSize</span><span class="o">:=</span><span class="mi">256</span><span class="p">,</span> <span class="n">iCurrIndex</span><span class="o">:=</span><span class="n">iSeek</span><span class="p">,</span> <span class="n">iMessageLen</span><span class="o">:=</span><span class="n">UDINT_TO_INT</span><span class="p">(</span><span class="n">udiRxLen</span><span class="p">),</span> <span class="n">iShift</span><span class="o">:=-</span><span class="mi">1</span><span class="p">);</span>
                        <span class="n">IF</span> <span class="n">fbShiftByteArray</span><span class="o">.</span><span class="n">q_xError</span> <span class="n">THEN</span>
                            <span class="n">q_sResult</span><span class="o">:=</span><span class="s1">&#39;Transaction failed in step 30, while removing the stuffing Hans dropped some on the floor, oh Hans!&#39;</span><span class="p">;</span>
                            <span class="n">iStep</span><span class="o">:=</span><span class="mi">9000</span><span class="p">;</span>
                            <span class="n">RETURN</span><span class="p">;</span> <span class="o">//</span> <span class="n">this</span> <span class="n">way</span> <span class="n">we</span> <span class="n">catch</span> <span class="n">the</span> <span class="n">problem</span>
                            <span class="n">ELSE</span>
                                <span class="o">//</span><span class="n">iSeek</span> <span class="n">now</span> <span class="n">points</span> <span class="n">to</span> <span class="n">the</span> <span class="n">escaped</span> <span class="n">byte</span><span class="p">,</span> <span class="n">once</span> <span class="n">again</span> <span class="n">invert</span> <span class="n">the</span> <span class="n">fifth</span> <span class="n">bit</span> <span class="n">to</span> <span class="n">recover</span>
                                <span class="n">baRxData</span><span class="p">[</span><span class="n">iSeek</span><span class="p">]</span><span class="o">:=</span><span class="n">baRxData</span><span class="p">[</span><span class="n">iSeek</span><span class="p">]</span> <span class="n">XOR</span> <span class="mi">16</span><span class="c1">#10;</span>
                                <span class="o">//</span><span class="n">Reduce</span> <span class="n">the</span> <span class="n">message</span> <span class="n">length</span> <span class="n">by</span> <span class="n">one</span> <span class="n">byte</span>
                                <span class="n">udiRxLen</span> <span class="o">:=</span> <span class="n">udiRxLen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
                        <span class="n">END_IF</span>
                    <span class="n">END_IF</span>
                <span class="n">END_FOR</span>
                <span class="o">//</span><span class="n">Byte</span> <span class="n">stuffing</span> <span class="n">removed</span> <span class="ow">and</span> <span class="n">cleared</span> <span class="n">at</span> <span class="n">this</span> <span class="n">point</span>
                <span class="o">//</span><span class="n">Could</span> <span class="n">check</span> <span class="n">the</span> <span class="n">checksum</span> <span class="n">here</span><span class="o">...</span>
                <span class="o">//</span><span class="n">naaa</span>
                <span class="o">//</span><span class="n">Determine</span> <span class="n">the</span> <span class="n">Rx</span> <span class="n">data</span> <span class="n">length</span>
                <span class="n">bRxLen</span> <span class="o">:=</span> <span class="n">baRxData</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
                <span class="n">IF</span> <span class="n">i_bCmd</span> <span class="o">=</span> <span class="n">bCatch</span> <span class="ow">and</span> <span class="n">bRxLen</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
                <span class="n">MEMCPY</span><span class="p">(</span><span class="n">destAddr</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">q_baRxUnit</span><span class="p">),</span> <span class="n">srcAddr</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">baRxData</span><span class="p">),</span> <span class="n">n</span><span class="o">:=</span><span class="n">udiRxLen</span><span class="p">);</span>
                <span class="n">END_IF</span>
                <span class="o">//</span><span class="n">Snag</span> <span class="n">the</span> <span class="n">state</span> <span class="n">byte</span> <span class="k">while</span> <span class="n">we</span><span class="s1">&#39;re here</span>
                <span class="n">q_bState</span> <span class="o">:=</span> <span class="n">baRxData</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
                <span class="n">q_iRxLen</span> <span class="o">:=</span> <span class="n">BYTE_TO_INT</span><span class="p">(</span><span class="n">bRxLen</span><span class="p">);</span>
                <span class="o">//</span><span class="n">Memcpy</span> <span class="n">ze</span><span class="s1">&#39; data, check if memcpy is successful (returns other than zero) or bRxLen is zero (which causes memcpy to return zero)</span>
                <span class="n">IF</span> <span class="n">UDINT_TO_BOOL</span><span class="p">(</span><span class="n">MEMCPY</span><span class="p">(</span><span class="n">srcAddr</span><span class="o">:=</span><span class="p">(</span><span class="n">ADR</span><span class="p">(</span><span class="n">baRxData</span><span class="p">)</span><span class="o">+</span><span class="mi">5</span><span class="p">),</span> <span class="n">destAddr</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">q_baRxData</span><span class="p">),</span> <span class="n">n</span><span class="o">:=</span><span class="n">BYTE_TO_UINT</span><span class="p">(</span><span class="n">bRxLen</span><span class="p">)))</span> <span class="n">OR</span> <span class="p">(</span><span class="n">bRxLen</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="n">THEN</span>
                    <span class="n">q_sResult</span> <span class="o">:=</span> <span class="s1">&#39;Success&#39;</span><span class="p">;</span>
                    <span class="n">iStep</span><span class="o">:=</span><span class="mi">100</span><span class="p">;</span>
                    <span class="o">//</span><span class="n">For</span> <span class="n">debugging</span>
                    <span class="o">//</span><span class="n">MEMCPY</span><span class="p">(</span><span class="n">destAddr</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">q_abLastRxData</span><span class="p">[</span><span class="n">iDataRx</span><span class="p">,</span><span class="mi">1</span><span class="p">]),</span> <span class="n">srcAddr</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">baRxData</span><span class="p">),</span> <span class="n">n</span><span class="o">:=</span><span class="n">c_ArraySize</span><span class="p">);</span>
                    <span class="o">//</span><span class="n">IF</span> <span class="n">iDataRx</span> <span class="o">=</span> <span class="n">c_DebugArraySize</span> <span class="n">THEN</span> <span class="n">iDataRx</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ELSE</span> <span class="n">iDataRx</span> <span class="o">:=</span> <span class="n">iDataRx</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">END_IF</span>
                <span class="n">ELSE</span>
                    <span class="n">q_sResult</span> <span class="o">:=</span> <span class="s1">&#39;Memcpy step failed, expected some bytes but was NOT able to export them via memcpy, investigate transaction fb&#39;</span><span class="p">;</span>
                    <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
                <span class="n">END_IF</span>
            <span class="n">END_IF</span>
        <span class="n">END_IF</span>


    <span class="mi">100</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span> <span class="n">done</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">q_xDone</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
        <span class="n">IF</span>  <span class="n">i_xExecute</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="n">THEN</span>
            <span class="n">q_xDone</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">q_bState</span><span class="o">:=</span><span class="mi">16</span><span class="c1">#00;</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">END_IF</span>

    <span class="mi">9000</span><span class="p">:</span>
        <span class="n">q_xError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_CASE</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-shiftbytearray">FB_ShiftByteArray</a></p></li>
<li><p><a class="reference internal" href="#fshdlcchecksum">fSHDLCChecksum</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-serialcommwrapper">
<h2>FB_SerialCommWrapper<a class="headerlink" href="#fb-serialcommwrapper" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_SerialCommWrapper</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>

<span class="n">END_VAR</span>
<span class="n">VAR_IN_Out</span>
    <span class="n">stSerialComm</span> <span class="p">:</span> <span class="n">ST_SerialComm</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbSerialLineControl</span> <span class="p">:</span> <span class="n">SerialLineControl</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">fbSerialLineControl</span><span class="p">(</span>
    <span class="n">Mode</span><span class="o">:=</span> <span class="n">SERIALLINEMODE_EL6_22B</span> <span class="p">(</span><span class="o">*</span><span class="n">SERIALLINEMODE_KL6_22B_STANDARD</span><span class="o">*</span><span class="p">),</span>
    <span class="n">pComIn</span><span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">stSerialComm</span><span class="o">.</span><span class="n">stComIn</span><span class="p">),</span>
    <span class="n">pComOut</span><span class="o">:=</span><span class="n">ADR</span><span class="p">(</span><span class="n">stSerialComm</span><span class="o">.</span><span class="n">stComOut</span><span class="p">)</span> <span class="p">,</span>
    <span class="n">SizeComIn</span><span class="o">:=</span> <span class="n">UINT_TO_INT</span><span class="p">(</span><span class="n">SIZEOF</span><span class="p">(</span><span class="n">stSerialComm</span><span class="o">.</span><span class="n">stComOut</span><span class="p">)),</span>
    <span class="n">TxBuffer</span><span class="o">:=</span> <span class="n">stSerialComm</span><span class="o">.</span><span class="n">TxBuffer</span><span class="p">,</span>
    <span class="n">RxBuffer</span><span class="o">:=</span> <span class="n">stSerialComm</span><span class="o">.</span><span class="n">RxBuffer</span><span class="p">,</span>
    <span class="n">Error</span><span class="o">=&gt;</span> <span class="p">,</span>
    <span class="n">ErrorID</span><span class="o">=&gt;</span> <span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-serialcomm">ST_SerialComm</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-shiftbytearray">
<h2>FB_ShiftByteArray<a class="headerlink" href="#fb-shiftbytearray" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_ShiftByteArray</span>
<span class="n">VAR_INPUT</span>
    <span class="n">ptArray</span> <span class="p">:</span>       <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">BYTE</span><span class="p">;</span>
    <span class="n">iSize</span>   <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>
    <span class="n">iCurrIndex</span>      <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>
    <span class="n">iMessageLen</span>     <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>
    <span class="n">iShift</span>          <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">q_xError</span>        <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">howbig</span>  <span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">howbig</span> <span class="o">:=</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">ptArray</span><span class="o">^</span><span class="p">);</span>
<span class="o">//</span> <span class="n">Clear</span> <span class="n">error</span> <span class="n">bit</span>
<span class="n">q_xError</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">iMessageLen</span> <span class="o">=</span> <span class="n">iCurrIndex</span> <span class="n">THEN</span>
    <span class="o">//</span><span class="n">Dont</span> <span class="n">do</span> <span class="n">a</span> <span class="n">damn</span> <span class="n">thing</span>
    <span class="p">;</span>
<span class="o">//</span> <span class="n">Check</span> <span class="n">the</span> <span class="n">remaining</span> <span class="n">length</span> <span class="ow">and</span> <span class="n">shift</span> <span class="n">amount</span> <span class="n">summed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">greater</span> <span class="n">than</span> <span class="n">the</span> <span class="n">total</span> <span class="n">array</span> <span class="n">width</span><span class="o">.</span>
<span class="n">ELSIF</span> <span class="n">iSize</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">iMessageLen</span> <span class="o">-</span> <span class="n">iCurrIndex</span><span class="p">)</span> <span class="o">+</span> <span class="n">iShift</span> <span class="n">THEN</span>
    <span class="n">q_xError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">ELSE</span><span class="o">//</span> <span class="n">MEMMOVE</span> <span class="kn">from</span><span class="w"> </span><span class="mi">1</span><span class="o">+</span> <span class="n">the</span> <span class="n">current</span> <span class="n">index</span> <span class="n">to</span> <span class="n">the</span> <span class="n">remaining</span> <span class="n">length</span> <span class="n">by</span> <span class="n">the</span> <span class="n">shift</span> <span class="n">amount</span>
    <span class="n">IF</span> <span class="n">MEMMOVE</span><span class="p">(</span><span class="n">srcAddr</span><span class="o">:=</span><span class="p">(</span><span class="n">ptArray</span> <span class="o">+</span> <span class="n">iCurrIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">destAddr</span><span class="o">:=</span><span class="p">(</span><span class="n">ptArray</span> <span class="o">+</span> <span class="n">iCurrIndex</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">iShift</span><span class="p">),</span> <span class="n">n</span><span class="o">:=</span><span class="n">INT_TO_UDINT</span><span class="p">(</span><span class="n">iMessageLen</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">iCurrIndex</span><span class="p">))</span> <span class="o">=</span><span class="mi">0</span> <span class="n">THEN</span>
        <span class="n">q_xError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-solenoidpair">
<h2>FB_SolenoidPair<a class="headerlink" href="#fb-solenoidpair" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_SolenoidPair</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Valve</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="n">Open</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
     <span class="s1">&#39;}</span>
    <span class="n">q_xDO1</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span>   <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Valve</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="n">Open</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
     <span class="s1">&#39;}</span>
    <span class="n">q_xDO2</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span>   <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Switch</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">o</span>
     <span class="s1">&#39;}</span>
    <span class="n">i_xEpics</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="nb">open</span> <span class="n">A</span> <span class="n">when</span> <span class="kc">False</span><span class="p">,</span> <span class="nb">open</span> <span class="n">B</span> <span class="n">when</span> <span class="kc">True</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">Debug</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">o</span>
     <span class="s1">&#39;}</span>
    <span class="n">i_xDebug</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="k">if</span> <span class="kc">True</span><span class="p">,</span> <span class="n">do</span> <span class="ow">not</span> <span class="nb">set</span> <span class="n">valves</span> <span class="n">according</span> <span class="n">to</span> <span class="n">i_xEpics</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">If</span> <span class="n">debug</span><span class="p">,</span> <span class="nb">set</span> <span class="n">independently</span><span class="o">.</span> <span class="n">Else</span><span class="p">,</span> <span class="n">only</span> <span class="nb">open</span> <span class="n">one</span> <span class="n">valve</span> <span class="n">according</span> <span class="n">to</span> <span class="n">i_xEpics</span> <span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">i_xDebug</span> <span class="n">THEN</span>
    <span class="n">q_xDO1</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">i_xEpics</span><span class="p">;</span>
    <span class="n">q_xDO2</span> <span class="o">:=</span> <span class="n">i_xEpics</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-tecdriver">
<h2>FB_TECDriver<a class="headerlink" href="#fb-tecdriver" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_TECDriver</span>

<span class="n">VAR_INPUT</span>
    <span class="n">i_xExecute</span>                              <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>                                 <span class="p">(</span><span class="o">*</span> <span class="n">rising</span> <span class="n">edge</span> <span class="n">execute</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">i_tTimeOut</span>                              <span class="p">:</span> <span class="n">TIME</span> <span class="o">:=</span> <span class="n">t</span><span class="c1">#10s;                (* Maximum wait time for reply *)</span>
    <span class="n">i_stControl</span>                             <span class="p">:</span> <span class="n">ST_TECControl</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">q_xDone</span>                                 <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_xError</span>                                <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_xWarning</span>                              <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>                                 <span class="p">(</span><span class="o">*</span> <span class="nb">set</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">event</span> <span class="n">of</span> <span class="n">an</span> <span class="n">unexpected</span> <span class="n">reply</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">q_xTimeout</span>                              <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_sResult</span>                               <span class="p">:</span> <span class="n">STRING</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
    <span class="n">q_sLastSentString</span>               <span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..40</span><span class="p">]</span> <span class="n">OF</span> <span class="n">STRING</span><span class="p">;</span>                               <span class="p">(</span><span class="o">*</span> <span class="n">Last</span> <span class="n">String</span> <span class="n">Sent</span> <span class="n">to</span> <span class="n">Serial</span> <span class="n">Device</span> <span class="o">-</span> <span class="k">for</span> <span class="n">debugging</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">q_sLastReceivedString</span>   <span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..40</span><span class="p">]</span> <span class="n">OF</span> <span class="n">STRING</span><span class="p">;</span>                               <span class="p">(</span><span class="o">*</span> <span class="n">Last</span> <span class="n">String</span> <span class="n">Received</span> <span class="kn">from</span><span class="w"> </span><span class="nn">Serial</span> <span class="n">Device</span> <span class="o">-</span> <span class="k">for</span> <span class="n">debugging</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">q_stStatus</span>                              <span class="p">:</span> <span class="n">ST_TECStatus</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">iq_stSerialRXBuffer</span>     <span class="p">:</span> <span class="n">ComBuffer</span><span class="p">;</span>
    <span class="n">iq_stSerialTXBuffer</span>     <span class="p">:</span> <span class="n">ComBuffer</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">rtExecute</span>                               <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">iStep</span>                                   <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">sSendData</span>                               <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">fbTECTransaction</span>                <span class="p">:</span> <span class="n">FB_TECTransaction</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span><span class="n">fbFormatString</span>                        <span class="p">:</span> <span class="n">FB_FormatString</span><span class="p">;</span><span class="o">*</span><span class="p">)</span>
    <span class="p">(</span><span class="o">*</span><span class="n">fbSplit</span>                                       <span class="p">:</span> <span class="n">FB_Split255</span><span class="p">;</span><span class="o">*</span><span class="p">)</span>
    <span class="n">asReplyFields</span>                   <span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..20</span><span class="p">]</span> <span class="n">OF</span> <span class="n">T_MaxString</span><span class="p">;</span>
    <span class="n">wChecksum</span><span class="p">:</span> <span class="n">WORD</span><span class="p">;</span>
    <span class="n">rtStartIntegration</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">rtEndReset</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>

    <span class="n">sWorking</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">strResponseExpected</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">diWorking</span>       <span class="p">:</span>       <span class="n">DINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="n">performs</span> <span class="n">serial</span> <span class="n">communication</span> <span class="k">with</span> <span class="n">a</span> <span class="n">TC</span><span class="o">-</span><span class="mi">36</span><span class="o">-</span><span class="mi">25</span> <span class="n">TEC</span> <span class="n">Driver</span> <span class="o">*</span><span class="p">)</span>

<span class="p">(</span><span class="o">*</span> <span class="n">rising</span> <span class="n">edge</span> <span class="n">trigger</span> <span class="o">*</span><span class="p">)</span>
<span class="n">rtExecute</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="n">i_xExecute</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">rtExecute</span><span class="o">.</span><span class="n">Q</span>  <span class="n">THEN</span>
    <span class="n">q_xDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">q_xError</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">q_xWarning</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">q_xTimeout</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">q_sResult</span><span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="n">fbTECTransaction</span><span class="p">(</span> <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span> <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span> <span class="p">);</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>

    <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">CASE</span> <span class="n">iStep</span> <span class="n">OF</span>
    <span class="mi">0</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span> <span class="n">idle</span> <span class="o">*</span><span class="p">)</span>
        <span class="p">;</span>

    <span class="mi">10</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span> <span class="n">Get</span> <span class="n">Current</span> <span class="n">Temperature</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">fbTECTransaction</span><span class="p">(</span>
            <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
            <span class="n">i_sAddress</span><span class="o">:=</span><span class="n">i_stControl</span><span class="o">.</span><span class="n">sAddress</span><span class="p">,</span>
            <span class="n">i_sCmd</span><span class="o">:=</span> <span class="s1">&#39;01&#39;</span><span class="p">,</span>
            <span class="n">i_diParameter</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">i_tTimeOut</span><span class="o">:=</span> <span class="n">i_tTimeOut</span><span class="p">,</span>
            <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span>
            <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span><span class="p">,</span>
            <span class="n">i_CmdFlag</span> <span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>

        <span class="n">IF</span> <span class="n">fbTECTransaction</span><span class="o">.</span><span class="n">q_xError</span> <span class="n">THEN</span>
            <span class="n">q_sResult</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;in Step 10 serial transaction failed with message: &#39;</span><span class="p">,</span> <span class="n">fbTECTransaction</span><span class="o">.</span><span class="n">q_sResult</span><span class="p">);</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
        <span class="n">ELSIF</span> <span class="n">fbTECTransaction</span><span class="o">.</span><span class="n">q_xDone</span> <span class="n">THEN</span>
            <span class="n">q_stStatus</span><span class="o">.</span><span class="n">sReply</span> <span class="o">:=</span> <span class="n">fbTECTransaction</span><span class="o">.</span><span class="n">q_sResponseData</span><span class="p">;</span>
            <span class="n">sWorking</span> <span class="o">:=</span><span class="n">LEFT</span><span class="p">(</span><span class="n">q_stStatus</span><span class="o">.</span><span class="n">sReply</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
            <span class="n">sWorking</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;16#&#39;</span><span class="p">,</span> <span class="n">sWorking</span><span class="p">);</span>
            <span class="n">q_stStatus</span><span class="o">.</span><span class="n">diTemp1</span> <span class="o">:=</span> <span class="n">STRING_TO_DINT</span><span class="p">(</span><span class="n">sWorking</span><span class="p">);</span>
            <span class="n">fbTECTransaction</span><span class="p">(</span> <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span> <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span><span class="p">,</span> <span class="n">i_CmdFlag</span> <span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>

        <span class="n">END_IF</span>
    <span class="mi">20</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span> <span class="n">Read</span> <span class="n">setpoint</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">fbTECTransaction</span><span class="p">(</span>
            <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
            <span class="n">i_sAddress</span><span class="o">:=</span><span class="n">i_stControl</span><span class="o">.</span><span class="n">sAddress</span><span class="p">,</span>
            <span class="n">i_sCmd</span><span class="o">:=</span> <span class="s1">&#39;03&#39;</span><span class="p">,</span> <span class="o">//</span> <span class="n">command</span>
            <span class="n">i_diParameter</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">//</span> <span class="n">always</span> <span class="n">zero</span> <span class="k">for</span> <span class="n">query</span>
            <span class="n">i_tTimeOut</span><span class="o">:=</span> <span class="n">i_tTimeOut</span><span class="p">,</span>
            <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span>
            <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span><span class="p">,</span>
            <span class="n">i_CmdFlag</span> <span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>

        <span class="n">IF</span> <span class="n">fbTECTransaction</span><span class="o">.</span><span class="n">q_xError</span> <span class="n">THEN</span>
            <span class="n">q_sResult</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;in Step 20 serial transaction failed with message: &#39;</span><span class="p">,</span> <span class="n">fbTECTransaction</span><span class="o">.</span><span class="n">q_sResult</span><span class="p">);</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
        <span class="n">ELSIF</span> <span class="n">fbTECTransaction</span><span class="o">.</span><span class="n">q_xDone</span> <span class="n">THEN</span>
            <span class="n">q_stStatus</span><span class="o">.</span><span class="n">sReply</span> <span class="o">:=</span> <span class="n">fbTECTransaction</span><span class="o">.</span><span class="n">q_sResponseData</span><span class="p">;</span>
            <span class="n">sWorking</span> <span class="o">:=</span><span class="n">LEFT</span><span class="p">(</span><span class="n">q_stStatus</span><span class="o">.</span><span class="n">sReply</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
            <span class="n">sWorking</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;16#&#39;</span><span class="p">,</span> <span class="n">sWorking</span><span class="p">);</span>
            <span class="n">q_stStatus</span><span class="o">.</span><span class="n">diSetPoint</span> <span class="o">:=</span> <span class="n">STRING_TO_DINT</span><span class="p">(</span><span class="n">sWorking</span><span class="p">);</span>
            <span class="n">fbTECTransaction</span><span class="p">(</span> <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span> <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span><span class="p">,</span> <span class="n">i_CmdFlag</span> <span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">25</span><span class="p">;</span>
        <span class="n">END_IF</span>

    <span class="mi">25</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span> <span class="n">Read</span> <span class="n">output</span> <span class="n">ON</span><span class="o">/</span><span class="n">OFF</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">fbTECTransaction</span><span class="p">(</span>
            <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
            <span class="n">i_sAddress</span><span class="o">:=</span><span class="n">i_stControl</span><span class="o">.</span><span class="n">sAddress</span><span class="p">,</span>
            <span class="n">i_sCmd</span><span class="o">:=</span> <span class="s1">&#39;46&#39;</span><span class="p">,</span> <span class="o">//</span> <span class="n">command</span>
            <span class="n">i_diParameter</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">//</span> <span class="n">always</span> <span class="n">zero</span> <span class="k">for</span> <span class="n">query</span>
            <span class="n">i_tTimeOut</span><span class="o">:=</span> <span class="n">i_tTimeOut</span><span class="p">,</span>
            <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span>
            <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span><span class="p">,</span>
            <span class="n">i_CmdFlag</span> <span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>

        <span class="n">IF</span> <span class="n">fbTECTransaction</span><span class="o">.</span><span class="n">q_xError</span> <span class="n">THEN</span>
            <span class="n">q_sResult</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;in Step 25 serial transaction failed with message: &#39;</span><span class="p">,</span> <span class="n">fbTECTransaction</span><span class="o">.</span><span class="n">q_sResult</span><span class="p">);</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
        <span class="n">ELSIF</span> <span class="n">fbTECTransaction</span><span class="o">.</span><span class="n">q_xDone</span> <span class="n">THEN</span>
            <span class="n">q_stStatus</span><span class="o">.</span><span class="n">sReply</span> <span class="o">:=</span> <span class="n">fbTECTransaction</span><span class="o">.</span><span class="n">q_sResponseData</span><span class="p">;</span>
            <span class="n">sWorking</span> <span class="o">:=</span><span class="n">LEFT</span><span class="p">(</span><span class="n">q_stStatus</span><span class="o">.</span><span class="n">sReply</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
            <span class="n">sWorking</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;16#&#39;</span><span class="p">,</span> <span class="n">sWorking</span><span class="p">);</span>
            <span class="n">diWorking</span> <span class="o">:=</span> <span class="n">STRING_TO_DINT</span><span class="p">(</span><span class="n">sWorking</span><span class="p">);</span>
            <span class="n">q_stStatus</span><span class="o">.</span><span class="n">xOutputOn</span> <span class="o">:=</span> <span class="n">DINT_TO_BOOL</span><span class="p">(</span><span class="n">diWorking</span><span class="p">);</span>
            <span class="n">A_ResetTransaction</span><span class="p">();</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">30</span><span class="p">;</span>
        <span class="n">END_IF</span>

    <span class="mi">30</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span> <span class="n">Read</span> <span class="n">the</span> <span class="n">alarm</span> <span class="n">status</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">fbTECTransaction</span><span class="p">(</span>
            <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
            <span class="n">i_sAddress</span><span class="o">:=</span><span class="n">i_stControl</span><span class="o">.</span><span class="n">sAddress</span><span class="p">,</span>
            <span class="n">i_sCmd</span><span class="o">:=</span> <span class="s1">&#39;05&#39;</span><span class="p">,</span> <span class="o">//</span> <span class="n">command</span>
            <span class="n">i_diParameter</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">//</span> <span class="n">always</span> <span class="n">zero</span> <span class="k">for</span> <span class="n">query</span>
            <span class="n">i_tTimeOut</span><span class="o">:=</span> <span class="n">i_tTimeOut</span><span class="p">,</span>
            <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span>
            <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span><span class="p">,</span>
            <span class="n">i_CmdFlag</span> <span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>

        <span class="n">IF</span> <span class="n">fbTECTransaction</span><span class="o">.</span><span class="n">q_xError</span> <span class="n">THEN</span>
            <span class="n">q_sResult</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;in Step 10 serial transaction failed with message: &#39;</span><span class="p">,</span> <span class="n">fbTECTransaction</span><span class="o">.</span><span class="n">q_sResult</span><span class="p">);</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
        <span class="n">ELSIF</span> <span class="n">fbTECTransaction</span><span class="o">.</span><span class="n">q_xDone</span> <span class="n">THEN</span>
            <span class="n">q_stStatus</span><span class="o">.</span><span class="n">sReply</span> <span class="o">:=</span> <span class="n">fbTECTransaction</span><span class="o">.</span><span class="n">q_sResponseData</span><span class="p">;</span>
            <span class="n">sWorking</span> <span class="o">:=</span><span class="n">LEFT</span><span class="p">(</span><span class="n">q_stStatus</span><span class="o">.</span><span class="n">sReply</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
            <span class="n">sWorking</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;16#&#39;</span><span class="p">,</span> <span class="n">sWorking</span><span class="p">);</span>
            <span class="n">diWorking</span> <span class="o">:=</span> <span class="n">STRING_TO_DINT</span><span class="p">(</span><span class="n">sWorking</span><span class="p">);</span>

            <span class="o">//</span><span class="n">Alarm</span> <span class="n">assignment</span>
            <span class="n">q_stStatus</span><span class="o">.</span><span class="n">xHiTemp</span>      <span class="o">:=</span>      <span class="n">diWorking</span><span class="mf">.0</span><span class="p">;</span>
            <span class="n">q_stStatus</span><span class="o">.</span><span class="n">xLoTemp</span>      <span class="o">:=</span>      <span class="n">diWorking</span><span class="mf">.1</span><span class="p">;</span>
            <span class="n">q_stStatus</span><span class="o">.</span><span class="n">xLoTemp</span>      <span class="o">:=</span>      <span class="n">diWorking</span><span class="mf">.2</span><span class="p">;</span>
            <span class="n">q_stStatus</span><span class="o">.</span><span class="n">xOverCurrent</span> <span class="o">:=</span>      <span class="n">diWorking</span><span class="mf">.3</span><span class="p">;</span>
            <span class="n">q_stStatus</span><span class="o">.</span><span class="n">xOpenInput1</span>  <span class="o">:=</span>      <span class="n">diWorking</span><span class="mf">.4</span><span class="p">;</span>
            <span class="n">q_stStatus</span><span class="o">.</span><span class="n">xOpenInput2</span>  <span class="o">:=</span>      <span class="n">diWorking</span><span class="mf">.5</span><span class="p">;</span>
            <span class="n">q_stStatus</span><span class="o">.</span><span class="n">xDriverLowVoltage</span>    <span class="o">:=</span>      <span class="n">diWorking</span><span class="mf">.6</span><span class="p">;</span>

            <span class="n">fbTECTransaction</span><span class="p">(</span> <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span> <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span><span class="p">,</span> <span class="n">i_CmdFlag</span> <span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">40</span><span class="p">;</span>
        <span class="n">END_IF</span>

    <span class="mi">40</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span> <span class="n">Output</span> <span class="n">Power</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">fbTECTransaction</span><span class="p">(</span>
            <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
            <span class="n">i_sAddress</span><span class="o">:=</span><span class="n">i_stControl</span><span class="o">.</span><span class="n">sAddress</span><span class="p">,</span>
            <span class="n">i_sCmd</span><span class="o">:=</span> <span class="s1">&#39;02&#39;</span><span class="p">,</span> <span class="o">//</span> <span class="n">command</span>
            <span class="n">i_diParameter</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">//</span> <span class="n">always</span> <span class="n">zero</span> <span class="k">for</span> <span class="n">query</span>
            <span class="n">i_tTimeOut</span><span class="o">:=</span> <span class="n">i_tTimeOut</span><span class="p">,</span>
            <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span>
            <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span><span class="p">,</span>
            <span class="n">i_CmdFlag</span> <span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>

        <span class="n">IF</span> <span class="n">fbTECTransaction</span><span class="o">.</span><span class="n">q_xError</span> <span class="n">THEN</span>
            <span class="n">q_sResult</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;in Step 10 serial transaction failed with message: &#39;</span><span class="p">,</span> <span class="n">fbTECTransaction</span><span class="o">.</span><span class="n">q_sResult</span><span class="p">);</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
        <span class="n">ELSIF</span> <span class="n">fbTECTransaction</span><span class="o">.</span><span class="n">q_xDone</span> <span class="n">THEN</span>
            <span class="n">q_stStatus</span><span class="o">.</span><span class="n">sReply</span> <span class="o">:=</span> <span class="n">fbTECTransaction</span><span class="o">.</span><span class="n">q_sResponseData</span><span class="p">;</span>
            <span class="n">sWorking</span> <span class="o">:=</span><span class="n">LEFT</span><span class="p">(</span><span class="n">q_stStatus</span><span class="o">.</span><span class="n">sReply</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
            <span class="n">sWorking</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;16#&#39;</span><span class="p">,</span> <span class="n">sWorking</span><span class="p">);</span>
            <span class="n">diWorking</span> <span class="o">:=</span> <span class="n">STRING_TO_DINT</span><span class="p">(</span><span class="n">sWorking</span><span class="p">);</span>

            <span class="n">q_stStatus</span><span class="o">.</span><span class="n">diPercentOut</span> <span class="o">:=</span> <span class="p">(</span><span class="n">diWorking</span><span class="o">/</span><span class="mi">511</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">;</span> <span class="o">//</span><span class="ow">in</span> <span class="n">percentage</span>

            <span class="n">fbTECTransaction</span><span class="p">(</span> <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span> <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span><span class="p">,</span> <span class="n">i_CmdFlag</span> <span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">5000</span><span class="p">;</span>
        <span class="n">END_IF</span>

    <span class="mi">5000</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span> <span class="n">Change</span> <span class="n">Setpoint</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">IF</span> <span class="n">q_stStatus</span><span class="o">.</span><span class="n">diSetpoint</span> <span class="o">&lt;&gt;</span> <span class="n">i_stControl</span><span class="o">.</span><span class="n">diTempSetpoint</span> <span class="n">THEN</span>

            <span class="n">fbTECTransaction</span><span class="p">(</span>
                <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
                <span class="n">i_sAddress</span><span class="o">:=</span><span class="n">i_stControl</span><span class="o">.</span><span class="n">sAddress</span><span class="p">,</span>
                <span class="n">i_sCmd</span><span class="o">:=</span> <span class="s1">&#39;1c&#39;</span><span class="p">,</span> <span class="o">//</span> <span class="n">command</span>
                <span class="n">i_diParameter</span> <span class="o">:=</span> <span class="n">i_stControl</span><span class="o">.</span><span class="n">diTempSetpoint</span><span class="p">,</span>
                <span class="n">i_tTimeOut</span><span class="o">:=</span> <span class="n">i_tTimeOut</span><span class="p">,</span>
                <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span>
                <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span><span class="p">,</span>
                <span class="n">i_CmdFlag</span> <span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>
            <span class="n">IF</span> <span class="n">fbTECTransaction</span><span class="o">.</span><span class="n">q_xError</span> <span class="n">THEN</span>
                <span class="n">q_sResult</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;in Step 5000 serial transaction failed with message: &#39;</span><span class="p">,</span> <span class="n">fbTECTransaction</span><span class="o">.</span><span class="n">q_sResult</span><span class="p">);</span>
                <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
            <span class="n">ELSIF</span> <span class="n">fbTECTransaction</span><span class="o">.</span><span class="n">q_xDone</span> <span class="n">THEN</span>
                <span class="n">fbTECTransaction</span><span class="p">(</span>
                     <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span>
                    <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span>
                    <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span><span class="p">,</span>
                    <span class="n">i_CmdFlag</span><span class="o">:=</span><span class="n">FALSE</span> <span class="p">);</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
                <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">5010</span><span class="p">;</span>
            <span class="n">END_IF</span>
        <span class="n">ELSE</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">5010</span><span class="p">;</span>
        <span class="n">END_IF</span>

    <span class="mi">5010</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span> <span class="n">Output</span> <span class="n">ON</span><span class="o">/</span><span class="n">OFF</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">IF</span> <span class="n">q_stStatus</span><span class="o">.</span><span class="n">xOutputOn</span> <span class="o">&lt;&gt;</span> <span class="n">i_stControl</span><span class="o">.</span><span class="n">xOutputOn</span> <span class="n">THEN</span>

            <span class="n">fbTECTransaction</span><span class="p">(</span>
                <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
                <span class="n">i_sAddress</span><span class="o">:=</span><span class="n">i_stControl</span><span class="o">.</span><span class="n">sAddress</span><span class="p">,</span>
                <span class="n">i_sCmd</span><span class="o">:=</span> <span class="s1">&#39;2d&#39;</span><span class="p">,</span> <span class="o">//</span> <span class="n">command</span>
                <span class="n">i_diParameter</span> <span class="o">:=</span> <span class="n">BOOL_TO_DINT</span><span class="p">(</span><span class="n">i_stControl</span><span class="o">.</span><span class="n">xOutputOn</span><span class="p">),</span>
                <span class="n">i_tTimeOut</span><span class="o">:=</span> <span class="n">i_tTimeOut</span><span class="p">,</span>
                <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span>
                <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span><span class="p">,</span>
                <span class="n">i_CmdFlag</span> <span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>
            <span class="n">IF</span> <span class="n">fbTECTransaction</span><span class="o">.</span><span class="n">q_xError</span> <span class="n">THEN</span>
                <span class="n">q_sResult</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;in Step 5010 serial transaction failed with message: &#39;</span><span class="p">,</span> <span class="n">fbTECTransaction</span><span class="o">.</span><span class="n">q_sResult</span><span class="p">);</span>
                <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
            <span class="n">ELSIF</span> <span class="n">fbTECTransaction</span><span class="o">.</span><span class="n">q_xDone</span> <span class="n">THEN</span>
                <span class="n">fbTECTransaction</span><span class="p">(</span>
                     <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span>
                    <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span>
                    <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span><span class="p">,</span>
                    <span class="n">i_CmdFlag</span><span class="o">:=</span><span class="n">FALSE</span> <span class="p">);</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
                <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">8000</span><span class="p">;</span>
            <span class="n">END_IF</span>
        <span class="n">ELSE</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">8000</span><span class="p">;</span>
        <span class="n">END_IF</span>


    <span class="mi">8000</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span> <span class="n">done</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">q_xDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">IF</span> <span class="n">q_sResult</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="n">THEN</span>
            <span class="n">q_sResult</span> <span class="o">:=</span> <span class="s1">&#39;Success&#39;</span><span class="p">;</span>
            <span class="n">q_stStatus</span><span class="o">.</span><span class="n">xStatusValid</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">END_IF</span>
        <span class="n">IF</span>  <span class="n">i_xExecute</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="n">THEN</span>
            <span class="n">q_xDone</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">END_IF</span>

    <span class="mi">9000</span><span class="p">:</span>
        <span class="n">_A_ClearStatus</span><span class="p">();</span>
        <span class="n">q_xTimeout</span> <span class="o">:=</span> <span class="n">fbTECTransaction</span><span class="o">.</span><span class="n">q_xTimeout</span><span class="p">;</span>
        <span class="n">q_xError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">q_stStatus</span><span class="o">.</span><span class="n">xStatusValid</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>


<span class="n">END_CASE</span>

<span class="n">q_sLastSentString</span> <span class="o">:=</span> <span class="n">fbTECTransaction</span><span class="o">.</span><span class="n">q_sLastSentString</span><span class="p">;</span>
<span class="n">q_sLastReceivedString</span> <span class="o">:=</span> <span class="n">fbTECTransaction</span><span class="o">.</span><span class="n">q_sLastReceivedString</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">A_ResetTransaction</span><span class="p">:</span>
<span class="n">fbTECTransaction</span><span class="p">(</span> <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span> <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span><span class="p">,</span> <span class="n">i_CmdFlag</span> <span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">_A_ClearStatus</span><span class="p">:</span>
<span class="n">q_stStatus</span><span class="o">.</span><span class="n">sReply</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-tectransaction">FB_TECTransaction</a></p></li>
<li><p><a class="reference internal" href="#st-teccontrol">ST_TECControl</a></p></li>
<li><p><a class="reference internal" href="#st-tecstatus">ST_TECStatus</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-tectransaction">
<h2>FB_TECTransaction<a class="headerlink" href="#fb-tectransaction" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_TECTransaction</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_xExecute</span>                              <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>                           <span class="p">(</span><span class="o">*</span> <span class="n">Rising</span> <span class="n">edge</span> <span class="n">execute</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">i_sCmd</span>                                  <span class="p">:</span>       <span class="n">STRING</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>                      <span class="p">(</span><span class="o">*</span> <span class="n">Send</span> <span class="n">Data</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">i_sAddress</span>                              <span class="p">:</span>       <span class="n">STRING</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
    <span class="n">i_diParameter</span>                   <span class="p">:</span>       <span class="n">DINT</span><span class="p">;</span>
    <span class="n">i_tTimeOut</span>                              <span class="p">:</span>       <span class="n">TIME</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#10S;          (* Maximum wait time for reply *)</span>
    <span class="n">i_CmdFlag</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">q_xDone</span>                                 <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_sResponseData</span>                 <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">q_xError</span>                                <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_xTimeout</span>                              <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_sResult</span>                               <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">q_sLastSentString</span>               <span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..40</span><span class="p">]</span> <span class="n">OF</span> <span class="n">STRING</span><span class="p">;</span>                       <span class="p">(</span><span class="o">*</span> <span class="n">Last</span> <span class="n">String</span> <span class="n">Sent</span> <span class="n">to</span> <span class="n">Serial</span> <span class="n">Device</span> <span class="o">-</span> <span class="k">for</span> <span class="n">debugging</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">q_sLastReceivedString</span>   <span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..40</span><span class="p">]</span> <span class="n">OF</span> <span class="n">STRING</span><span class="p">;</span>                       <span class="p">(</span><span class="o">*</span> <span class="n">Last</span> <span class="n">String</span> <span class="n">Received</span> <span class="kn">from</span><span class="w"> </span><span class="nn">Serial</span> <span class="n">Device</span> <span class="o">-</span> <span class="k">for</span> <span class="n">debugging</span> <span class="o">*</span><span class="p">)</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">iq_stSerialRXBuffer</span>     <span class="p">:</span> <span class="n">ComBuffer</span><span class="p">;</span>
    <span class="n">iq_stSerialTXBuffer</span>     <span class="p">:</span> <span class="n">ComBuffer</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">rtExecute</span>                               <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">iStep</span>                                   <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">fbClearComBuffer</span>                <span class="p">:</span> <span class="n">ClearComBuffer</span><span class="p">;</span>
    <span class="n">fbSendString</span>                    <span class="p">:</span> <span class="n">SendString</span><span class="p">;</span>
    <span class="n">fbReceiveString</span>                 <span class="p">:</span> <span class="n">ReceiveString</span><span class="p">;</span>
    <span class="n">sReceivedString</span>                 <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">tonTimeout</span>                              <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">sSendString</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">iStringTx</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">iStringRx</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="n">iStringTxRx</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">sTxRxString</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..40</span><span class="p">]</span> <span class="n">OF</span> <span class="n">STRING</span><span class="p">;</span>

    <span class="n">fbFormatParamString</span>     <span class="p">:</span>       <span class="n">FB_FormatString</span><span class="p">;</span>
    <span class="n">fbFormatParamZPadString</span> <span class="p">:</span>       <span class="n">FB_FormatString</span><span class="p">;</span>
    <span class="n">fbFormatCSString</span>        <span class="p">:</span>       <span class="n">FB_FormatString</span><span class="p">;</span>
    <span class="n">sParameter</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">iIndexChkSum</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">wCsSum</span><span class="p">:</span> <span class="n">WORD</span><span class="p">;</span>
    <span class="n">udiParameter</span><span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="n">performs</span> <span class="n">serial</span> <span class="n">transactions</span> <span class="k">with</span> <span class="n">a</span> <span class="n">TC</span><span class="o">-</span><span class="mi">36</span><span class="o">-</span><span class="mi">25</span> <span class="n">TEC</span> <span class="n">Driver</span>  <span class="o">*</span><span class="p">)</span>

<span class="p">(</span><span class="o">*</span> <span class="n">rising</span> <span class="n">edge</span> <span class="n">trigger</span> <span class="o">*</span><span class="p">)</span>
<span class="n">rtExecute</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="n">i_xExecute</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">rtExecute</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">q_xDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">q_sResponseData</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="n">q_xError</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">q_xTimeout</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">q_sResult</span><span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="n">q_sLastSentString</span><span class="p">[</span><span class="n">iStringTx</span><span class="p">]</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="n">q_sLastReceivedString</span><span class="p">[</span><span class="n">iStringRx</span><span class="p">]</span><span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">CASE</span> <span class="n">iStep</span> <span class="n">OF</span>
    <span class="mi">0</span><span class="p">:</span>
        <span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">idle</span> <span class="o">*</span><span class="p">)</span>

    <span class="mi">10</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span> <span class="n">clear</span> <span class="n">com</span> <span class="n">buffers</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">fbClearComBuffer</span><span class="p">(</span><span class="n">Buffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">);</span>
        <span class="n">fbClearComBuffer</span><span class="p">(</span><span class="n">Buffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span><span class="p">);</span>
        <span class="p">(</span><span class="o">*</span> <span class="n">Reset</span> <span class="n">receive</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">fbReceiveString</span><span class="p">(</span>
            <span class="n">Reset</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
            <span class="n">ReceivedString</span><span class="o">:=</span> <span class="n">sReceivedString</span><span class="p">,</span>
            <span class="n">RXbuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span> <span class="p">);</span>
        <span class="p">(</span><span class="o">*</span> <span class="n">build</span> <span class="n">the</span> <span class="n">string</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">sSendString</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">i_sAddress</span><span class="p">,</span> <span class="n">i_sCmd</span><span class="p">);</span> <span class="p">(</span><span class="o">*</span> <span class="n">adding</span> <span class="n">the</span> <span class="n">address</span> <span class="ow">and</span> <span class="n">command</span><span class="o">/</span><span class="n">query</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">IF</span> <span class="n">i_CmdFlag</span> <span class="n">THEN</span>
            <span class="p">(</span><span class="o">*</span> <span class="n">Convert</span> <span class="n">the</span> <span class="n">parameter</span> <span class="n">into</span> <span class="n">an</span> <span class="mi">8</span><span class="o">-</span><span class="n">wide</span> <span class="nb">hex</span> <span class="n">string</span> <span class="n">twos</span> <span class="n">complemented</span><span class="o">*</span><span class="p">)</span>
            <span class="n">udiParameter</span> <span class="o">:=</span> <span class="n">DINT_TO_UDINT</span><span class="p">(</span><span class="n">i_diParameter</span><span class="p">);</span>
            <span class="n">fbFormatParamString</span><span class="p">(</span><span class="n">sFormat</span><span class="o">:=</span> <span class="s1">&#39;</span><span class="si">%x</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">arg1</span><span class="o">:=</span><span class="n">F_UDINT</span><span class="p">(</span><span class="n">udiParameter</span><span class="p">));</span> <span class="o">//</span> <span class="n">first</span> <span class="n">convert</span> <span class="n">to</span> <span class="n">a</span> <span class="n">string</span>
            <span class="n">fbFormatParamZPadString</span><span class="p">(</span><span class="n">sFormat</span><span class="o">:=</span><span class="s1">&#39;</span><span class="si">%08s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">arg1</span><span class="o">:=</span><span class="n">F_STRING</span><span class="p">(</span><span class="n">fbFormatParamString</span><span class="o">.</span><span class="n">sOut</span><span class="p">));</span><span class="o">//</span> <span class="n">then</span> <span class="n">zero</span> <span class="n">pad</span><span class="p">,</span> <span class="n">because</span> <span class="n">FB_Format</span> <span class="n">string</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">zero</span><span class="o">-</span><span class="n">pad</span> <span class="nb">hex</span> <span class="n">strings</span> <span class="n">naturally</span>
            <span class="n">sParameter</span> <span class="o">:=</span> <span class="n">fbFormatParamZPadString</span><span class="o">.</span><span class="n">sOut</span><span class="p">;</span>
        <span class="n">ELSE</span>
            <span class="n">sParameter</span> <span class="o">:=</span> <span class="s1">&#39;00000000&#39;</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">send</span> <span class="n">zeros</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;re querying *)</span>
        <span class="n">END_IF</span>
        <span class="p">(</span><span class="o">*</span> <span class="n">Add</span> <span class="n">parameter</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">sSendString</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">sSendString</span><span class="p">,</span> <span class="n">sParameter</span><span class="p">);</span>

        <span class="p">(</span><span class="o">*</span> <span class="n">Compute</span> <span class="n">checksum</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">A_Checksum</span><span class="p">();</span>

        <span class="p">(</span><span class="o">*</span> <span class="n">add</span> <span class="n">stx</span> <span class="n">at</span> <span class="n">start</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">sSendString</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">sSendString</span><span class="p">);</span>
        <span class="p">(</span><span class="o">*</span> <span class="n">append</span> <span class="n">checksum</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">fbFormatCSString</span><span class="p">(</span><span class="n">sFormat</span> <span class="o">:=</span> <span class="s1">&#39;</span><span class="si">%02x</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">arg1</span><span class="o">:=</span><span class="n">F_WORD</span><span class="p">(</span><span class="n">wCsSum</span><span class="p">));</span>
        <span class="n">sSendString</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">sSendString</span><span class="p">,</span> <span class="n">fbFormatCSString</span><span class="o">.</span><span class="n">sOut</span><span class="p">);</span>
         <span class="p">(</span><span class="o">*</span><span class="n">adding</span> <span class="n">tail</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">sSendString</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">sSendString</span><span class="p">,</span><span class="s1">&#39;$R&#39;</span><span class="p">);</span> <span class="p">(</span><span class="o">*</span> <span class="n">add</span> <span class="o">&lt;</span><span class="n">cr</span><span class="o">&gt;</span> <span class="o">*</span><span class="p">)</span>

        <span class="n">IF</span> <span class="n">fbFormatParamString</span><span class="o">.</span><span class="n">bError</span> <span class="n">OR</span> <span class="n">fbFormatCSString</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
            <span class="n">q_sResult</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;In step 10 fbFormatString resulted in error: &#39;</span><span class="p">,</span> <span class="n">UDINT_TO_STRING</span><span class="p">(</span><span class="n">fbFormatParamString</span><span class="o">.</span><span class="n">nErrId</span><span class="p">));</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
        <span class="n">ELSE</span>
            <span class="n">fbSendString</span><span class="p">(</span> <span class="n">SendString</span><span class="o">:=</span> <span class="n">sSendString</span><span class="p">,</span> <span class="n">TXbuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span> <span class="p">);</span>
        <span class="n">END_IF</span>
        <span class="n">q_sLastSentString</span><span class="p">[</span><span class="n">iStringTx</span><span class="p">]</span> <span class="o">:=</span> <span class="n">sSendString</span><span class="p">;</span>
        <span class="n">IF</span> <span class="n">iStringTx</span> <span class="o">=</span> <span class="mi">40</span> <span class="n">THEN</span> <span class="n">iStringTx</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ELSE</span> <span class="n">iStringTx</span> <span class="o">:=</span> <span class="n">iStringTx</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">END_IF</span>
        <span class="n">iStep</span> <span class="o">:=</span> <span class="n">iStep</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>

    <span class="mi">20</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span> <span class="n">Finish</span> <span class="n">sending</span> <span class="n">the</span> <span class="n">String</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">IF</span> <span class="n">fbSendString</span><span class="o">.</span><span class="n">Busy</span> <span class="n">THEN</span>
            <span class="n">fbSendString</span><span class="p">(</span> <span class="n">SendString</span><span class="o">:=</span> <span class="n">sSendString</span><span class="p">,</span> <span class="n">TXbuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span> <span class="p">);</span>
        <span class="n">ELSIF</span> <span class="n">fbSendString</span><span class="o">.</span><span class="n">Error</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
            <span class="n">q_sResult</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;In step 20 fbSendString resulted in error: &#39;</span><span class="p">,</span> <span class="n">INT_TO_STRING</span><span class="p">(</span><span class="n">fbSendString</span><span class="o">.</span><span class="n">Error</span><span class="p">));</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
        <span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">fbSendString</span><span class="o">.</span><span class="n">Busy</span> <span class="n">THEN</span>
            <span class="n">iStep</span><span class="o">:=</span><span class="n">iStep</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>
        <span class="n">END_IF</span>
        <span class="n">tonTimeout</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">);</span>

    <span class="mi">30</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span> <span class="n">Get</span> <span class="n">reply</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">fbReceiveString</span><span class="p">(</span>
            <span class="n">Prefix</span><span class="o">:=</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span>
            <span class="n">Suffix</span><span class="o">:=</span> <span class="s1">&#39;^&#39;</span><span class="p">,</span>
            <span class="n">Timeout</span><span class="o">:=</span> <span class="n">i_tTimeOut</span><span class="p">,</span>
            <span class="n">Reset</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span>
            <span class="n">ReceivedString</span><span class="o">:=</span> <span class="n">sReceivedString</span><span class="p">,</span>
            <span class="n">RXbuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span> <span class="p">);</span>
        <span class="n">tonTimeout</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span> <span class="n">i_tTimeOut</span><span class="p">);</span>
        <span class="n">IF</span> <span class="n">fbReceiveString</span><span class="o">.</span><span class="n">Error</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
            <span class="n">q_sResult</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;In step 30 fbReceiveString resulted in error: &#39;</span><span class="p">,</span> <span class="n">INT_TO_STRING</span><span class="p">(</span><span class="n">fbReceiveString</span><span class="o">.</span><span class="n">Error</span><span class="p">));</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
        <span class="n">ELSIF</span> <span class="n">fbReceiveString</span><span class="o">.</span><span class="n">RxTimeout</span> <span class="n">OR</span> <span class="n">tonTimeout</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
            <span class="n">q_sResult</span> <span class="o">:=</span> <span class="s1">&#39;Serial device failed to reply within timeout period&#39;</span><span class="p">;</span>
            <span class="n">q_xTimeout</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
        <span class="n">ELSIF</span> <span class="n">fbReceiveString</span><span class="o">.</span><span class="n">StringReceived</span> <span class="n">THEN</span>
            <span class="n">q_sLastReceivedString</span><span class="p">[</span><span class="n">iStringRx</span><span class="p">]</span> <span class="o">:=</span> <span class="n">sReceivedString</span><span class="p">;</span>
            <span class="n">IF</span> <span class="n">iStringRx</span> <span class="o">=</span> <span class="mi">40</span> <span class="n">THEN</span> <span class="n">iStringRx</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ELSE</span> <span class="n">iStringRx</span> <span class="o">:=</span> <span class="n">iStringRx</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">END_IF</span>
            <span class="n">IF</span> <span class="n">LEN</span><span class="p">(</span><span class="n">sReceivedString</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="n">THEN</span>
                <span class="n">q_sResult</span> <span class="o">:=</span> <span class="s1">&#39;Reply too short.&#39;</span><span class="p">;</span>
                <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
            <span class="n">ELSE</span>
                <span class="p">(</span><span class="o">*</span> <span class="n">Removing</span> <span class="n">stx</span> <span class="ow">and</span> <span class="n">ack</span> <span class="o">*</span><span class="p">)</span>
                <span class="n">q_sResponseData</span> <span class="o">:=</span> <span class="n">LEFT</span><span class="p">(</span><span class="n">sReceivedString</span><span class="p">,</span><span class="n">LEN</span><span class="p">(</span><span class="n">sReceivedString</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
                <span class="n">q_sResponseData</span> <span class="o">:=</span> <span class="n">RIGHT</span><span class="p">(</span><span class="n">q_sResponseData</span><span class="p">,</span><span class="n">LEN</span><span class="p">(</span><span class="n">q_sResponseData</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
                <span class="p">(</span><span class="o">*</span> <span class="n">Checking</span> <span class="k">for</span> <span class="n">error</span> <span class="n">messages</span> <span class="o">*</span><span class="p">)</span>
                <span class="n">IF</span> <span class="n">q_sResponseData</span> <span class="o">=</span> <span class="s1">&#39;XXXXXXXXc0&#39;</span> <span class="n">THEN</span>
                        <span class="n">q_sResult</span> <span class="o">:=</span> <span class="s1">&#39;Checksum error reported by driver&#39;</span><span class="p">;</span>
                        <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
                <span class="n">END_IF</span>
                <span class="n">q_sResult</span> <span class="o">:=</span> <span class="s1">&#39;Success.&#39;</span><span class="p">;</span>
                <span class="n">q_xDone</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
                <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">;</span>
            <span class="n">END_IF</span>
        <span class="n">END_IF</span>




    <span class="mi">100</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span> <span class="n">done</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">IF</span>  <span class="n">i_xExecute</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="n">THEN</span>
            <span class="n">q_xDone</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">END_IF</span>
        <span class="n">IF</span> <span class="n">NOT</span> <span class="n">i_CmdFlag</span> <span class="n">THEN</span>
            <span class="n">sTxRxString</span><span class="p">[</span><span class="n">iStringTxRx</span><span class="p">]</span><span class="o">:=</span><span class="n">CONCAT</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="n">q_sLastSentString</span><span class="p">[</span><span class="n">iStringTx</span><span class="p">],</span> <span class="s1">&#39; received &#39;</span><span class="p">),</span> <span class="n">q_sLastReceivedString</span><span class="p">[</span><span class="n">iStringRx</span><span class="p">]);</span>
        <span class="n">END_IF</span>
        <span class="n">IF</span> <span class="n">iStringTxRx</span> <span class="o">=</span> <span class="mi">40</span> <span class="n">THEN</span> <span class="n">iStringTxRx</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ELSE</span> <span class="n">iStringTxRx</span> <span class="o">:=</span> <span class="n">iStringTxRx</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">END_IF</span>

    <span class="mi">9000</span><span class="p">:</span>
        <span class="n">q_xError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;;</span>




<span class="n">END_CASE</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">A_Checksum</span><span class="p">:</span>
<span class="n">wCsSum</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">FOR</span> <span class="n">iIndexChkSum</span> <span class="o">:=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="p">(</span><span class="n">LEN</span><span class="p">(</span><span class="n">sSendString</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">DO</span>
    <span class="n">wCsSum</span><span class="o">:=</span> <span class="n">wCsSum</span> <span class="o">+</span> <span class="n">BYTE_TO_WORD</span><span class="p">(</span><span class="n">sSendString</span><span class="p">[</span><span class="n">iIndexChkSum</span><span class="p">]);</span>
<span class="n">END_FOR</span>
<span class="n">wCsSum</span>      <span class="o">:=</span> <span class="n">wCsSum</span> <span class="n">MOD</span> <span class="mi">256</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">modulo</span> <span class="mi">256</span> <span class="o">*</span><span class="p">)</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
</section>
<section id="fb-vicidriver">
<h2>FB_ViciDriver<a class="headerlink" href="#fb-vicidriver" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_ViciDriver</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_xExecute</span>                              <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>                                 <span class="p">(</span><span class="o">*</span> <span class="n">rising</span> <span class="n">edge</span> <span class="n">execute</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">i_tTimeOut</span>                              <span class="p">:</span> <span class="n">TIME</span> <span class="o">:=</span> <span class="n">t</span><span class="c1">#10s;                (* Maximum wait time for reply *)</span>
    <span class="n">i_stControl</span>                             <span class="p">:</span> <span class="n">ST_ViciControl</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">q_xDone</span>                                 <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_xError</span>                                <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_xWarning</span>                              <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>                                 <span class="p">(</span><span class="o">*</span> <span class="nb">set</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">event</span> <span class="n">of</span> <span class="n">an</span> <span class="n">unexpected</span> <span class="n">reply</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">q_xTimeout</span>                              <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_sResult</span>                               <span class="p">:</span> <span class="n">STRING</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
    <span class="n">q_sLastSentString</span>               <span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..40</span><span class="p">]</span> <span class="n">OF</span> <span class="n">STRING</span><span class="p">;</span>                               <span class="p">(</span><span class="o">*</span> <span class="n">Last</span> <span class="n">String</span> <span class="n">Sent</span> <span class="n">to</span> <span class="n">Serial</span> <span class="n">Device</span> <span class="o">-</span> <span class="k">for</span> <span class="n">debugging</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">q_sLastReceivedString</span>   <span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..40</span><span class="p">]</span> <span class="n">OF</span> <span class="n">STRING</span><span class="p">;</span>                               <span class="p">(</span><span class="o">*</span> <span class="n">Last</span> <span class="n">String</span> <span class="n">Received</span> <span class="kn">from</span><span class="w"> </span><span class="nn">Serial</span> <span class="n">Device</span> <span class="o">-</span> <span class="k">for</span> <span class="n">debugging</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">q_stStatus</span>                              <span class="p">:</span> <span class="n">ST_ViciStatus</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">iq_stSerialRXBuffer</span>     <span class="p">:</span> <span class="n">ComBuffer</span><span class="p">;</span>
    <span class="n">iq_stSerialTXBuffer</span>     <span class="p">:</span> <span class="n">ComBuffer</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">iReqPosReverse</span>          <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">rtExecute</span>                               <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">iStep</span>                                   <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">sSendData</span>                               <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">fbViciTransaction</span>               <span class="p">:</span> <span class="n">FB_ViciTransaction</span><span class="p">;</span>
    <span class="p">(</span><span class="o">*</span><span class="n">fbFormatString</span>                        <span class="p">:</span> <span class="n">FB_FormatString</span><span class="p">;</span><span class="o">*</span><span class="p">)</span>
    <span class="p">(</span><span class="o">*</span><span class="n">fbSplit</span>                                       <span class="p">:</span> <span class="n">FB_Split255</span><span class="p">;</span><span class="o">*</span><span class="p">)</span>
    <span class="n">asReplyFields</span>                   <span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..20</span><span class="p">]</span> <span class="n">OF</span> <span class="n">T_MaxString</span><span class="p">;</span>
    <span class="n">wChecksum</span><span class="p">:</span> <span class="n">WORD</span><span class="p">;</span>
    <span class="n">rtStartIntegration</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">rtEndReset</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">sWorking</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">strResponseExpected</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="n">performs</span> <span class="n">serial</span> <span class="n">transactions</span> <span class="k">with</span> <span class="n">a</span> <span class="n">Vici</span> <span class="o">*</span><span class="p">)</span>

<span class="p">(</span><span class="o">*</span> <span class="n">rising</span> <span class="n">edge</span> <span class="n">trigger</span> <span class="o">*</span><span class="p">)</span>
<span class="n">rtExecute</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="n">i_xExecute</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">rtExecute</span><span class="o">.</span><span class="n">Q</span>  <span class="n">THEN</span>
    <span class="n">q_xDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">q_xError</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">q_xWarning</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">q_xTimeout</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">q_sResult</span><span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="n">FBViciTransaction</span><span class="p">(</span> <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span> <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span> <span class="p">);</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">CASE</span> <span class="n">iStep</span> <span class="n">OF</span>
    <span class="mi">0</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span> <span class="n">idle</span> <span class="o">*</span><span class="p">)</span>
        <span class="p">;</span>

    <span class="mi">10</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span> <span class="n">Get</span> <span class="n">Position</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">FBViciTransaction</span><span class="p">(</span>
            <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
            <span class="n">i_iAddress</span><span class="o">:=</span><span class="n">i_stControl</span><span class="o">.</span><span class="n">iAddress</span><span class="p">,</span>
            <span class="n">i_sSendData</span><span class="o">:=</span> <span class="s1">&#39;CP&#39;</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">declared</span> <span class="n">postion</span> <span class="n">readback</span> <span class="n">Vici</span> <span class="n">command</span><span class="o">*</span><span class="p">)</span>
            <span class="n">i_tTimeOut</span><span class="o">:=</span> <span class="n">i_tTimeOut</span><span class="p">,</span>
            <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span>
            <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span><span class="p">,</span>
            <span class="n">i_CmdFlag</span> <span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>
        <span class="n">IF</span> <span class="n">FBViciTransaction</span><span class="o">.</span><span class="n">q_xError</span> <span class="n">THEN</span>
            <span class="n">q_sResult</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;in Step 10 serial transaction failed with message: &#39;</span><span class="p">,</span> <span class="n">FBViciTransaction</span><span class="o">.</span><span class="n">q_sResult</span><span class="p">);</span>
            <span class="n">q_stStatus</span><span class="o">.</span><span class="n">xPosValid</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">used</span> <span class="n">to</span> <span class="n">signal</span> <span class="n">an</span> <span class="n">invalid</span> <span class="n">readback</span> <span class="ow">or</span> <span class="n">control</span> <span class="n">exchange</span> <span class="o">*</span><span class="p">)</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
        <span class="n">ELSIF</span> <span class="n">FBViciTransaction</span><span class="o">.</span><span class="n">q_xDone</span> <span class="n">THEN</span>
            <span class="n">q_stStatus</span><span class="o">.</span><span class="n">sViciReply</span> <span class="o">:=</span> <span class="n">FBViciTransaction</span><span class="o">.</span><span class="n">q_sResponseData</span><span class="p">;</span>
            <span class="p">(</span><span class="o">*</span> <span class="n">grab</span> <span class="n">the</span> <span class="n">left</span> <span class="n">two</span> <span class="n">characters</span><span class="p">,</span> <span class="n">they</span> <span class="n">should</span> <span class="n">equal</span> <span class="n">CP</span> <span class="o">*</span><span class="p">)</span>
            <span class="n">strResponseExpected</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">INT_TO_STRING</span><span class="p">(</span> <span class="n">i_stControl</span><span class="o">.</span><span class="n">iAddress</span><span class="p">),</span> <span class="s1">&#39;CP&#39;</span><span class="p">);</span>
            <span class="n">IF</span> <span class="n">LEFT</span><span class="p">(</span><span class="n">q_stStatus</span><span class="o">.</span><span class="n">sViciReply</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&gt;</span> <span class="n">strResponseExpected</span> <span class="p">(</span><span class="o">*</span><span class="s1">&#39;1CP&#39;</span><span class="o">*</span><span class="p">)</span> <span class="n">THEN</span>
                <span class="p">(</span><span class="o">*</span><span class="n">use</span> <span class="n">q</span><span class="o">-</span><span class="n">s</span> <span class="n">Result</span> <span class="n">to</span> <span class="n">specify</span> <span class="n">error</span> <span class="nb">type</span><span class="o">*</span><span class="p">)</span>
                <span class="n">q_sResult</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;in step 10 unexpected response recieved: &#39;</span><span class="p">,</span> <span class="n">LEFT</span><span class="p">(</span><span class="n">q_stStatus</span><span class="o">.</span><span class="n">sViciReply</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39; instead of: &#39;</span><span class="p">,</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">INT_TO_STRING</span><span class="p">(</span> <span class="n">i_stControl</span><span class="o">.</span><span class="n">iAddress</span><span class="p">),</span> <span class="s1">&#39;CP&#39;</span><span class="p">)));</span>
                    <span class="n">q_xWarning</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
                <span class="p">(</span><span class="o">*</span> <span class="n">If</span> <span class="n">they</span> <span class="n">don</span><span class="s1">&#39;t equal CP, then error *)</span>
                <span class="n">q_stStatus</span><span class="o">.</span><span class="n">xPosValid</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">used</span> <span class="n">to</span> <span class="n">signal</span> <span class="n">an</span> <span class="n">invalid</span> <span class="n">readback</span> <span class="ow">or</span> <span class="n">control</span> <span class="n">exchange</span> <span class="o">*</span><span class="p">)</span>
                <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
            <span class="p">(</span><span class="o">*</span> <span class="k">else</span> <span class="n">then</span> <span class="n">grab</span> <span class="n">the</span> <span class="n">right</span> <span class="n">two</span> <span class="n">characters</span> <span class="ow">and</span> <span class="n">convert</span> <span class="n">to</span> <span class="n">INT</span> <span class="o">*</span><span class="p">)</span>
            <span class="n">ELSE</span>
            <span class="n">sWorking</span> <span class="o">:=</span> <span class="n">RIGHT</span><span class="p">(</span><span class="n">q_stStatus</span><span class="o">.</span><span class="n">sViciReply</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
            <span class="n">q_stStatus</span><span class="o">.</span><span class="n">iCurrPos</span> <span class="o">:=</span> <span class="mi">13</span> <span class="o">-</span> <span class="n">STRING_TO_INT</span><span class="p">(</span><span class="n">sWorking</span><span class="p">);</span> <span class="p">(</span><span class="o">*</span> <span class="k">pass</span> <span class="n">that</span> <span class="n">INT</span> <span class="n">to</span> <span class="n">the</span> <span class="n">q_stStatus</span><span class="o">.</span><span class="n">iCurrPos</span><span class="p">,</span> <span class="n">mirroring</span> <span class="n">positions</span> <span class="o">*</span><span class="p">)</span>
            <span class="n">q_stStatus</span><span class="o">.</span><span class="n">xPosValid</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">FBViciTransaction</span><span class="p">(</span> <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span> <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span><span class="p">,</span> <span class="n">i_CmdFlag</span> <span class="o">:=</span><span class="n">FALSE</span><span class="p">);</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">5000</span><span class="p">;</span>
            <span class="n">END_IF</span>
        <span class="n">END_IF</span>


    <span class="mi">5000</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span> <span class="n">Set</span> <span class="n">position</span><span class="o">*</span><span class="p">)</span>
        <span class="p">(</span><span class="o">*</span> <span class="n">Limit</span> <span class="n">the</span> <span class="n">requested</span> <span class="n">position</span> <span class="n">to</span> <span class="n">the</span> <span class="n">valid</span> <span class="mi">12</span> <span class="n">possible</span> <span class="n">positions</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">IF</span> <span class="n">i_stControl</span><span class="o">.</span><span class="n">iReqPos</span> <span class="o">&gt;</span> <span class="mi">12</span> <span class="n">OR</span> <span class="n">i_stControl</span><span class="o">.</span><span class="n">iReqPos</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="n">THEN</span>
            <span class="n">q_sResult</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;in step 5000 port range exceeded: &#39;</span><span class="p">,</span><span class="n">FBViciTransaction</span><span class="o">.</span><span class="n">q_sResponseData</span><span class="p">);</span>
            <span class="n">i_stControl</span><span class="o">.</span><span class="n">iReqPos</span> <span class="o">:=</span> <span class="n">LIMIT</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">i_stControl</span><span class="o">.</span><span class="n">iReqPos</span><span class="p">,</span><span class="mi">12</span><span class="p">);</span>
        <span class="n">END_IF</span>
        <span class="p">(</span><span class="o">*</span> <span class="n">Mirror</span> <span class="n">the</span> <span class="s2">&quot;clock&quot;</span> <span class="n">value</span> <span class="n">across</span> <span class="n">the</span> <span class="n">vertical</span> <span class="n">axis</span> <span class="n">of</span> <span class="n">symmetry</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">iReqPosReverse</span> <span class="o">:=</span> <span class="mi">13</span> <span class="o">-</span> <span class="n">i_stControl</span><span class="o">.</span><span class="n">iReqPos</span><span class="p">;</span>
        <span class="n">IF</span> <span class="n">q_stStatus</span><span class="o">.</span><span class="n">iReqPos</span> <span class="o">&lt;&gt;</span> <span class="n">i_stControl</span><span class="o">.</span><span class="n">iReqPos</span> <span class="n">THEN</span>
            <span class="n">IF</span> <span class="n">q_stStatus</span><span class="o">.</span><span class="n">iCurrPos</span> <span class="o">&gt;</span> <span class="n">i_stControl</span><span class="o">.</span><span class="n">iReqPos</span> <span class="n">THEN</span>
                <span class="n">IF</span> <span class="n">ABS</span><span class="p">(</span><span class="n">q_stStatus</span><span class="o">.</span><span class="n">iCurrPos</span> <span class="o">-</span> <span class="n">i_stControl</span><span class="o">.</span><span class="n">iReqPos</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="n">THEN</span>
                    <span class="n">sSendData</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;CW&#39;</span><span class="p">,</span> <span class="n">INT_TO_STRING</span><span class="p">(</span><span class="n">iReqPosReverse</span><span class="p">));</span>
                <span class="n">ELSE</span>
                    <span class="n">sSendData</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;CC&#39;</span><span class="p">,</span> <span class="n">INT_TO_STRING</span><span class="p">(</span><span class="n">iReqPosReverse</span><span class="p">));</span>
                <span class="n">END_IF</span>
            <span class="n">END_IF</span>
            <span class="n">IF</span> <span class="n">q_stStatus</span><span class="o">.</span><span class="n">iCurrPos</span> <span class="o">&lt;</span> <span class="n">i_stControl</span><span class="o">.</span><span class="n">iReqPos</span> <span class="n">THEN</span>
                <span class="n">IF</span> <span class="n">ABS</span><span class="p">(</span><span class="n">q_stStatus</span><span class="o">.</span><span class="n">iCurrPos</span> <span class="o">-</span> <span class="n">i_stControl</span><span class="o">.</span><span class="n">iReqPos</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="n">THEN</span>
                    <span class="n">sSendData</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;CC&#39;</span><span class="p">,</span> <span class="n">INT_TO_STRING</span><span class="p">(</span><span class="n">iReqPosReverse</span><span class="p">));</span>
                <span class="n">ELSE</span>
                    <span class="n">sSendData</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;CW&#39;</span><span class="p">,</span> <span class="n">INT_TO_STRING</span><span class="p">(</span><span class="n">iReqPosReverse</span><span class="p">));</span>
                <span class="n">END_IF</span>
            <span class="n">END_IF</span>
            <span class="n">FBViciTransaction</span><span class="p">(</span>
                <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
                <span class="n">i_sSendData</span><span class="o">:=</span> <span class="n">sSendData</span><span class="p">,</span>
                <span class="n">i_tTimeOut</span><span class="o">:=</span> <span class="n">i_tTimeOut</span><span class="p">,</span>
                <span class="n">i_iAddress</span><span class="o">:=</span><span class="n">i_stControl</span><span class="o">.</span><span class="n">iAddress</span><span class="p">,</span>
                <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span>
                <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span><span class="p">,</span>
                <span class="n">i_CmdFlag</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>
            <span class="n">IF</span> <span class="n">FBViciTransaction</span><span class="o">.</span><span class="n">q_xError</span> <span class="n">THEN</span>
                <span class="n">q_sResult</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;in Step 5000 serial transaction failed with message: &#39;</span><span class="p">,</span> <span class="n">FBViciTransaction</span><span class="o">.</span><span class="n">q_sResult</span><span class="p">);</span>
                <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
            <span class="n">ELSIF</span> <span class="n">FBViciTransaction</span><span class="o">.</span><span class="n">q_xDone</span> <span class="n">THEN</span>
                <span class="n">FBViciTransaction</span><span class="p">(</span>
                     <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span>
                    <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">,</span>
                    <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span><span class="p">,</span>
                    <span class="n">i_CmdFlag</span><span class="o">:=</span><span class="n">FALSE</span> <span class="p">);</span>  <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="o">*</span><span class="p">)</span>
                <span class="n">q_stStatus</span><span class="o">.</span><span class="n">iReqPos</span> <span class="o">:=</span> <span class="n">i_stControl</span><span class="o">.</span><span class="n">iReqPos</span><span class="p">;</span>
                <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">8000</span><span class="p">;</span>
            <span class="n">END_IF</span>
        <span class="n">ELSE</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">8000</span><span class="p">;</span>
        <span class="n">END_IF</span>


    <span class="mi">8000</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span> <span class="n">done</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">q_xDone</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">IF</span> <span class="n">q_sResult</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="n">THEN</span>
            <span class="n">q_sResult</span> <span class="o">:=</span> <span class="s1">&#39;Success&#39;</span><span class="p">;</span>
        <span class="n">END_IF</span>
        <span class="n">IF</span>  <span class="n">i_xExecute</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="n">THEN</span>
            <span class="n">q_xDone</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">END_IF</span>

    <span class="mi">9000</span><span class="p">:</span>
        <span class="n">_A_ClearStatus</span><span class="p">();</span>
        <span class="n">q_xTimeout</span> <span class="o">:=</span> <span class="n">FBViciTransaction</span><span class="o">.</span><span class="n">q_xTimeout</span><span class="p">;</span>
        <span class="n">q_xError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>


<span class="n">END_CASE</span>

<span class="n">q_sLastSentString</span> <span class="o">:=</span> <span class="n">FBViciTransaction</span><span class="o">.</span><span class="n">q_sLastSentString</span><span class="p">;</span>
<span class="n">q_sLastReceivedString</span> <span class="o">:=</span> <span class="n">FBViciTransaction</span><span class="o">.</span><span class="n">q_sLastReceivedString</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">_A_ClearStatus</span><span class="p">:</span>
<span class="n">q_stStatus</span><span class="o">.</span><span class="n">sViciReply</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-vicitransaction">FB_ViciTransaction</a></p></li>
<li><p><a class="reference internal" href="#st-vicicontrol">ST_ViciControl</a></p></li>
<li><p><a class="reference internal" href="#st-vicistatus">ST_ViciStatus</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-vicitransaction">
<h2>FB_ViciTransaction<a class="headerlink" href="#fb-vicitransaction" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_ViciTransaction</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_xExecute</span>                              <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>                         <span class="p">(</span><span class="o">*</span> <span class="n">Rising</span> <span class="n">edge</span> <span class="n">execute</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">i_sSendData</span>                             <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>                       <span class="p">(</span><span class="o">*</span> <span class="n">Send</span> <span class="n">Data</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">i_iAddress</span>                              <span class="p">:</span><span class="n">INT</span><span class="p">;</span>
    <span class="n">i_tTimeOut</span>                              <span class="p">:</span> <span class="n">TIME</span> <span class="o">:=</span> <span class="n">t</span><span class="c1">#10s;        (* Maximum wait time for reply *)</span>
    <span class="n">i_CmdFlag</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">q_xDone</span>                                 <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_sResponseData</span>                 <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">q_xError</span>                                <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_xTimeout</span>                              <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">q_sResult</span>                               <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">q_sLastSentString</span>               <span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..40</span><span class="p">]</span> <span class="n">OF</span> <span class="n">STRING</span><span class="p">;</span>                       <span class="p">(</span><span class="o">*</span> <span class="n">Last</span> <span class="n">String</span> <span class="n">Sent</span> <span class="n">to</span> <span class="n">Serial</span> <span class="n">Device</span> <span class="o">-</span> <span class="k">for</span> <span class="n">debugging</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">q_sLastReceivedString</span>   <span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..40</span><span class="p">]</span> <span class="n">OF</span> <span class="n">STRING</span><span class="p">;</span>                       <span class="p">(</span><span class="o">*</span> <span class="n">Last</span> <span class="n">String</span> <span class="n">Received</span> <span class="kn">from</span><span class="w"> </span><span class="nn">Serial</span> <span class="n">Device</span> <span class="o">-</span> <span class="k">for</span> <span class="n">debugging</span> <span class="o">*</span><span class="p">)</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">iq_stSerialRXBuffer</span>     <span class="p">:</span> <span class="n">ComBuffer</span><span class="p">;</span>
    <span class="n">iq_stSerialTXBuffer</span>     <span class="p">:</span> <span class="n">ComBuffer</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">rtExecute</span>                               <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">iStep</span>                                   <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">fbClearComBuffer</span>                <span class="p">:</span> <span class="n">ClearComBuffer</span><span class="p">;</span>
    <span class="n">fbSendString</span>                    <span class="p">:</span> <span class="n">SendString</span><span class="p">;</span>
    <span class="n">fbReceiveString</span>                 <span class="p">:</span> <span class="n">ReceiveString</span><span class="p">;</span>
    <span class="n">sReceivedString</span>                 <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">tonTimeout</span>                              <span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">sSendString</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">iStringTx</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">iStringRx</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="n">iStringTxRx</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">sTxRxString</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..40</span><span class="p">]</span> <span class="n">OF</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">This</span> <span class="n">function</span> <span class="n">block</span> <span class="n">performs</span> <span class="n">serial</span> <span class="n">transactions</span> <span class="k">with</span> <span class="n">a</span> <span class="n">VICI</span> <span class="o">*</span><span class="p">)</span>

<span class="p">(</span><span class="o">*</span> <span class="n">rising</span> <span class="n">edge</span> <span class="n">trigger</span> <span class="o">*</span><span class="p">)</span>
<span class="n">rtExecute</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="n">i_xExecute</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">rtExecute</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">q_xDone</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">q_sResponseData</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="n">q_xError</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">q_xTimeout</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">q_sResult</span><span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="n">q_sLastSentString</span><span class="p">[</span><span class="n">iStringTx</span><span class="p">]</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="n">q_sLastReceivedString</span><span class="p">[</span><span class="n">iStringRx</span><span class="p">]</span><span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">CASE</span> <span class="n">iStep</span> <span class="n">OF</span>
    <span class="mi">0</span><span class="p">:</span>
        <span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">idle</span> <span class="o">*</span><span class="p">)</span>

    <span class="mi">10</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span> <span class="n">clear</span> <span class="n">com</span> <span class="n">buffers</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">fbClearComBuffer</span><span class="p">(</span><span class="n">Buffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span><span class="p">);</span>
        <span class="n">fbClearComBuffer</span><span class="p">(</span><span class="n">Buffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span><span class="p">);</span>
        <span class="p">(</span><span class="o">*</span> <span class="n">Reset</span> <span class="n">receive</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">fbReceiveString</span><span class="p">(</span>
            <span class="n">Reset</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
            <span class="n">ReceivedString</span><span class="o">:=</span> <span class="n">sReceivedString</span><span class="p">,</span>
            <span class="n">RXbuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span> <span class="p">);</span>
        <span class="p">(</span><span class="o">*</span> <span class="n">send</span> <span class="n">the</span> <span class="n">string</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">sSendString</span> <span class="o">:=</span> <span class="n">INT_TO_STRING</span><span class="p">(</span><span class="n">i_iAddress</span><span class="p">);</span> <span class="p">(</span><span class="o">*</span><span class="n">building</span> <span class="n">address</span> <span class="n">header</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">sSendString</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">sSendString</span><span class="p">,</span> <span class="n">i_sSendData</span><span class="p">);</span> <span class="p">(</span><span class="o">*</span> <span class="n">adding</span> <span class="n">the</span> <span class="n">header</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">sSendString</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">sSendString</span><span class="p">,</span><span class="s1">&#39;$R$L&#39;</span><span class="p">);</span> <span class="p">(</span><span class="o">*</span> <span class="n">add</span> <span class="o">&lt;</span><span class="n">cr</span><span class="o">&gt;&lt;</span><span class="n">lf</span><span class="o">&gt;</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">adding</span> <span class="n">tail</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">fbSendString</span><span class="p">(</span> <span class="n">SendString</span><span class="o">:=</span> <span class="n">sSendString</span><span class="p">,</span> <span class="n">TXbuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span> <span class="p">);</span>
        <span class="n">q_sLastSentString</span><span class="p">[</span><span class="n">iStringTx</span><span class="p">]</span> <span class="o">:=</span> <span class="n">sSendString</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">iStringTx</span> <span class="o">=</span> <span class="mi">40</span> <span class="n">THEN</span> <span class="n">iStringTx</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ELSE</span> <span class="n">iStringTx</span> <span class="o">:=</span> <span class="n">iStringTx</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">END_IF</span>
        <span class="n">iStep</span> <span class="o">:=</span> <span class="n">iStep</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>

    <span class="mi">20</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span> <span class="n">Finish</span> <span class="n">sending</span> <span class="n">the</span> <span class="n">String</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">IF</span> <span class="n">fbSendString</span><span class="o">.</span><span class="n">Busy</span> <span class="n">THEN</span>
            <span class="n">fbSendString</span><span class="p">(</span> <span class="n">SendString</span><span class="o">:=</span> <span class="n">sSendString</span><span class="p">,</span> <span class="n">TXbuffer</span><span class="o">:=</span> <span class="n">iq_stSerialTXBuffer</span> <span class="p">);</span>
        <span class="n">ELSIF</span> <span class="n">fbSendString</span><span class="o">.</span><span class="n">Error</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
            <span class="n">q_sResult</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;In step 20 fbSendString resulted in error: &#39;</span><span class="p">,</span> <span class="n">INT_TO_STRING</span><span class="p">(</span><span class="n">fbSendString</span><span class="o">.</span><span class="n">Error</span><span class="p">));</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
        <span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">fbSendString</span><span class="o">.</span><span class="n">Busy</span> <span class="n">THEN</span>
            <span class="p">(</span><span class="o">*</span> <span class="k">if</span> <span class="n">we</span> <span class="n">are</span> <span class="n">sending</span> <span class="n">a</span> <span class="n">position</span> <span class="n">change</span> <span class="n">request</span> <span class="n">then</span> <span class="n">we</span> <span class="n">expect</span> <span class="n">no</span> <span class="n">reply</span> <span class="o">*</span><span class="p">)</span>
            <span class="n">IF</span> <span class="n">i_CmdFlag</span> <span class="n">THEN</span>
                <span class="n">q_sResult</span> <span class="o">:=</span> <span class="s1">&#39;String sent....&#39;</span><span class="p">;</span>
                <span class="n">q_xDone</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
                <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">;</span>
            <span class="n">ELSE</span>
                <span class="n">iStep</span><span class="o">:=</span><span class="n">iStep</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>
            <span class="n">END_IF</span>
        <span class="n">END_IF</span>
        <span class="n">tonTimeout</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">);</span>

    <span class="mi">30</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span> <span class="n">Get</span> <span class="n">reply</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">fbReceiveString</span><span class="p">(</span>
            <span class="n">Prefix</span><span class="o">:=</span> <span class="p">,</span>
            <span class="n">Suffix</span><span class="o">:=</span> <span class="s1">&#39;$R&#39;</span><span class="p">,</span>
            <span class="n">Timeout</span><span class="o">:=</span> <span class="n">i_tTimeOut</span><span class="p">,</span>
            <span class="n">Reset</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span>
            <span class="n">ReceivedString</span><span class="o">:=</span> <span class="n">sReceivedString</span><span class="p">,</span>
            <span class="n">RXbuffer</span><span class="o">:=</span> <span class="n">iq_stSerialRXBuffer</span> <span class="p">);</span>
        <span class="n">tonTimeout</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">PT</span><span class="o">:=</span> <span class="n">i_tTimeOut</span><span class="p">);</span>
        <span class="n">IF</span> <span class="n">fbReceiveString</span><span class="o">.</span><span class="n">Error</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
            <span class="n">q_sResult</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;In step 30 fbReceiveString resulted in error: &#39;</span><span class="p">,</span> <span class="n">INT_TO_STRING</span><span class="p">(</span><span class="n">fbReceiveString</span><span class="o">.</span><span class="n">Error</span><span class="p">));</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
        <span class="n">ELSIF</span> <span class="n">fbReceiveString</span><span class="o">.</span><span class="n">RxTimeout</span> <span class="n">OR</span> <span class="n">tonTimeout</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
            <span class="n">q_sResult</span> <span class="o">:=</span> <span class="s1">&#39;Serial device failed to reply within timeout period&#39;</span><span class="p">;</span>
            <span class="n">q_xTimeout</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
        <span class="n">ELSIF</span> <span class="n">fbReceiveString</span><span class="o">.</span><span class="n">StringReceived</span> <span class="n">THEN</span>
            <span class="n">q_sLastReceivedString</span><span class="p">[</span><span class="n">iStringRx</span><span class="p">]</span> <span class="o">:=</span> <span class="n">sReceivedString</span><span class="p">;</span>
            <span class="n">IF</span> <span class="n">iStringRx</span> <span class="o">=</span> <span class="mi">40</span> <span class="n">THEN</span> <span class="n">iStringRx</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ELSE</span> <span class="n">iStringRx</span> <span class="o">:=</span> <span class="n">iStringRx</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">END_IF</span>
            <span class="n">IF</span> <span class="n">LEN</span><span class="p">(</span><span class="n">sReceivedString</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="n">THEN</span>
                <span class="n">q_sResult</span> <span class="o">:=</span> <span class="s1">&#39;Reply too short.&#39;</span><span class="p">;</span>
                <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">9000</span><span class="p">;</span>
            <span class="n">ELSE</span>
                <span class="n">q_sResponseData</span> <span class="o">:=</span> <span class="n">LEFT</span><span class="p">(</span><span class="n">sReceivedString</span><span class="p">,</span><span class="n">LEN</span><span class="p">(</span><span class="n">sReceivedString</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
                <span class="n">q_sResult</span> <span class="o">:=</span> <span class="s1">&#39;Success.&#39;</span><span class="p">;</span>
                <span class="n">q_xDone</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
                <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">;</span>

            <span class="n">END_IF</span>
        <span class="n">END_IF</span>




    <span class="mi">100</span><span class="p">:</span> <span class="p">(</span><span class="o">*</span> <span class="n">done</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">IF</span>  <span class="n">i_xExecute</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="n">THEN</span>
            <span class="n">q_xDone</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">END_IF</span>
        <span class="n">IF</span> <span class="n">NOT</span> <span class="n">i_CmdFlag</span> <span class="n">THEN</span>
            <span class="n">sTxRxString</span><span class="p">[</span><span class="n">iStringTxRx</span><span class="p">]</span><span class="o">:=</span><span class="n">CONCAT</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="n">q_sLastSentString</span><span class="p">[</span><span class="n">iStringTx</span><span class="p">],</span> <span class="s1">&#39; received &#39;</span><span class="p">),</span> <span class="n">q_sLastReceivedString</span><span class="p">[</span><span class="n">iStringRx</span><span class="p">]);</span>
        <span class="n">END_IF</span>
        <span class="n">IF</span> <span class="n">iStringTxRx</span> <span class="o">=</span> <span class="mi">40</span> <span class="n">THEN</span> <span class="n">iStringTxRx</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ELSE</span> <span class="n">iStringTxRx</span> <span class="o">:=</span> <span class="n">iStringTxRx</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">END_IF</span>

    <span class="mi">9000</span><span class="p">:</span>
        <span class="n">q_xError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;;</span>




<span class="n">END_CASE</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fshdlcchecksum">
<h2>fSHDLCChecksum<a class="headerlink" href="#fshdlcchecksum" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION</span> <span class="n">fSHDLCChecksum</span> <span class="p">:</span> <span class="n">BYTE</span>
<span class="n">VAR_INPUT</span>
    <span class="n">i_bAdr</span>  <span class="p">:</span>       <span class="n">BYTE</span><span class="p">;</span>
    <span class="n">i_bCmd</span>  <span class="p">:</span>       <span class="n">BYTE</span><span class="p">;</span>
    <span class="n">i_bLen</span>  <span class="p">:</span>       <span class="n">BYTE</span><span class="p">;</span>
    <span class="n">i_pbaTxData</span>     <span class="p">:</span>       <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">BYTE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">iIndex</span>  <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Checksum</span> <span class="ow">is</span> <span class="n">calc</span> <span class="n">like</span> <span class="n">so</span>
<span class="n">Sum</span> <span class="nb">all</span> <span class="n">the</span> <span class="nb">bytes</span> <span class="n">within</span> <span class="n">the</span> <span class="n">frame</span>
<span class="n">Take</span> <span class="n">the</span> <span class="n">LSN</span> <span class="n">ie</span><span class="o">.</span> <span class="n">nibble</span> <span class="n">of</span> <span class="n">the</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">invert</span> <span class="n">it</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">fSHDLCChecksum</span> <span class="o">:=</span> <span class="n">i_bAdr</span> <span class="o">+</span> <span class="n">i_bCmd</span> <span class="o">+</span> <span class="n">i_bLen</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">i_bLen</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">THEN</span>
<span class="n">FOR</span> <span class="n">iIndex</span><span class="o">:=</span><span class="mi">0</span> <span class="n">TO</span> <span class="n">BYTE_TO_INT</span><span class="p">(</span><span class="n">i_bLen</span><span class="p">)</span><span class="n">DO</span>
    <span class="n">fSHDLCChecksum</span> <span class="o">:=</span> <span class="n">fSHDLCChecksum</span> <span class="o">+</span> <span class="n">i_pbaTxData</span><span class="o">^</span><span class="p">;</span>
    <span class="n">i_pbaTxData</span> <span class="o">:=</span> <span class="n">i_pbaTxData</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">END_FOR</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Inverting</span> <span class="n">LSN</span>
<span class="n">fSHDLCChecksum</span> <span class="o">:=</span> <span class="n">fSHDLCChecksum</span> <span class="n">XOR</span> <span class="mi">16</span><span class="c1">#FF;</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</section>
<section id="main">
<h2>MAIN<a class="headerlink" href="#main" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROGRAM</span> <span class="n">MAIN</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">M3SelectorA</span><span class="p">();</span>
<span class="n">M3SelectorB</span><span class="p">();</span>
<span class="n">M3SelectorC</span><span class="p">();</span>
<span class="n">M3SelectorD</span><span class="p">();</span>
<span class="n">PCMA</span><span class="p">();</span>
<span class="n">PCMB</span><span class="p">();</span>
<span class="n">PCMC</span><span class="p">();</span>
<span class="n">PCMD</span><span class="p">();</span>
<span class="n">GasMan</span><span class="p">();</span>
<span class="n">BronkhorstA</span><span class="p">();</span>
<span class="n">BronkhorstB</span><span class="p">();</span>
<span class="n">BronkhorstC</span><span class="p">();</span>
<span class="n">BronkhorstD</span><span class="p">();</span>
<span class="n">SolenoidPairA</span><span class="p">();</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Following</span> <span class="n">execution</span> <span class="n">of</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">programs</span><span class="p">,</span> <span class="nb">set</span> <span class="n">the</span> <span class="n">first</span> <span class="k">pass</span> <span class="n">false</span> <span class="o">*</span><span class="p">)</span>
<span class="n">g_xFirstPass</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">END_PROGRAM</span>
</pre></div>
</div>
</section>
<section id="mc-smoothmover">
<h2>MC_SmoothMover<a class="headerlink" href="#mc-smoothmover" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">MC_SmoothMover</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span>    <span class="p">:</span>       <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Velocity</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">ReqAbsPos</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span><span class="n">A</span>
    <span class="n">Enable</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">While</span> <span class="n">true</span> <span class="n">the</span> <span class="n">block</span> <span class="n">will</span> <span class="n">accept</span> <span class="n">new</span> <span class="n">positions</span> <span class="ow">and</span> <span class="n">attempt</span> <span class="n">to</span> <span class="n">move</span> <span class="n">to</span> <span class="n">them</span> <span class="k">if</span> <span class="n">they</span> <span class="n">are</span> <span class="n">different</span>
    <span class="n">Execute</span> <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Will</span> <span class="n">retry</span> <span class="n">a</span> <span class="n">move</span> <span class="k">if</span> <span class="n">the</span> <span class="n">target</span> <span class="n">position</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">same</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">Done</span>    <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Busy</span>    <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Error</span>   <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">mcMoveAbsolute</span> <span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..2</span><span class="p">]</span> <span class="n">OF</span> <span class="n">MC_MoveAbsolute</span><span class="p">;</span>
    <span class="n">iI</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">imcBlockIndex</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">ReqAbsPosPrevious</span>       <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">rtExecute</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Smooth</span> <span class="n">Mover</span>
<span class="mi">2017</span><span class="o">-</span><span class="mi">8</span><span class="o">-</span><span class="mi">30</span>
<span class="n">A</span><span class="o">.</span> <span class="n">Wallace</span>

<span class="n">Enable</span> <span class="n">means</span> <span class="n">the</span> <span class="n">block</span> <span class="n">will</span> <span class="n">always</span> <span class="n">aquire</span> <span class="n">new</span> <span class="n">positions</span> <span class="k">as</span> <span class="n">they</span> <span class="n">are</span> <span class="n">updated</span><span class="o">.</span> <span class="n">Execute</span>
<span class="n">can</span> <span class="n">be</span> <span class="n">used</span> <span class="n">to</span> <span class="n">retry</span> <span class="n">a</span> <span class="n">move</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>


<span class="n">rtExecute</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">Execute</span><span class="p">);</span>

<span class="n">IF</span> <span class="p">(</span> <span class="p">(</span><span class="n">ReqAbsPos</span> <span class="o">&lt;&gt;</span> <span class="n">ReqAbsPosPrevious</span> <span class="n">AND</span> <span class="n">Enable</span><span class="p">)</span> <span class="n">OR</span> <span class="n">rtExecute</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span> <span class="n">THEN</span>
            <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">imcBlockIndex</span><span class="p">]</span><span class="o">.</span><span class="n">Execute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">imcBlockIndex</span> <span class="o">:=</span> <span class="n">imcBlockIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">IF</span> <span class="n">imcBlockIndex</span> <span class="o">&gt;</span><span class="mi">2</span> <span class="n">THEN</span> <span class="n">imcBlockIndex</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">END_IF</span>
            <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">imcBlockIndex</span><span class="p">]</span><span class="o">.</span><span class="n">Position</span> <span class="o">:=</span> <span class="n">ReqAbsPos</span><span class="p">;</span>
            <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">imcBlockIndex</span><span class="p">]</span><span class="o">.</span><span class="n">Execute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">ReqAbsPosPrevious</span> <span class="o">:=</span> <span class="n">ReqAbsPos</span><span class="p">;</span>
        <span class="n">ELSIF</span> <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">imcBlockIndex</span><span class="p">]</span><span class="o">.</span><span class="n">Done</span> <span class="n">OR</span>
                <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">imcBlockIndex</span><span class="p">]</span><span class="o">.</span><span class="n">CommandAborted</span> <span class="n">OR</span>
                <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">imcBlockIndex</span><span class="p">]</span><span class="o">.</span><span class="n">Busy</span> <span class="n">OR</span>
                <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">imcBlockIndex</span><span class="p">]</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
            <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">imcBlockIndex</span><span class="p">]</span><span class="o">.</span><span class="n">Execute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">END_IF</span>

<span class="n">FOR</span> <span class="n">iI</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="mi">2</span> <span class="n">DO</span>
    <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">iI</span><span class="p">](</span><span class="n">Axis</span> <span class="o">:=</span> <span class="n">Axis</span><span class="p">,</span> <span class="n">Velocity</span><span class="o">:=</span><span class="n">Velocity</span><span class="p">,</span> <span class="n">BufferMode</span><span class="o">:=</span><span class="n">MC_Aborting</span><span class="p">);</span>
<span class="n">END_FOR</span>

<span class="n">Error</span> <span class="o">:=</span> <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Error</span> <span class="n">OR</span> <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
<span class="n">Done</span> <span class="n">S</span><span class="o">=</span> <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Done</span> <span class="n">OR</span> <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">Done</span><span class="p">;</span>
<span class="n">Busy</span> <span class="o">:=</span> <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Busy</span> <span class="n">OR</span> <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">Busy</span><span class="p">;</span>
<span class="n">Done</span> <span class="n">R</span><span class="o">=</span> <span class="n">Busy</span> <span class="n">OR</span> <span class="n">Error</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="p-ali">
<h2>p_ALI<a class="headerlink" href="#p-ali" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROGRAM</span> <span class="n">p_ALI</span>
<span class="n">VAR</span>
    <span class="n">fbALI_A</span> <span class="p">:</span>       <span class="n">FB_ALI</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">fbALI_A</span><span class="p">(</span><span class="n">iq_Injector</span><span class="o">:=</span><span class="n">stALI</span><span class="p">);</span>

<span class="n">END_PROGRAM</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-ali">FB_ALI</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="p-autosave">
<h2>p_Autosave<a class="headerlink" href="#p-autosave" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROGRAM</span> <span class="n">p_Autosave</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">If</span> <span class="n">first</span> <span class="k">pass</span><span class="p">,</span> <span class="n">copy</span> <span class="nb">all</span> <span class="n">persistent</span> <span class="n">variables</span> <span class="p">(</span><span class="n">which</span> <span class="n">should</span> <span class="n">be</span> <span class="n">intialized</span> <span class="n">to</span> <span class="n">old</span> <span class="n">values</span><span class="p">)</span> <span class="n">back</span> <span class="n">into</span> <span class="n">the</span> <span class="n">operational</span> <span class="n">variables</span> <span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">g_xFirstPass</span> <span class="n">THEN</span>

    <span class="n">stRegProp1</span> <span class="o">:=</span> <span class="n">gp_stRegProp1</span><span class="p">;</span>
    <span class="n">stRegProp2</span> <span class="o">:=</span> <span class="n">gp_stRegProp2</span><span class="p">;</span>
    <span class="n">stRegProp3</span> <span class="o">:=</span> <span class="n">gp_stRegProp3</span><span class="p">;</span>
    <span class="n">stRegProp4</span> <span class="o">:=</span> <span class="n">gp_stRegProp4</span><span class="p">;</span>

<span class="n">ELSE</span>
    <span class="n">gp_stRegProp1</span> <span class="o">:=</span> <span class="n">stRegProp1</span><span class="p">;</span>
    <span class="n">gp_stRegProp2</span> <span class="o">:=</span> <span class="n">stRegProp2</span><span class="p">;</span>
    <span class="n">gp_stRegProp3</span> <span class="o">:=</span> <span class="n">stRegProp3</span><span class="p">;</span>
    <span class="n">gp_stRegProp4</span> <span class="o">:=</span> <span class="n">stRegProp4</span><span class="p">;</span>

<span class="n">END_IF</span>

<span class="n">END_PROGRAM</span>
</pre></div>
</div>
</section>
<section id="p-autowash">
<h2>p_AutoWash<a class="headerlink" href="#p-autowash" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROGRAM</span> <span class="n">p_AutoWash</span>
<span class="n">VAR</span>



<span class="n">END_VAR</span>


<span class="n">END_PROGRAM</span>
</pre></div>
</div>
</section>
<section id="p-coolershaker">
<h2>p_CoolerShaker<a class="headerlink" href="#p-coolershaker" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROGRAM</span> <span class="n">p_CoolerShaker</span>
<span class="n">VAR</span>

<span class="n">afbTECDriver</span>        <span class="p">:</span>       <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..3</span><span class="p">]</span> <span class="n">OF</span> <span class="n">FB_TECDriver</span><span class="p">;</span>

    <span class="n">index</span><span class="p">:</span> <span class="n">INT</span> <span class="o">:=</span><span class="mi">1</span> <span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">stTECCtrl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sAddress</span> <span class="o">:=</span> <span class="s1">&#39;01&#39;</span><span class="p">;</span> <span class="o">//</span><span class="mi">62</span> <span class="ow">is</span> <span class="mi">98</span> <span class="ow">in</span> <span class="nb">hex</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">default</span> <span class="n">address</span>
<span class="n">stTECCtrl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">sAddress</span> <span class="o">:=</span> <span class="s1">&#39;02&#39;</span><span class="p">;</span>
<span class="n">stTECCtrl</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">sAddress</span> <span class="o">:=</span> <span class="s1">&#39;62&#39;</span><span class="p">;</span>

<span class="n">stTECCtrl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">diTempSetpoint</span> <span class="o">:=</span> <span class="mi">30</span><span class="p">;</span> <span class="o">//</span><span class="mi">98</span> <span class="ow">in</span> <span class="nb">hex</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">default</span> <span class="n">address</span>
<span class="n">stTECCtrl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">diTempSetpoint</span> <span class="o">:=</span> <span class="mi">30</span><span class="p">;</span>
<span class="n">stTECCtrl</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">diTempSetpoint</span> <span class="o">:=</span> <span class="mi">30</span><span class="p">;</span>

<span class="n">afbTECDriver</span><span class="p">[</span><span class="n">index</span><span class="p">](</span>
    <span class="n">i_xExecute</span><span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">i_tTimeOut</span><span class="o">:=</span> <span class="n">t</span><span class="c1">#1s,</span>
    <span class="n">i_stControl</span><span class="o">:=</span> <span class="n">stTECCtrl</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
    <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">SerialRXBuffer_CoolerShakerTEC</span><span class="p">,</span>
    <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span> <span class="n">SerialTXBuffer_CoolerShakerTEC</span><span class="p">,</span>
    <span class="n">q_stStatus</span><span class="o">=&gt;</span><span class="n">stTECStatus</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>

<span class="n">IF</span> <span class="n">afbTECDriver</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">q_xDone</span> <span class="n">OR</span>
    <span class="n">afbTECDriver</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">q_xError</span> <span class="n">OR</span>
    <span class="n">afbTECDriver</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">q_xTimeout</span> <span class="n">THEN</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">reset</span> <span class="n">function</span> <span class="k">for</span> <span class="nb">next</span> <span class="n">time</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">afbTECDriver</span><span class="p">[</span><span class="n">index</span><span class="p">](</span><span class="n">i_xExecute</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span> <span class="n">iq_stSerialRXBuffer</span><span class="o">:=</span> <span class="n">SerialRXBuffer_CoolerShakerTEC</span><span class="p">,</span> <span class="n">iq_stSerialTXBuffer</span><span class="o">:=</span>  <span class="n">SerialTXBuffer_CoolerShakerTEC</span><span class="p">);</span>

    <span class="n">index</span> <span class="o">:=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="n">THEN</span> <span class="n">index</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">END_IF</span>

<span class="n">END_IF</span>

<span class="n">END_PROGRAM</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-tecdriver">FB_TECDriver</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="p-estop">
<h2>p_ESTOP<a class="headerlink" href="#p-estop" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROGRAM</span> <span class="n">p_ESTOP</span>
<span class="n">VAR</span>
    <span class="n">rtEstop</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
<span class="n">Estop</span> <span class="n">checks</span> <span class="k">for</span> <span class="n">a</span> <span class="n">rising</span> <span class="n">edge</span> <span class="n">on</span> <span class="n">the</span> <span class="n">estop</span> <span class="k">global</span> <span class="n">variable</span> <span class="n">then</span> <span class="n">triggeres</span> <span class="n">the</span> <span class="n">following</span> <span class="n">actions</span>
<span class="mf">1.</span> <span class="n">Set</span> <span class="n">selector</span> <span class="n">to</span> <span class="n">position</span> <span class="mi">12</span><span class="p">,</span> <span class="n">the</span> <span class="n">default</span> <span class="n">resting</span> <span class="n">place</span>
<span class="mf">2.</span> <span class="n">Set</span> <span class="n">the</span> <span class="n">water</span> <span class="n">regulator</span> <span class="n">to</span> <span class="mi">0</span>
<span class="n">The</span> <span class="n">sheath</span> <span class="n">regulator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">zero</span> <span class="n">at</span> <span class="n">this</span> <span class="n">point</span> <span class="n">because</span> <span class="n">we</span> <span class="n">don</span><span class="s1">&#39;t want to ice the jet.</span>
<span class="o">*</span><span class="p">)</span>

<span class="n">rtEstop</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">g_xEstop</span><span class="p">);</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Check</span> <span class="k">for</span> <span class="n">E</span><span class="o">-</span><span class="n">Stop</span> <span class="o">*</span><span class="p">)</span>
<span class="n">IF</span> <span class="n">rtEstop</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">stSelector</span><span class="o">.</span><span class="n">iVici1ReqPos</span> <span class="o">:=</span> <span class="mi">12</span><span class="p">;</span>
    <span class="n">stSelector</span><span class="o">.</span><span class="n">iVici2ReqPos</span> <span class="o">:=</span> <span class="mi">12</span><span class="p">;</span>
    <span class="n">stSelector</span><span class="o">.</span><span class="n">iSyncReqPos</span>  <span class="o">:=</span> <span class="mi">12</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_PROGRAM</span>
</pre></div>
</div>
</section>
<section id="p-manifold">
<h2>p_Manifold<a class="headerlink" href="#p-manifold" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROGRAM</span> <span class="n">p_Manifold</span>
<span class="n">VAR</span>
    <span class="n">fbManiValve</span> <span class="p">:</span> <span class="n">FB_ManiValve</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Valve</span> <span class="mi">1</span> <span class="o">*</span><span class="p">)</span>
<span class="n">stGasMani</span><span class="o">.</span><span class="n">stManiVlv1</span><span class="o">.</span><span class="n">xILK</span> <span class="o">:=</span> <span class="n">stGasMani</span><span class="o">.</span><span class="n">xOnline</span><span class="p">;</span>
<span class="n">fbManiValve</span><span class="p">(</span><span class="n">iq_valve</span><span class="o">:=</span><span class="n">stGasMani</span><span class="o">.</span><span class="n">stManiVlv1</span><span class="p">);</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Valve</span> <span class="mi">2</span> <span class="o">*</span><span class="p">)</span>
<span class="n">stGasMani</span><span class="o">.</span><span class="n">stManiVlv2</span><span class="o">.</span><span class="n">xILK</span> <span class="o">:=</span> <span class="n">stGasMani</span><span class="o">.</span><span class="n">xOnline</span><span class="p">;</span>
<span class="n">fbManiValve</span><span class="p">(</span><span class="n">iq_valve</span><span class="o">:=</span><span class="n">stGasMani</span><span class="o">.</span><span class="n">stManiVlv2</span><span class="p">);</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Valve</span> <span class="mi">3</span> <span class="o">*</span><span class="p">)</span>
<span class="n">stGasMani</span><span class="o">.</span><span class="n">stManiVlv3</span><span class="o">.</span><span class="n">xILK</span> <span class="o">:=</span> <span class="n">stGasMani</span><span class="o">.</span><span class="n">xOnline</span><span class="p">;</span>
<span class="n">fbManiValve</span><span class="p">(</span><span class="n">iq_valve</span><span class="o">:=</span><span class="n">stGasMani</span><span class="o">.</span><span class="n">stManiVlv3</span><span class="p">);</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Valve</span> <span class="mi">4</span> <span class="o">*</span><span class="p">)</span>
<span class="n">stGasMani</span><span class="o">.</span><span class="n">stManiVlv4</span><span class="o">.</span><span class="n">xILK</span> <span class="o">:=</span> <span class="n">stGasMani</span><span class="o">.</span><span class="n">xOnline</span><span class="p">;</span>
<span class="n">fbManiValve</span><span class="p">(</span><span class="n">iq_valve</span><span class="o">:=</span><span class="n">stGasMani</span><span class="o">.</span><span class="n">stManiVlv4</span><span class="p">);</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Valve</span> <span class="mi">5</span> <span class="o">*</span><span class="p">)</span>
<span class="n">stGasMani</span><span class="o">.</span><span class="n">stManiVlv5</span><span class="o">.</span><span class="n">xILK</span> <span class="o">:=</span> <span class="n">stGasMani</span><span class="o">.</span><span class="n">xOnline</span><span class="p">;</span>
<span class="n">fbManiValve</span><span class="p">(</span><span class="n">iq_valve</span><span class="o">:=</span><span class="n">stGasMani</span><span class="o">.</span><span class="n">stManiVlv5</span><span class="p">);</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Valve</span> <span class="mi">6</span> <span class="o">*</span><span class="p">)</span>
<span class="n">stGasMani</span><span class="o">.</span><span class="n">stManiVlv6</span><span class="o">.</span><span class="n">xILK</span> <span class="o">:=</span> <span class="n">stGasMani</span><span class="o">.</span><span class="n">xOnline</span><span class="p">;</span>
<span class="n">fbManiValve</span><span class="p">(</span><span class="n">iq_valve</span><span class="o">:=</span><span class="n">stGasMani</span><span class="o">.</span><span class="n">stManiVlv6</span><span class="p">);</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Valve</span> <span class="mi">7</span> <span class="o">*</span><span class="p">)</span>
<span class="n">stGasMani</span><span class="o">.</span><span class="n">stManiVlv7</span><span class="o">.</span><span class="n">xILK</span> <span class="o">:=</span> <span class="n">stGasMani</span><span class="o">.</span><span class="n">xOnline</span><span class="p">;</span>
<span class="n">fbManiValve</span><span class="p">(</span><span class="n">iq_valve</span><span class="o">:=</span><span class="n">stGasMani</span><span class="o">.</span><span class="n">stManiVlv7</span><span class="p">);</span>

<span class="p">(</span><span class="o">*</span> <span class="n">Valve</span> <span class="mi">8</span> <span class="o">*</span><span class="p">)</span>
<span class="n">stGasMani</span><span class="o">.</span><span class="n">stManiVlv8</span><span class="o">.</span><span class="n">xILK</span> <span class="o">:=</span> <span class="n">stGasMani</span><span class="o">.</span><span class="n">xOnline</span><span class="p">;</span>
<span class="n">fbManiValve</span><span class="p">(</span><span class="n">iq_valve</span><span class="o">:=</span><span class="n">stGasMani</span><span class="o">.</span><span class="n">stManiVlv8</span><span class="p">);</span>

<span class="n">END_PROGRAM</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-manivalve">FB_ManiValve</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="p-regulators">
<h2>p_Regulators<a class="headerlink" href="#p-regulators" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROGRAM</span> <span class="n">p_Regulators</span>
<span class="n">VAR</span>

<span class="n">fbRegProp1</span>  <span class="p">:</span>       <span class="n">FB_ProportionairRegulator</span><span class="p">;</span>
<span class="n">fbRegProp2</span>  <span class="p">:</span>       <span class="n">FB_ProportionairRegulator</span><span class="p">;</span>
<span class="n">fbRegProp3</span>  <span class="p">:</span>       <span class="n">FB_ProportionairRegulator</span><span class="p">;</span>
<span class="n">fbRegProp4</span>  <span class="p">:</span>       <span class="n">FB_ProportionairRegulator</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Proportionair</span> <span class="n">regulators</span> <span class="o">*</span><span class="p">)</span>
<span class="n">fbRegProp1</span><span class="p">(</span><span class="n">iq_stRegProp</span><span class="o">:=</span><span class="n">stRegProp1</span><span class="p">);</span>
<span class="n">fbRegProp2</span><span class="p">(</span><span class="n">iq_stRegProp</span><span class="o">:=</span><span class="n">stRegProp2</span><span class="p">);</span>
<span class="n">fbRegProp3</span><span class="p">(</span><span class="n">iq_stRegProp</span><span class="o">:=</span><span class="n">stRegProp3</span><span class="p">);</span>
<span class="n">fbRegProp4</span><span class="p">(</span><span class="n">iq_stRegProp</span><span class="o">:=</span><span class="n">stRegProp4</span><span class="p">);</span>

<span class="n">END_PROGRAM</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-proportionairregulator">FB_ProportionairRegulator</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="p-shakers">
<h2>p_Shakers<a class="headerlink" href="#p-shakers" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROGRAM</span> <span class="n">p_Shakers</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>


<span class="n">END_PROGRAM</span>
</pre></div>
</div>
</section>
<section id="p-softio">
<h2>p_SoftIO<a class="headerlink" href="#p-softio" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROGRAM</span> <span class="n">p_SoftIO</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Shakers</span> <span class="o">*</span><span class="p">)</span>
<span class="n">stSelector</span><span class="o">.</span><span class="n">stShaker01</span><span class="o">.</span><span class="n">i_xSwitch</span> <span class="o">:=</span> <span class="n">iq_stM2SelectorA</span><span class="o">.</span><span class="n">i_EP2338_Ch5</span><span class="p">;</span>
<span class="n">stSelector</span><span class="o">.</span><span class="n">stShaker02</span><span class="o">.</span><span class="n">i_xSwitch</span> <span class="o">:=</span> <span class="n">iq_stM2SelectorA</span><span class="o">.</span><span class="n">i_EP2338_Ch6</span><span class="p">;</span>
<span class="n">stSelector</span><span class="o">.</span><span class="n">stShaker03</span><span class="o">.</span><span class="n">i_xSwitch</span> <span class="o">:=</span> <span class="n">iq_stM2SelectorA</span><span class="o">.</span><span class="n">i_EP2338_Ch7</span><span class="p">;</span>
<span class="n">stSelector</span><span class="o">.</span><span class="n">stShaker04</span><span class="o">.</span><span class="n">i_xSwitch</span> <span class="o">:=</span> <span class="n">iq_stM2SelectorA</span><span class="o">.</span><span class="n">i_EP2338_Ch8</span><span class="p">;</span>

<span class="n">iq_stM2SelectorA</span><span class="o">.</span><span class="n">q_EP2338_Ch1</span>       <span class="o">:=</span> <span class="n">stSelector</span><span class="o">.</span><span class="n">stShaker01</span><span class="o">.</span><span class="n">q_xPwrDO</span><span class="p">;</span>
<span class="n">iq_stM2SelectorA</span><span class="o">.</span><span class="n">q_EP2338_Ch2</span>       <span class="o">:=</span> <span class="n">stSelector</span><span class="o">.</span><span class="n">stShaker02</span><span class="o">.</span><span class="n">q_xPwrDO</span><span class="p">;</span>
<span class="n">iq_stM2SelectorA</span><span class="o">.</span><span class="n">q_EP2338_Ch3</span>       <span class="o">:=</span> <span class="n">stSelector</span><span class="o">.</span><span class="n">stShaker03</span><span class="o">.</span><span class="n">q_xPwrDO</span><span class="p">;</span>
<span class="n">iq_stM2SelectorA</span><span class="o">.</span><span class="n">q_EP2338_Ch4</span>       <span class="o">:=</span> <span class="n">stSelector</span><span class="o">.</span><span class="n">stShaker04</span><span class="o">.</span><span class="n">q_xPwrDO</span><span class="p">;</span>

<span class="n">stSelector2</span><span class="o">.</span><span class="n">stShaker01</span><span class="o">.</span><span class="n">i_xSwitch</span> <span class="o">:=</span> <span class="n">iq_stM2SelectorB</span><span class="o">.</span><span class="n">i_EP2338_Ch5</span><span class="p">;</span>
<span class="n">stSelector2</span><span class="o">.</span><span class="n">stShaker02</span><span class="o">.</span><span class="n">i_xSwitch</span> <span class="o">:=</span> <span class="n">iq_stM2SelectorB</span><span class="o">.</span><span class="n">i_EP2338_Ch6</span><span class="p">;</span>
<span class="n">stSelector2</span><span class="o">.</span><span class="n">stShaker03</span><span class="o">.</span><span class="n">i_xSwitch</span> <span class="o">:=</span> <span class="n">iq_stM2SelectorB</span><span class="o">.</span><span class="n">i_EP2338_Ch7</span><span class="p">;</span>
<span class="n">stSelector2</span><span class="o">.</span><span class="n">stShaker04</span><span class="o">.</span><span class="n">i_xSwitch</span> <span class="o">:=</span> <span class="n">iq_stM2SelectorB</span><span class="o">.</span><span class="n">i_EP2338_Ch8</span><span class="p">;</span>

<span class="n">iq_stM2SelectorB</span><span class="o">.</span><span class="n">q_EP2338_Ch1</span>       <span class="o">:=</span> <span class="n">stSelector2</span><span class="o">.</span><span class="n">stShaker01</span><span class="o">.</span><span class="n">q_xPwrDO</span><span class="p">;</span>
<span class="n">iq_stM2SelectorB</span><span class="o">.</span><span class="n">q_EP2338_Ch2</span>       <span class="o">:=</span> <span class="n">stSelector2</span><span class="o">.</span><span class="n">stShaker02</span><span class="o">.</span><span class="n">q_xPwrDO</span><span class="p">;</span>
<span class="n">iq_stM2SelectorB</span><span class="o">.</span><span class="n">q_EP2338_Ch3</span>       <span class="o">:=</span> <span class="n">stSelector2</span><span class="o">.</span><span class="n">stShaker03</span><span class="o">.</span><span class="n">q_xPwrDO</span><span class="p">;</span>
<span class="n">iq_stM2SelectorB</span><span class="o">.</span><span class="n">q_EP2338_Ch4</span>       <span class="o">:=</span> <span class="n">stSelector2</span><span class="o">.</span><span class="n">stShaker04</span><span class="o">.</span><span class="n">q_xPwrDO</span><span class="p">;</span>

<span class="n">stRegProp1</span><span class="o">.</span><span class="n">iPressureRaw</span> <span class="o">:=</span> <span class="n">iq_stPressCtrlA</span><span class="o">.</span><span class="n">i_EP4374_Ch1</span><span class="p">;</span>
<span class="n">stRegProp2</span><span class="o">.</span><span class="n">iPressureRaw</span> <span class="o">:=</span> <span class="n">iq_stPressCtrlA</span><span class="o">.</span><span class="n">i_EP4374_Ch2</span><span class="p">;</span>

<span class="n">iq_stPressCtrlA</span><span class="o">.</span><span class="n">q_EP4374_Ch3</span> <span class="o">:=</span> <span class="n">stRegProp1</span><span class="o">.</span><span class="n">iSetpointRaw</span><span class="p">;</span>
<span class="n">iq_stPressCtrlA</span><span class="o">.</span><span class="n">q_EP4374_Ch4</span> <span class="o">:=</span> <span class="n">stRegProp2</span><span class="o">.</span><span class="n">iSetpointRaw</span><span class="p">;</span>

<span class="n">stRegProp3</span><span class="o">.</span><span class="n">iPressureRaw</span> <span class="o">:=</span> <span class="n">iq_stPressCtrlB</span><span class="o">.</span><span class="n">i_EP4374_Ch1</span><span class="p">;</span>
<span class="n">stRegProp4</span><span class="o">.</span><span class="n">iPressureRaw</span> <span class="o">:=</span> <span class="n">iq_stPressCtrlB</span><span class="o">.</span><span class="n">i_EP4374_Ch2</span><span class="p">;</span>

<span class="n">iq_stPressCtrlB</span><span class="o">.</span><span class="n">q_EP4374_Ch3</span> <span class="o">:=</span> <span class="n">stRegProp3</span><span class="o">.</span><span class="n">iSetpointRaw</span><span class="p">;</span>
<span class="n">iq_stPressCtrlB</span><span class="o">.</span><span class="n">q_EP4374_Ch4</span> <span class="o">:=</span> <span class="n">stRegProp4</span><span class="o">.</span><span class="n">iSetpointRaw</span><span class="p">;</span>

<span class="n">stGasMani</span><span class="o">.</span><span class="n">xOnline</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">iq_stM3GasManifold</span><span class="o">.</span><span class="n">i_SyncUnitWC</span><span class="p">;</span>

<span class="n">iq_stM3GasManifold</span><span class="o">.</span><span class="n">q_EP2338_Ch1</span> <span class="o">:=</span> <span class="n">stGasMani</span><span class="o">.</span><span class="n">stManiVlv1</span><span class="o">.</span><span class="n">qxDO</span><span class="p">;</span>
<span class="n">iq_stM3GasManifold</span><span class="o">.</span><span class="n">q_EP2338_Ch2</span> <span class="o">:=</span> <span class="n">stGasMani</span><span class="o">.</span><span class="n">stManiVlv2</span><span class="o">.</span><span class="n">qxDO</span><span class="p">;</span>
<span class="n">iq_stM3GasManifold</span><span class="o">.</span><span class="n">q_EP2338_Ch3</span> <span class="o">:=</span> <span class="n">stGasMani</span><span class="o">.</span><span class="n">stManiVlv3</span><span class="o">.</span><span class="n">qxDO</span><span class="p">;</span>
<span class="n">iq_stM3GasManifold</span><span class="o">.</span><span class="n">q_EP2338_Ch4</span> <span class="o">:=</span> <span class="n">stGasMani</span><span class="o">.</span><span class="n">stManiVlv4</span><span class="o">.</span><span class="n">qxDO</span><span class="p">;</span>
<span class="n">iq_stM3GasManifold</span><span class="o">.</span><span class="n">q_EP2338_Ch5</span> <span class="o">:=</span> <span class="n">stGasMani</span><span class="o">.</span><span class="n">stManiVlv5</span><span class="o">.</span><span class="n">qxDO</span><span class="p">;</span>
<span class="n">iq_stM3GasManifold</span><span class="o">.</span><span class="n">q_EP2338_Ch6</span> <span class="o">:=</span> <span class="n">stGasMani</span><span class="o">.</span><span class="n">stManiVlv6</span><span class="o">.</span><span class="n">qxDO</span><span class="p">;</span>
<span class="n">iq_stM3GasManifold</span><span class="o">.</span><span class="n">q_EP2338_Ch7</span> <span class="o">:=</span> <span class="n">stGasMani</span><span class="o">.</span><span class="n">stManiVlv7</span><span class="o">.</span><span class="n">qxDO</span><span class="p">;</span>
<span class="n">iq_stM3GasManifold</span><span class="o">.</span><span class="n">q_EP2338_Ch8</span> <span class="o">:=</span> <span class="n">stGasMani</span><span class="o">.</span><span class="n">stManiVlv8</span><span class="o">.</span><span class="n">qxDO</span><span class="p">;</span>

<span class="n">stGasMani</span><span class="o">.</span><span class="n">stManiVlv1</span><span class="o">.</span><span class="n">ixOPN</span> <span class="o">:=</span> <span class="n">iq_stM3GasManifold</span><span class="o">.</span><span class="n">i_EP2338_Ch1</span><span class="p">;</span>
<span class="n">stGasMani</span><span class="o">.</span><span class="n">stManiVlv2</span><span class="o">.</span><span class="n">ixOPN</span> <span class="o">:=</span> <span class="n">iq_stM3GasManifold</span><span class="o">.</span><span class="n">i_EP2338_Ch2</span><span class="p">;</span>
<span class="n">stGasMani</span><span class="o">.</span><span class="n">stManiVlv3</span><span class="o">.</span><span class="n">ixOPN</span> <span class="o">:=</span> <span class="n">iq_stM3GasManifold</span><span class="o">.</span><span class="n">i_EP2338_Ch3</span><span class="p">;</span>
<span class="n">stGasMani</span><span class="o">.</span><span class="n">stManiVlv4</span><span class="o">.</span><span class="n">ixOPN</span> <span class="o">:=</span> <span class="n">iq_stM3GasManifold</span><span class="o">.</span><span class="n">i_EP2338_Ch4</span><span class="p">;</span>
<span class="n">stGasMani</span><span class="o">.</span><span class="n">stManiVlv5</span><span class="o">.</span><span class="n">ixOPN</span> <span class="o">:=</span> <span class="n">iq_stM3GasManifold</span><span class="o">.</span><span class="n">i_EP2338_Ch5</span><span class="p">;</span>
<span class="n">stGasMani</span><span class="o">.</span><span class="n">stManiVlv6</span><span class="o">.</span><span class="n">ixOPN</span> <span class="o">:=</span> <span class="n">iq_stM3GasManifold</span><span class="o">.</span><span class="n">i_EP2338_Ch6</span><span class="p">;</span>
<span class="n">stGasMani</span><span class="o">.</span><span class="n">stManiVlv7</span><span class="o">.</span><span class="n">ixOPN</span> <span class="o">:=</span> <span class="n">iq_stM3GasManifold</span><span class="o">.</span><span class="n">i_EP2338_Ch7</span><span class="p">;</span>
<span class="n">stGasMani</span><span class="o">.</span><span class="n">stManiVlv8</span><span class="o">.</span><span class="n">ixOPN</span> <span class="o">:=</span> <span class="n">iq_stM3GasManifold</span><span class="o">.</span><span class="n">i_EP2338_Ch8</span><span class="p">;</span>

<span class="n">END_PROGRAM</span>
</pre></div>
</div>
</section>
<section id="p-statuslights">
<h2>p_StatusLights<a class="headerlink" href="#p-statuslights" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROGRAM</span> <span class="n">p_StatusLights</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">gxRedLight</span> <span class="o">:=</span> <span class="n">xEnableRemoteControl</span><span class="p">;</span><span class="o">//</span><span class="n">Remote</span> <span class="n">control</span> <span class="ow">in</span> <span class="n">use</span>
<span class="n">gxGreenLight</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="p">(</span><span class="n">gxRedLight</span> <span class="n">OR</span> <span class="n">gxYellowLight</span><span class="p">);</span> <span class="p">(</span><span class="o">*</span> <span class="n">attach</span> <span class="n">system</span> <span class="n">error</span> <span class="ow">or</span> <span class="n">something</span> <span class="n">here</span> <span class="n">someday</span> <span class="o">*</span><span class="p">)</span>

<span class="n">END_PROGRAM</span>
</pre></div>
</div>
</section>
<section id="p-vacgaugesup">
<h2>p_VacGaugeSup<a class="headerlink" href="#p-vacgaugesup" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROGRAM</span> <span class="n">p_VacGaugeSup</span>

<span class="n">VAR</span>



<span class="n">END_VAR</span>


<span class="n">END_PROGRAM</span>
</pre></div>
</div>
</section>
<section id="serialtxrx">
<h2>SerialTxRx<a class="headerlink" href="#serialtxrx" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROGRAM</span> <span class="n">SerialTxRx</span>
<span class="n">VAR</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">fbSerialLineControl_M2SelAVici</span><span class="p">:</span> <span class="n">SerialLineControl</span><span class="p">;</span>
    <span class="n">fbSerialLineControl_M2SelBVici</span><span class="p">:</span> <span class="n">SerialLineControl</span><span class="p">;</span>
    <span class="n">fbSerialLineControl_M2SelAFM</span><span class="p">:</span> <span class="n">SerialLineControl</span><span class="p">;</span>
    <span class="n">fbSerialLineControl_M2SelBFM</span><span class="p">:</span> <span class="n">SerialLineControl</span><span class="p">;</span>

    <span class="n">fbSerialLineControl_M3SelAVici</span><span class="p">:</span> <span class="n">SerialLineControl</span><span class="p">;</span>
    <span class="n">fbSerialLineControl_M3SelAFM</span><span class="p">:</span> <span class="n">SerialLineControl</span><span class="p">;</span>
    <span class="n">fbSerialLineControl_M3SelBVici</span><span class="p">:</span> <span class="n">SerialLineControl</span><span class="p">;</span>
    <span class="n">fbSerialLineControl_M3SelBFM</span><span class="p">:</span> <span class="n">SerialLineControl</span><span class="p">;</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">END_VAR</span>
<span class="n">M3SelectorA</span><span class="o">.</span><span class="n">SerialComm</span><span class="p">();</span>
<span class="n">M3SelectorB</span><span class="o">.</span><span class="n">SerialComm</span><span class="p">();</span>
<span class="n">M3SelectorC</span><span class="o">.</span><span class="n">SerialComm</span><span class="p">();</span>
<span class="n">M3SelectorD</span><span class="o">.</span><span class="n">SerialComm</span><span class="p">();</span>

<span class="n">PCMA</span><span class="o">.</span><span class="n">SerialComm</span><span class="p">();</span>
<span class="n">PCMB</span><span class="o">.</span><span class="n">SerialComm</span><span class="p">();</span>
<span class="n">PCMC</span><span class="o">.</span><span class="n">SerialComm</span><span class="p">();</span>
<span class="n">PCMD</span><span class="o">.</span><span class="n">SerialComm</span><span class="p">();</span>

<span class="n">END_PROGRAM</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="SDS_SDSPLC_epics.html" class="btn btn-neutral float-left" title="Data Types" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, SLAC National Accelerator Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>